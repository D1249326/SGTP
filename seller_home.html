<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - è³£å®¶ä¸­å¿ƒ</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f5f5f5; }

    /* ===== Header ===== */
    header {
      background: #2c3e50; /* æ·±è—è‰²èƒŒæ™¯ */
      color: white;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header-logo {
      font-size: 20px;
      font-weight: bold;
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 24px; /* æ§åˆ¶å³å´å…ƒä»¶ä¹‹é–“çš„é–“è· */
    }

    /* âœ… [æ–°å¢] æ‰€æœ‰è¨‚å–®æŒ‰éˆ•æ¨£å¼ */
    .all-order {
      color: white;
      text-decoration: none;
      font-size: 16px; /* èˆ‡è³£å®¶åç¨± (.user-name) å¤§å°ä¸€è‡´ */
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: opacity 0.2s;
    }
    .all-order:hover { opacity: 0.8; }

    /* èŠå¤©æŒ‰éˆ• */
    .icon-chat {
      color: white;
      text-decoration: none;
      font-size: 24px;
      position: relative;
      cursor: pointer;
      display: flex; align-items: center;
    }
    .icon-chat:hover { opacity: 0.8; }

    /* ä¸‹æ‹‰é¸å–®å€å¡Š */
    .user-menu {
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      height: 60px;
    }
    .user-name {
      font-size: 16px;
      font-weight: bold;
      margin-right: 5px;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: white;
      min-width: 150px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 0 0 4px 4px;
      overflow: hidden;
      z-index: 1001;
    }
    .dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
    }
    .dropdown-content a:hover { background-color: #f5f5f5; color: #2c3e50; }
    .user-menu:hover .dropdown-content { display: block; }
    .user-avatar {
      width: 32px; height: 32px;
      background-color: #bdc3c7;
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      font-size: 14px; color: #2c3e50;
      margin-right: 8px;
    }

    /* ===== ä¸»å…§å®¹å®¹å™¨ ===== */
    .container {
      max-width: 1000px;
      margin: 30px auto;
      padding: 0 20px;
    }

    /* ===== å„€è¡¨æ¿å€å¡Š (Dashboard) ===== */
    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .page-title {
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }
    
    /* è©•åƒ¹æ¨™ç±¤ */
    .rating-badge {
      background: #fcf8e3;
      border: 1px solid #faebcc;
      color: #8a6d3b;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      display: flex; align-items: center; gap: 5px;
    }

    /* çµ±è¨ˆæ•¸æ“šå¡ç‰‡ */
    .stats-board {
      display: flex;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 30px;
    }
    .stat-item {
      flex: 1;
      text-align: center;
      padding: 20px;
      border-right: 1px solid #eee;
    }
    .stat-item:last-child { border-right: none; }
    
    .stat-label { font-size: 14px; color: #666; font-weight: bold; margin-bottom: 5px; }
    .stat-value { font-size: 24px; font-weight: bold; color: #333; }
    .stat-value.money { color: #c0392b; } /* é‡‘é¡ç”¨ç´…è‰² */


    /* ===== å•†å“ç®¡ç†å€å¡Š ===== */
    .btn-add {
      background: #2c3e50;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 15px;
    }
    .btn-add:hover { background: #34495e; }

    .section-subtitle {
      font-size: 16px; font-weight: bold; color: #555; margin-bottom: 10px;
    }

    /* è¡¨æ ¼æ¨£å¼ */
    .product-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .product-table th {
      background: #f8f9fa;
      color: #666;
      font-weight: bold;
      padding: 12px;
      text-align: left;
      font-size: 14px;
      border-bottom: 2px solid #ddd;
    }
    .product-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
      font-size: 14px;
      color: #333;
    }
    .p-img {
      width: 50px; height: 50px;
      object-fit: cover;
      border-radius: 4px;
      background: #eee;
      display: block;
    }
    .btn-edit {
      padding: 6px 12px;
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .btn-edit:hover { background: #34495e; }

    .loading-text { text-align: center; color: #777; padding: 20px; }
  </style>
</head>
<body>

<header>
  <a href="seller_home.html" class="header-logo">SGTP-è³£å®¶ä¸­å¿ƒ</a>

  <div class="header-right">
    <a href="seller_orders.html" class="all-order" title="æŸ¥çœ‹æ‰€æœ‰è¨‚å–®">æ‰€æœ‰è¨‚å–®</a>

    <a href="seller_chats.html" class="icon-chat" title="èŠå¤©å®¤">ğŸ’¬</a>

    <div class="user-menu">
      <div class="user-avatar">S</div>
      <span class="user-name" id="headerUserName">è³£å®¶</span>
      <span>â–¼</span>
      <div class="dropdown-content">
        <a href="seller_profile.html">æˆ‘çš„è³‡æ–™</a>
        <a href="#" id="btnLogout">ç™»å‡º</a>
      </div>
    </div>
  </div>
</header>

<div class="container">
  
  <div class="dashboard-header">
    <div class="page-title">æˆ‘çš„è³£å ´</div>
    <div class="rating-badge" id="ratingBadge" style="display:none;">
      â˜… <span id="ratingVal">-</span> <span id="ratingCountText" style="font-weight:normal; color:#8a6d3b;"></span>
    </div>
  </div>

  <div class="stats-board">
    <div class="stat-item">
      
      <div class="stat-value" id="countPending">0</div>
      <div style="font-size:12px; color:#888; margin-top:4px;">å·²æˆç«‹ (æœªå‡ºè²¨)</div>
    </div>
    <div class="stat-item">
      
      <div class="stat-value" id="countShipped">0</div>
      <div style="font-size:12px; color:#888; margin-top:4px;">å·²å‡ºè²¨</div>
    </div>
    <div class="stat-item">
      
      <div class="stat-value" id="countCompleted">0</div>
      <div style="font-size:12px; color:#888; margin-top:4px;">å·²å®Œæˆ</div>
    </div>
    <div class="stat-item">
      
      <div class="stat-value money" id="sumTotal">NT$ 0</div>
      <div style="font-size:12px; color:#888; margin-top:4px;">ç¸½é‡‘é¡ (æ‰€æœ‰è¨‚å–®)</div>
    </div>
  </div>

  <a href="seller_add_product.html" class="btn-add">ï¼‹ ä¸Šæ¶æ–°å•†å“</a>

  <div class="section-subtitle">æˆ‘å·²ä¸Šæ¶çš„å•†å“</div>

  <div id="productArea">
    <div class="loading-text">è¼‰å…¥ä¸­...</div>
  </div>

</div>

<script>
  const headerUserName = document.getElementById('headerUserName');
  const btnLogout = document.getElementById('btnLogout');
  
  // è©•åƒ¹å…ƒç´ 
  const ratingBadge = document.getElementById('ratingBadge');
  const ratingVal = document.getElementById('ratingVal');
  const ratingCountText = document.getElementById('ratingCountText');

  // çµ±è¨ˆå…ƒç´ 
  const elPending = document.getElementById('countPending');
  const elShipped = document.getElementById('countShipped');
  const elCompleted = document.getElementById('countCompleted');
  const elTotal = document.getElementById('sumTotal');

  const productArea = document.getElementById('productArea');
  const FALLBACK_IMG = 'https://via.placeholder.com/50x50?text=IMG';

  let currentSellerId = null;

  function getAuthHeader(){ const t = localStorage.getItem('token'); return t?{ 'Authorization':'Bearer '+t } : {}; }

  // åˆå§‹åŒ–
  (async function init(){
    try {
      // 1. å–å¾—ä½¿ç”¨è€…è³‡æ–™ (åŒ…å«è©•åƒ¹)
      const res = await fetch('/api/auth/me', { headers: getAuthHeader() });
      if(!res.ok){ alert('è«‹å…ˆç™»å…¥è³£å®¶å¸³è™Ÿ'); window.location.href='seller_login.html'; return; }
      
      const user = await res.json();
      if(user.role !== 'seller') { alert('æ¬Šé™ä¸è¶³'); window.location.href='index.html'; return; }
      
      currentSellerId = user.id;
      headerUserName.textContent = user.name || 'è³£å®¶';

      // é¡¯ç¤ºè©•åƒ¹
      if(user.avg_rating) {
        ratingVal.textContent = Number(user.avg_rating).toFixed(1);
        ratingCountText.textContent = `(${user.review_count} å‰‡è©•åƒ¹)`;
        ratingBadge.style.display = 'flex';
      }
      
      ratingBadge.style.cursor = 'pointer'; // å¢åŠ æ‰‹å‹æ¸¸æ¨™
      ratingBadge.onclick = () => {
          window.location.href = 'seller_review.html';
      };

      // 2. å¹³è¡Œè¼‰å…¥ã€Œå•†å“åˆ—è¡¨ã€èˆ‡ã€Œè¨‚å–®çµ±è¨ˆã€
      await Promise.all([loadProducts(), loadOrderStats()]);

    } catch(err) {
      console.error(err);
    }
  })();

  // ç™»å‡º
  btnLogout.addEventListener('click', (e)=>{
    e.preventDefault();
    localStorage.removeItem('token');
    window.location.href='seller_login.html';
  });

  // è¼‰å…¥å•†å“åˆ—è¡¨
  async function loadProducts() {
    try {
      const res = await fetch(`/api/products?seller_id=${currentSellerId}`, { headers: getAuthHeader() });
      const list = await res.json();
      
      if(!list || list.length === 0) {
        productArea.innerHTML = '<div class="loading-text">ç›®å‰æ²’æœ‰å•†å“</div>';
        return;
      }

      // å»ºç«‹è¡¨æ ¼ HTML
      let html = `
        <table class="product-table">
          <thead>
            <tr>
              <th style="width:60px;">åœ–ç‰‡</th>
              <th>å•†å“åç¨±</th>
              <th style="width:100px;">åˆ†é¡</th>
              <th style="width:100px;">åƒ¹æ ¼</th>
              <th style="width:80px;">åº«å­˜</th>
              <th style="width:160px;">å»ºç«‹æ™‚é–“</th>
              <th style="width:80px; text-align:center;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
      `;

      list.forEach(p => {
        // åœ–ç‰‡è™•ç†
        let imgUrl = FALLBACK_IMG;
        if(p.image) imgUrl = p.image;
        else if(p.images) {
           try {
             const arr = JSON.parse(p.images);
             if(arr.length) imgUrl = arr[0];
           } catch(e){}
        }

        const stock = (p.stock !== undefined) ? p.stock : (p.quantity || 0);
        const dateStr = p.created_at ? new Date(p.created_at).toLocaleString() : '-';

        html += `
          <tr>
            <td><img src="${imgUrl}" class="p-img"></td>
            <td>${p.title}</td>
            <td>${p.category || '-'}</td>
            <td>NT$ ${p.price}</td>
            <td>${stock}</td>
            <td style="color:#777; font-size:12px;">${dateStr}</td>
            <td style="text-align:center;">
              <button class="btn-edit" onclick="location.href='seller_edit_product.html?pid=${p.id}'">ç·¨è¼¯</button>
            </td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      productArea.innerHTML = html;

    } catch(e) {
      productArea.innerHTML = '<div class="loading-text">è¼‰å…¥å¤±æ•—</div>';
    }
  }

  // è¼‰å…¥è¨‚å–®çµ±è¨ˆ
  async function loadOrderStats() {
    try {
      // å‘¼å«è³£å®¶è¨‚å–® API (å–å¾—æ‰€æœ‰ç›¸é—œè¨‚å–®)
      const res = await fetch('/api/seller/orders/my', { headers: getAuthHeader() });
      if(!res.ok) return;
      const orders = await res.json();

      let pending = 0;
      let shipped = 0;
      let completed = 0;
      let totalAmount = 0;

      orders.forEach(o => {
        const st = (o.status || '').toLowerCase();
        
        // æ ¹æ“šç‹€æ…‹åˆ†é¡
        if(st === 'pending' || st === 'paid') pending++;
        else if(st === 'shipped') shipped++;
        else if(st === 'completed') completed++;

        // è¨ˆç®—ç¸½é‡‘é¡ (åªç®—è‡ªå·±çš„å•†å“)
        // å¾Œç«¯ API å·²ç¶“å¹«æˆ‘å€‘ç®—å¥½ o.totalAmount (è©²è³£å®¶çš„éƒ¨åˆ†)
        // ä½†ç‚ºäº†ä¿éšªèµ·è¦‹ï¼Œè‹¥è¨‚å–®æœªå–æ¶ˆæ‰ç®—é€²ç¸½é‡‘é¡
        if(st == 'completed') {
           totalAmount += (o.totalAmount || 0);
        }
      });

      // æ›´æ–° UI
      elPending.textContent = pending;
      elShipped.textContent = shipped;
      elCompleted.textContent = completed;
      elTotal.textContent = 'NT$ ' + totalAmount.toLocaleString();

    } catch(e) {
      console.error('çµ±è¨ˆè¼‰å…¥å¤±æ•—', e);
    }
  }
</script>

</body>
</html>