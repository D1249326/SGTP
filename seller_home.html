<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - è³£å®¶é¦–é </title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f7f7f7; }
    header {
      background:#1f354d; color:white; padding:18px 32px;
      font-size:22px; display:flex; justify-content:space-between; align-items:center;
    }
    .user-info { font-size:14px; }
    .btn {
      padding:6px 12px; border-radius:4px; border:none;
      cursor:pointer; font-size:14px; margin-left:8px;
    }
    .btn-light { background:#ffffff; color:#1f354d; }
    .btn-danger { background:#c0392b; color:white; }

    .container {
      max-width:1000px; margin:30px auto; background:white;
      padding:24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    h2 { margin-top:0; }
    .info { margin-top:10px; font-size:14px; color:#555; }

    .card-list { margin-top:20px; }
    .link-btn {
      display:inline-block; margin-right:12px; margin-bottom:12px;
      padding:10px 16px; background:#1f354d; color:white;
      border-radius:4px; text-decoration:none; font-size:14px;
    }
    .link-btn:hover { background:#28486a; }

    /* --- å•†å“åˆ—è¡¨æ¨£å¼ --- */
    .section-title {
      margin-top:24px;
      font-size:18px;
      font-weight:bold;
    }
    .prod-list {
      margin-top:12px;
    }
    .prod-list-header {
      display:flex;
      font-size:14px;
      font-weight:bold;
      border-bottom:1px solid #ddd;
      padding-bottom:6px;
    }
    .prod-row {
      display:flex;
      align-items:center;
      padding:8px 0;
      border-bottom:1px solid #f0f0f0;
      font-size:14px;
    }
    .prod-col-img   { width:80px; flex-shrink:0; }
    .prod-col-title { flex:2; padding-right:8px; }
    .prod-col-price { width:100px; text-align:right; }
    .prod-col-stock { width:80px; text-align:right; }
    .prod-col-time  { width:160px; font-size:12px; color:#777; text-align:right; }

    /* â­ æ“ä½œæ¬„ & å°æŒ‰éˆ• */
    .prod-col-actions { width:90px; text-align:center; }

    .btn-mini {
      padding:4px 8px;
      font-size:12px;
      border-radius:4px;
      border:none;
      background:#1f354d;
      color:white;
      cursor:pointer;
    }
    .btn-mini:hover { background:#28486a; }

    .prod-img {
      width:64px; height:64px; object-fit:cover;
      border-radius:4px; background:#eee;
    }

    .empty {
      margin-top:10px; color:#777; font-size:14px;
    }
    .small-note {
      margin-top:4px; font-size:12px; color:#999;
    }
  </style>
</head>
<body>
  <header>
    <div>SGTP äºŒæ‰‹å•†å“å¹³å° - è³£å®¶å¾Œå°</div>
    <div class="user-info">
      <span id="userName">è³£å®¶</span>
      <button class="btn btn-light" onclick="location.href='seller_orders.html'">æŸ¥çœ‹è¨‚å–®</button>
      <button class="btn btn-light" onclick="location.href='index.html'">å›èµ·å§‹é </button>
      <button id="btnLogout" class="btn btn-danger">ç™»å‡º</button>
    </div>
  </header>

  <div class="container">
    <h2>æ­¡è¿ä¾†åˆ°è³£å®¶å¾Œå°</h2>
    <p class="info">åœ¨é€™è£¡ä½ å¯ä»¥ä¸Šæ¶å•†å“ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°è‡ªå·±å·²ä¸Šæ¶çš„å•†å“ã€‚</p>

    <div class="card-list">
      <a href="seller_add_product.html" class="link-btn">â• ä¸Šæ¶æ–°å•†å“</a>
      <!-- æœªä¾†å¯ä»¥å†åŠ ï¼šè¨‚å–®ç®¡ç†ã€å•†å“ç®¡ç†é é¢ -->
    </div>

    <!-- â­ è³£å®¶å·²ä¸Šæ¶çš„å•†å“åˆ—è¡¨ -->
    <div class="my-products">
      <div class="section-title">æˆ‘å·²ä¸Šæ¶çš„å•†å“</div>
      <div id="prodEmpty" class="empty" style="display:none;">
        ç›®å‰é‚„æ²’æœ‰ä¸Šæ¶ä»»ä½•å•†å“ï¼Œé»ä¸Šæ–¹ã€Œâ• ä¸Šæ¶æ–°å•†å“ã€ä¾†æ–°å¢å§ï¼
      </div>

      <div id="prodList" class="prod-list" style="display:none;">
        <div class="prod-list-header">
          <div class="prod-col-img">åœ–ç‰‡</div>
          <div class="prod-col-title">å•†å“åç¨±</div>
          <div class="prod-col-price">åƒ¹æ ¼</div>
          <div class="prod-col-stock">åº«å­˜</div>
          <div class="prod-col-time">å»ºç«‹æ™‚é–“</div>
          <div class="prod-col-actions">æ“ä½œ</div>
        </div>
        <div id="prodRows"></div>
      </div>

      <div id="prodNote" class="small-note" style="display:none;">
        * åƒ…é¡¯ç¤ºæ­¤è³£å®¶å¸³è™Ÿæ‰€ä¸Šæ¶çš„å•†å“ï¼ˆä¾å»ºç«‹æ™‚é–“æ’åºï¼Œæ–°åˆ°èˆŠï¼‰ã€‚
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      doc, getDoc,
      collection, query, where, getDocs, orderBy   // â­ æœ‰å¼•å…¥ orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const userNameSpan = document.getElementById("userName");
    const btnLogout = document.getElementById("btnLogout");

    const prodEmptyEl = document.getElementById("prodEmpty");
    const prodListEl  = document.getElementById("prodList");
    const prodRowsEl  = document.getElementById("prodRows");
    const prodNoteEl  = document.getElementById("prodNote");

    const FALLBACK_IMG = "https://via.placeholder.com/80x80?text=No+Image";

    let currentSellerUid = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("è«‹å…ˆç™»å…¥è³£å®¶å¸³è™Ÿ");
        window.location.href = "seller_login.html";
        return;
      }
      try {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (!snap.exists()) {
          alert("æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™ï¼Œè«‹é‡æ–°ç™»å…¥");
          await signOut(auth);
          window.location.href = "seller_login.html";
          return;
        }
        const data = snap.data();
        if (data.role !== "seller") {
          alert("æ­¤å¸³è™Ÿä¸æ˜¯è³£å®¶è§’è‰²");
          await signOut(auth);
          window.location.href = "seller_login.html";
          return;
        }
        userNameSpan.textContent = data.name || data.email || "è³£å®¶";

        currentSellerUid = user.uid;
        // â­ ç¢ºèªæ˜¯è³£å®¶ä¹‹å¾Œè¼‰å…¥å•†å“
        loadMyProducts();
      } catch (err) {
        console.error(err);
        alert("è®€å–ä½¿ç”¨è€…è³‡æ–™å¤±æ•—ï¼š" + err.message);
        window.location.href = "seller_login.html";
      }
    });

    // ç™»å‡º
    btnLogout.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "seller_login.html";
      } catch (err) {
        console.error(err);
        alert("ç™»å‡ºå¤±æ•—ï¼š" + err.message);
      }
    });

    // â­ è¼‰å…¥æ­¤è³£å®¶ä¸Šæ¶çš„å•†å“
    async function loadMyProducts() {
      if (!currentSellerUid) return;

      prodRowsEl.innerHTML = "";
      prodEmptyEl.style.display = "none";
      prodListEl.style.display  = "none";
      prodNoteEl.style.display  = "none";

      try {
        // ğŸ‘‰ æœ‰æ’åºï¼šwhere + orderBy("createdAt","desc")
        const q = query(
          collection(db, "products"),
          where("sellerId", "==", currentSellerUid),
          orderBy("createdAt", "desc")
        );

        const snap = await getDocs(q);

        if (snap.empty) {
          prodEmptyEl.style.display = "block";
          return;
        }

        snap.forEach(docSnap => {
          const data = docSnap.data();
          const title = data.title || "æœªå‘½åå•†å“";
          const price = typeof data.price === "number" ? data.price : 0;
          const stock = typeof data.stock === "number" ? data.stock : 0;
          const image = data.image || FALLBACK_IMG;
          let createdText = "";

          if (data.createdAt && data.createdAt.toDate) {
            const d = data.createdAt.toDate();
            const yyyy = d.getFullYear();
            const mm   = String(d.getMonth() + 1).padStart(2, "0");
            const dd   = String(d.getDate()).padStart(2, "0");
            const hh   = String(d.getHours()).padStart(2, "0");
            const mi   = String(d.getMinutes()).padStart(2, "0");
            createdText = `${yyyy}/${mm}/${dd} ${hh}:${mi}`;
          }

          const row = document.createElement("div");
          row.className = "prod-row";

          // åœ–ç‰‡
          const colImg = document.createElement("div");
          colImg.className = "prod-col-img";
          const imgEl = document.createElement("img");
          imgEl.className = "prod-img";
          imgEl.src = image;
          imgEl.alt = title;
          imgEl.onerror = () => { imgEl.src = FALLBACK_IMG; };
          colImg.appendChild(imgEl);

          // åç¨±
          const colTitle = document.createElement("div");
          colTitle.className = "prod-col-title";
          colTitle.textContent = title;

          // åƒ¹æ ¼
          const colPrice = document.createElement("div");
          colPrice.className = "prod-col-price";
          colPrice.textContent = "NT$ " + price;

          // åº«å­˜
          const colStock = document.createElement("div");
          colStock.className = "prod-col-stock";
          colStock.textContent = stock;

          // å»ºç«‹æ™‚é–“
          const colTime = document.createElement("div");
          colTime.className = "prod-col-time";
          colTime.textContent = createdText;

          // â­ æ“ä½œæ¬„ï¼ˆç·¨è¼¯æŒ‰éˆ•ï¼‰
          const colActions = document.createElement("div");
          colActions.className = "prod-col-actions";
          const editBtn = document.createElement("button");
          editBtn.className = "btn-mini";
          editBtn.textContent = "ç·¨è¼¯";
          editBtn.addEventListener("click", () => {
            // å¸¶è‘—å•†å“ ID è·³åˆ°ç·¨è¼¯é 
            window.location.href =
              `seller_edit_product.html?pid=${encodeURIComponent(docSnap.id)}`;
          });
          colActions.appendChild(editBtn);

          row.appendChild(colImg);
          row.appendChild(colTitle);
          row.appendChild(colPrice);
          row.appendChild(colStock);
          row.appendChild(colTime);
          row.appendChild(colActions);

          prodRowsEl.appendChild(row);
        });

        prodListEl.style.display = "block";
        prodNoteEl.style.display = "block";

      } catch (err) {
        console.error(err);
        alert("è¼‰å…¥å•†å“åˆ—è¡¨å¤±æ•—ï¼š" + err.message);
      }
    }
  </script>
</body>
</html>
