<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - 賣家後台</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
    header { background:#1f354d; color:white; padding:16px 24px; display:flex; justify-content:space-between; align-items:center; }
    header div { font-weight:bold; }
    .user-info { display:flex; gap:8px; align-items:center; }
    .btn { padding:8px 14px; border:none; border-radius:4px; cursor:pointer; font-size:14px; }
    .btn-light { background:#ffffff; color:#1f354d; }
    .btn-danger { background:#c0392b; color:white; }

    .container { max-width:960px; margin:24px auto; padding:24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15); background:white; }
    h2 { margin-top:0; }
    .info { margin-top:10px; font-size:14px; color:#555; }

    .card-list { margin-top:20px; }
    .link-btn { display:inline-block; margin-right:12px; margin-bottom:12px; padding:10px 16px; background:#1f354d; color:white; border-radius:4px; text-decoration:none; font-size:14px; }
    .link-btn:hover { background:#28486a; }

    /* ===== 商品列表 ===== */
    .section-title { margin-top:24px; font-size:18px; font-weight:bold; }
    .prod-list { margin-top:12px; }

    .prod-list-header, .prod-row { display:flex; align-items:center; font-size:14px; }
    .prod-list-header { font-weight:bold; border-bottom:1px solid #ddd; padding-bottom:6px; }
    .prod-row { padding:8px 0; border-bottom:1px solid #f0f0f0; }

    .prod-col-img     { width:80px; }
    .prod-col-title   { flex:2; padding-right:8px; }
    .prod-col-cat     { width:120px; text-align:center; color:#555; }
    .prod-col-price   { width:100px; text-align:right; }
    .prod-col-stock   { width:80px; text-align:right; }
    .prod-col-time    { width:160px; font-size:12px; color:#777; text-align:right; }
    .prod-col-actions { width:90px; text-align:center; }

    .btn-mini { padding:4px 8px; font-size:12px; border-radius:4px; border:none; background:#1f354d; color:white; cursor:pointer; }
    .btn-mini:hover { background:#28486a; }

    .prod-img { width:64px; height:64px; object-fit:cover; border-radius:4px; background:#eee; }
    .empty { margin-top:10px; color:#777; font-size:14px; }
    .small-note { margin-top:4px; font-size:12px; color:#999; }
  </style>
</head>

<body>
<header>
  <div>SGTP 二手商品平台 - 賣家後台</div>
  <div class="user-info">
    <span id="userName">賣家</span>
    <button class="btn btn-light" onclick="location.href='seller_orders.html'">查看訂單</button>
    <button class="btn btn-light" onclick="location.href='index.html'">回起始頁</button>
    <button id="btnLogout" class="btn btn-danger">登出</button>
  </div>
</header>

<div class="container">
  <h2>歡迎來到賣家後台</h2>
  <p class="info">在這裡你可以上架商品，也可以看到自己已上架的商品。</p>

  <div class="card-list">
    <a href="seller_add_product.html" class="link-btn">➕ 上架新商品</a>
  </div>

  <!-- 商品列表 -->
  <div class="my-products">
    <div class="section-title">我已上架的商品</div>

    <div id="prodEmpty" class="empty" style="display:none;">
      目前還沒有上架任何商品
    </div>

    <div id="prodList" class="prod-list" style="display:none;">
      <div class="prod-list-header">
        <div class="prod-col-img">圖片</div>
        <div class="prod-col-title">商品名稱</div>
        <div class="prod-col-cat">分類</div>
        <div class="prod-col-price">價格</div>
        <div class="prod-col-stock">庫存</div>
        <div class="prod-col-time">建立時間</div>
        <div class="prod-col-actions">操作</div>
      </div>
      <div id="prodRows"></div>
    </div>

    <div id="prodNote" class="small-note" style="display:none;">
      * 僅顯示此賣家帳號所上架的商品
    </div>
  </div>
</div>
<script>
  const userNameSpan = document.getElementById('userName');
  const btnLogout = document.getElementById('btnLogout');
  let currentSellerUid = null;

  const prodEmptyEl = document.getElementById('prodEmpty');
    const prodListEl  = document.getElementById('prodList');
    const prodRowsEl  = document.getElementById('prodRows');
    const prodNoteEl  = document.getElementById('prodNote');

    const FALLBACK_IMG = 'https://via.placeholder.com/80x80?text=No+Image';

    function getAuthHeader(){ const t = localStorage.getItem('token'); return t?{ 'Authorization':'Bearer '+t } : {}; }

    (async function(){
      try{
        const res = await fetch('/api/auth/me', { headers: getAuthHeader() });
        if(!res.ok){ alert('請先登入賣家帳號'); window.location.href='seller_login.html'; return; }
        const user = await res.json();
        if(!user || user.role !== 'seller'){ alert('此帳號不是賣家角色'); localStorage.removeItem('token'); window.location.href='seller_login.html'; return; }
        userNameSpan.textContent = user.name || user.email || '賣家'; currentSellerUid = user.id; loadMyProducts();
      }catch(err){ console.error(err); alert('讀取使用者資料失敗：'+err.message); window.location.href='seller_login.html'; }
    })();

    btnLogout.addEventListener('click', ()=>{ localStorage.removeItem('token'); window.location.href='seller_login.html'; });

    async function loadMyProducts(){
      if(!currentSellerUid) return; prodRowsEl.innerHTML=''; prodEmptyEl.style.display='none'; prodListEl.style.display='none'; prodNoteEl.style.display='none';
      try{
        const res = await fetch('/api/products?seller_id=' + encodeURIComponent(currentSellerUid), { headers: getAuthHeader() });
        if(!res.ok) { alert('載入商品失敗'); return; }
        const rows = await res.json();
        if(!rows || rows.length===0){ prodEmptyEl.style.display='block'; return; }
        rows.forEach(data => {
          const title = data.title || '(無標題)';
          const image = (data.images && data.images[0]) || FALLBACK_IMG;
          const price = data.price || 0;
          const stock = data.quantity || data.stock || 0;
          const createdText = data.created_at ? new Date(data.created_at).toLocaleString() : '';

          const row = document.createElement('div'); row.className='prod-row';
          const colImg = document.createElement('div'); colImg.className='prod-col-img'; const imgEl = document.createElement('img'); imgEl.className='prod-img'; imgEl.src = image; imgEl.alt = title; imgEl.onerror = ()=>{ imgEl.src = FALLBACK_IMG }; colImg.appendChild(imgEl);
          const colTitle = document.createElement('div'); colTitle.className='prod-col-title'; colTitle.textContent = title;
          const colPrice = document.createElement('div'); colPrice.className='prod-col-price'; colPrice.textContent = 'NT$ ' + price;
          const colStock = document.createElement('div'); colStock.className='prod-col-stock'; colStock.textContent = stock;
          const colTime = document.createElement('div'); colTime.className='prod-col-time'; colTime.textContent = createdText;
          const colActions = document.createElement('div'); colActions.className='prod-col-actions'; const editBtn = document.createElement('button'); editBtn.className='btn-mini'; editBtn.textContent='編輯'; editBtn.addEventListener('click', ()=>{ window.location.href = `seller_edit_product.html?pid=${encodeURIComponent(data.id)}` }); colActions.appendChild(editBtn);
          row.appendChild(colImg); row.appendChild(colTitle); row.appendChild(colPrice); row.appendChild(colStock); row.appendChild(colTime); row.appendChild(colActions); prodRowsEl.appendChild(row);
        }); prodListEl.style.display='block'; prodNoteEl.style.display='block';
      }catch(err){ console.error(err); alert('載入商品列表失敗：' + err.message); }
    }
</script>

</body>
</html>
