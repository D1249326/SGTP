<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - æˆ‘çš„è¨‚å–®</title>
  <style>
    /* =========================================
       1. å…¨å±€èˆ‡ Header æ¨£å¼
       ========================================= */
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
    
    header {
      background: #1f354d;
      color: white;
      padding: 10px 24px;
      display: flex;
      align-items: center;
      gap: 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      height: 50px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .logo {
      font-size: 28px;
      font-weight: bold;
      color: white;
      text-decoration: none;
      white-space: nowrap;
      margin-right: 10px;
    }

    .header-search {
      flex: 1;
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      position: relative;
    }
    .header-search input {
      width: 100%;
      padding: 8px 36px 8px 12px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      outline: none;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-left: auto;
    }

    .icon-btn {
      color: white;
      text-decoration: none;
      font-size: 24px;
      transition: opacity 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .icon-btn:hover { opacity: 0.8; }

    .user-menu {
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      height: 50px;
      padding-left: 8px;
    }
    .user-name { font-size: 16px; font-weight: bold; color: white; }
    .user-name::after { content: ' â–¼'; font-size: 10px; margin-left: 6px; vertical-align: middle; }
    
    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: white;
      min-width: 140px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 0 0 4px 4px;
      overflow: hidden;
      z-index: 1001;
    }
    .dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
    }
    .dropdown-content a:hover { background-color: #f5f5f5; color: #1f354d; }
    .user-menu:hover .dropdown-content { display: block; }

    /* =========================================
       2. è¨‚å–®åˆ—è¡¨æ¨£å¼
       ========================================= */
    .container { max-width: 900px; margin: 40px auto; padding: 0 16px; }
    h2 { margin-top: 0; color: #333; }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
      transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

    .empty { margin-top: 40px; text-align: center; color: #777; font-size: 16px; }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .order-id { font-weight: bold; font-size: 16px; color: #1f354d; }

    .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; color: white; font-weight: bold; }
    .badge-pending { background: #e67e22; }   /* æ©˜è‰²ï¼šè™•ç†ä¸­ */
    .badge-shipped { background: #16a085; }   /* é’è‰²ï¼šå·²å‡ºè²¨ */
    .badge-completed { background: #2ecc71; } /* ç¶ è‰²ï¼šå·²å®Œæˆ */
    .badge-canceled { background: #7f8c8d; }  /* ç°è‰²ï¼šå·²å–æ¶ˆ */
    .badge-cancel-req { background: #f39c12; }

    .order-meta { font-size: 14px; color: #555; margin-bottom: 12px; line-height: 1.6; }
    .order-meta span { margin-right: 15px; }

    .order-actions { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }

    .btn { padding: 6px 14px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; transition: opacity 0.2s; }
    .btn:hover { opacity: 0.9; }
    .btn-cancel-request { background: #c0392b; color: white; }
    .btn-complete { background: #2ecc71; color: white; }
    .btn-chat { background: #e67e22; color: white; }

    .items-toggle {
      cursor: pointer;
      font-size: 14px;
      color: #1f354d;
      margin-top: 10px;
      display: inline-block;
      text-decoration: underline;
    }
    .items-list {
      display: none;
      background: #fafafa;
      padding: 10px;
      border-radius: 4px;
      margin-top: 8px;
      font-size: 14px;
      color: #333;
    }
    .items-list div { padding: 4px 0; border-bottom: 1px dashed #eee; }
    .items-list div:last-child { border-bottom: none; }

    #globalMsg { display:none; color:#c0392b; margin-top:10px; text-align:center; }
    
    /* è©•åƒ¹è¦–çª—æ¨£å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
    .modal-box { background: white; padding: 24px; border-radius: 8px; width: 300px; text-align: center; }
    .rating-slider { width: 100%; margin: 15px 0; }
    .rating-val { font-size: 24px; font-weight: bold; color: #f39c12; margin-bottom: 10px; }
  
  </style>
</head>

<body>

  <header>
    <a href="buyer_shop.html" class="logo">SGTP</a>
    
    <div class="header-search">
      <input id="navSearch" type="text" placeholder="æœå°‹å•†å“åç¨±..." />
    </div>

    <div class="header-right">
      <a href="buyer_cart.html" class="icon-btn" title="è³¼ç‰©è»Š">ğŸ›’</a>
      <a href="buyer_chats.html" class="icon-btn" title="èŠå¤©å®¤">ğŸ’¬</a>
      
      <div class="user-menu">
        <span class="user-name" id="headerUser">è¼‰å…¥ä¸­...</span>
        <div class="dropdown-content">
          <a href="buyer_home.html">æˆ‘çš„è³‡æ–™</a>
          <a href="buyer_orders.html">è¨‚å–®æŸ¥è©¢</a>
          <a href="#" id="headerLogoutBtn">ç™»å‡º</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <h2>æˆ‘çš„è¨‚å–®åˆ—è¡¨</h2>
    <div id="ordersEmpty" class="empty" style="display:none;">ç›®å‰æ²’æœ‰ä»»ä½•è¨‚å–®è¨˜éŒ„ã€‚</div>
    <div id="ordersWrap"></div>
    <div id="globalMsg"></div>
  </div>

  <div id="reviewModal" class="modal-overlay">
    <div class="modal-box">
      <h3>è©•åƒ¹è³£å®¶</h3>
      <div id="reviewTargetName" style="margin-bottom:10px; color:#555;"></div>
      
      <div class="rating-val"><span id="ratingScore">5</span> åˆ†</div>
      <input type="range" id="ratingRange" class="rating-slider" min="1" max="5" step="1" value="5">
      
      <textarea id="reviewComment" placeholder="å¯«é»è©•èª... (é¸å¡«)" style="width:100%; height:60px; margin-bottom:10px;"></textarea>
      
      <button id="btnSubmitReview" class="btn btn-primary" style="background:#1f354d; color:white;">é€å‡ºè©•åƒ¹</button>
      <button onclick="closeReviewModal()" class="btn btn-secondary" style="margin-top:8px; background:#ccc;">å–æ¶ˆ</button>
    </div>
  </div>

  <script>
    /* ========== Header é‚è¼¯ ========== */
    const headerUserEl = document.getElementById('headerUser');
    const headerLogoutBtn = document.getElementById('headerLogoutBtn');
    const navSearch = document.getElementById('navSearch');

    function getAuthHeader(){ 
      const t = localStorage.getItem('token'); 
      return t ? { 'Authorization':'Bearer '+t, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' }; 
    }

    // æœå°‹è·³è½‰
    if(navSearch){
      navSearch.addEventListener('keypress', (e)=>{
        if(e.key === 'Enter'){
          const val = navSearch.value.trim();
          if(val) window.location.href = 'buyer_shop.html?q=' + encodeURIComponent(val);
        }
      });
    }

    // åˆå§‹åŒ– Header ä½¿ç”¨è€…
    (async function(){
      try{
        const res = await fetch('/api/auth/me', { headers: getAuthHeader() });
        if (!res.ok) { 
          // æœªç™»å…¥å‰‡å°å‘ç™»å…¥é 
          alert('è«‹å…ˆç™»å…¥è²·å®¶å¸³è™Ÿ'); 
          window.location.href='buyer_login.html'; 
          return; 
        }
        const user = await res.json();
        if(headerUserEl) headerUserEl.textContent = user.name || user.email;
        
        // è¼‰å…¥è¨‚å–®
        loadOrders();
      }catch(e){ console.error(e); }
    })();

    // ç™»å‡º
    if(headerLogoutBtn) headerLogoutBtn.addEventListener('click', (e)=>{ e.preventDefault(); localStorage.removeItem('token'); window.location.href='buyer_login.html'; });


    /* ========== è¨‚å–®åˆ—è¡¨èˆ‡è©•åƒ¹é‚è¼¯ ========== */
    const ordersWrap = document.getElementById('ordersWrap');
    const ordersEmpty = document.getElementById('ordersEmpty');
    const globalMsg = document.getElementById('globalMsg');

    // è©•åƒ¹ Modal ç›¸é—œå…ƒç´ 
    const reviewModal = document.getElementById('reviewModal');
    const ratingRange = document.getElementById('ratingRange');
    const ratingScore = document.getElementById('ratingScore');
    const btnSubmitReview = document.getElementById('btnSubmitReview');
    const reviewComment = document.getElementById('reviewComment');
    let currentReviewOrder = null; // æš«å­˜ç›®å‰æ­£åœ¨è©•åƒ¹çš„è¨‚å–®è³‡è¨Š

    async function loadOrders(){
      ordersWrap.innerHTML = ''; 
      ordersEmpty.style.display='none'; 
      globalMsg.style.display='none';

      try{
        const res = await fetch('/api/orders/my', { headers: getAuthHeader() });
        if(!res.ok) throw new Error('ç„¡æ³•è®€å–è¨‚å–®è³‡æ–™');
        
        const rows = await res.json();
        if(!rows || rows.length === 0) { 
          ordersEmpty.style.display='block'; 
          return; 
        }

        rows.forEach(row => {
          const div = document.createElement('div'); 
          div.className='card';
          
          // ç‹€æ…‹åˆ¤æ–·
          const st = (row.status||'').toLowerCase();
          let badgeClass='badge-pending', badgeText='å·²æˆç«‹';
          
          if(st === 'shipped') { badgeClass='badge-shipped'; badgeText='å·²å‡ºè²¨'; }
          else if(st === 'completed') { badgeClass='badge-completed'; badgeText='å·²å®Œæˆ'; }
          else if(st === 'cancelled') { badgeClass='badge-canceled'; badgeText='å·²å–æ¶ˆ'; }
          else if(row.status === 'Cancellation Requested') { badgeClass='badge-cancel-req'; badgeText='å–æ¶ˆå¯©æ ¸ä¸­'; }

          // è§£æå•†å“åˆ—è¡¨
          let items = row.items;
          if (typeof items === 'string') {
            try { items = JSON.parse(items); } catch(e) { items = []; }
          }
          if (!Array.isArray(items)) items = [];

          // ç”¢ç”Ÿå•†å“æ˜ç´° HTML
          const itemsHtml = items.map(i => 
            `<div>${i.title || i.name || 'å•†å“'} x ${i.qty || i.quantity} (å–®åƒ¹: $${i.price})</div>`
          ).join('');

          div.innerHTML = `
            <div class="order-header">
              <div class="order-id">è¨‚å–®ç·¨è™Ÿ #${row.id}</div>
              <span class="badge ${badgeClass}">${badgeText}</span>
            </div>
            <div class="order-meta">
              <span>æ—¥æœŸ: ${new Date(row.created_at).toLocaleString()}</span>
              <span>ç¸½é‡‘é¡: <b style="color:#c0392b;">NT$ ${row.totalAmount || row.total_amount}</b></span>
            </div>
            
            <div class="order-actions" id="actions-${row.id}"></div>

            <div class="items-toggle" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'">
              æŸ¥çœ‹å•†å“æ˜ç´° (${items.length} ä»¶) â–¼
            </div>
            <div class="items-list">${itemsHtml}</div>
          `;
          
          ordersWrap.appendChild(div);

          // å‹•æ…‹åŠ å…¥æŒ‰éˆ•
          const actDiv = div.querySelector(`#actions-${row.id}`);
          const sellerId = items[0]?.sellerId || items[0]?.seller_id; // å–å¾—è³£å®¶ID

          // 1. å–æ¶ˆè¨‚å–® (åƒ…é™ Pending)
          if(st === 'pending'){
             const btn = document.createElement('button'); 
             btn.className='btn btn-cancel-request'; 
             btn.textContent='æå‡ºå–æ¶ˆè¨‚å–®';
             btn.onclick = () => requestCancel(row.id); 
             actDiv.appendChild(btn);
          } 
          // 2. å®Œæˆè¨‚å–® (åƒ…é™ Shipped)
          else if(st === 'shipped'){
             const btn = document.createElement('button'); 
             btn.className='btn btn-complete'; 
             btn.textContent='å®Œæˆè¨‚å–® (ç¢ºèªæ”¶è²¨)';
             btn.onclick = () => completeOrder(row.id); 
             actDiv.appendChild(btn);
          }
          // 3. è©•åƒ¹è³£å®¶ (åƒ…é™ Completed)
          else if(st === 'completed'){
             if (row.is_reviewed) {
                 const span = document.createElement('span');
                 span.textContent = 'å·²è©•åƒ¹';
                 span.style.color = '#7f8c8d';
                 span.style.fontSize = '13px';
                 span.style.marginRight = '10px';
                 actDiv.appendChild(span);
             } else {
                 const btn = document.createElement('button'); 
                 btn.className='btn'; 
                 btn.style.background = '#f39c12';
                 btn.style.color = 'white';
                 btn.textContent='â˜… è©•åƒ¹è³£å®¶';
                 btn.onclick = () => openReviewModal(row.id, sellerId); 
                 actDiv.appendChild(btn);
             }
          }

          // 4. è¯çµ¡è³£å®¶ (æ’é™¤å·²å–æ¶ˆï¼Œå·²å®Œæˆçš„è¨‚å–®é€šå¸¸é‚„æ˜¯å¯ä»¥è¯çµ¡ï¼Œæ‰€ä»¥ä¿ç•™)
          if(sellerId && st !== 'cancelled'){
             const btn = document.createElement('button'); 
             btn.className='btn btn-chat'; 
             btn.textContent='è¯çµ¡è³£å®¶';
             btn.onclick = () => location.href=`chat.html?targetId=${sellerId}&role=buyer&orderId=${row.id}`; 
             actDiv.appendChild(btn);
          }
        });

      } catch(err){ 
        console.error(err); 
        globalMsg.style.display='block'; 
        globalMsg.textContent = 'è®€å–è¨‚å–®éŒ¯èª¤ï¼š' + (err.message||err); 
      }
    }

    // å–æ¶ˆç”³è«‹
    async function requestCancel(orderId) {
      const ok = confirm('ç¢ºå®šè¦æå‡ºå–æ¶ˆé€™ç­†è¨‚å–®å—ï¼Ÿ\nï¼ˆé€å‡ºå¾Œéœ€ç­‰å¾…è³£å®¶åŒæ„ï¼‰'); 
      if (!ok) return;
      
      const reason = prompt('è«‹è¼¸å…¥å–æ¶ˆåŸå› ï¼ˆå¯ç•™ç©ºï¼‰ï¼š'); 
      if(reason === null) return;

      try {
        const res = await fetch(`/api/orders/${orderId}/cancel-request`, { 
          method:'PUT', 
          headers: getAuthHeader(), 
          body: JSON.stringify({ cancelReason: reason }) 
        });
        if(!res.ok) throw new Error('æ“ä½œå¤±æ•—');
        alert('å·²é€å‡ºå–æ¶ˆç”³è«‹ï¼'); 
        loadOrders();
      } catch(e) { alert('å¤±æ•—ï¼š'+e.message); }
    }

    // å®Œæˆè¨‚å–®
    async function completeOrder(orderId) {
      if(!confirm('ç¢ºèªå·²æ”¶åˆ°å•†å“ä¸¦æª¢æŸ¥ç„¡èª¤ï¼Ÿ\né»é¸ç¢ºå®šå¾Œè¨‚å–®å°‡æ¨™è¨˜ç‚ºã€Œå·²å®Œæˆã€ã€‚')) return;
      
      try {
        const res = await fetch(`/api/orders/${orderId}/complete`, { 
          method:'PUT', 
          headers: getAuthHeader() 
        });
        if(!res.ok) throw new Error('æ“ä½œå¤±æ•—');
        alert('è¨‚å–®å·²å®Œæˆï¼æ„Ÿè¬æ‚¨çš„è³¼è²·ã€‚'); 
        loadOrders();
      } catch(e) { alert('å¤±æ•—ï¼š'+e.message); }
    }

    /* ========== è©•åƒ¹ Modal é‚è¼¯ ========== */
    
    // é–‹å•Ÿè©•åƒ¹è¦–çª—
    function openReviewModal(orderId, sellerId) {
        if(!sellerId) { alert('ç„¡æ³•è¾¨è­˜è³£å®¶ IDï¼Œç„¡æ³•è©•åƒ¹'); return; }
        currentReviewOrder = { orderId, sellerId };
        
        // é‡ç½®è¡¨å–®
        if(ratingRange) ratingRange.value = 5;
        if(ratingScore) ratingScore.textContent = '5';
        if(reviewComment) reviewComment.value = '';
        
        if(reviewModal) reviewModal.style.display = 'flex';
    }

    // é—œé–‰è©•åƒ¹è¦–çª— (ç¶å®šåˆ° window ä»¥ä¾¿ HTML onclick ä½¿ç”¨)
    window.closeReviewModal = function() {
        if(reviewModal) reviewModal.style.display = 'none';
        currentReviewOrder = null;
    }

    // æ‹‰æ¡¿äº‹ä»¶ç›£è½
    if(ratingRange && ratingScore) {
        ratingRange.addEventListener('input', (e) => {
            ratingScore.textContent = e.target.value;
        });
    }

    // é€å‡ºè©•åƒ¹
    if(btnSubmitReview) {
        btnSubmitReview.addEventListener('click', async () => {
            if(!currentReviewOrder) return;
            
            try {
                const res = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: getAuthHeader(),
                    body: JSON.stringify({
                        orderId: currentReviewOrder.orderId,
                        sellerId: currentReviewOrder.sellerId,
                        rating: Number(ratingRange.value),
                        comment: reviewComment.value
                    })
                });
                const data = await res.json();
                if(res.ok) {
                    alert('è©•åƒ¹æˆåŠŸï¼');
                    closeReviewModal();
                    loadOrders(); // é‡æ–°æ•´ç†åˆ—è¡¨ä»¥æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                } else {
                    alert('è©•åƒ¹å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch(e) {
                console.error(e);
                alert('é€£ç·šéŒ¯èª¤ï¼š' + e.message);
            }
        });
    }

  </script>

</body>
</html>