<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - æˆ‘çš„è¨‚å–®</title>
  <style>
    body {
      margin:0;
      font-family: Arial, sans-serif;
      background:#f5f5f5;
    }
    header {
      background:#1f354d;
      color:white;
      padding:16px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    header h1 { margin:0; font-size:22px; }
    header .right button { margin-left:8px; }

    .btn {
      padding:6px 12px;
      border:none;
      border-radius:4px;
      font-size:14px;
      cursor:pointer;
    }
    .btn-light { background:#ffffff; color:#1f354d; }
    .btn-danger { background:#c0392b; color:#fff; }
    .btn-primary { background:#1f354d; color:#fff; }
    .btn-secondary { background:#bdc3c7; color:#2c3e50; }
    .btn-cancel-request {
      background:#e67e22;
      color:white;
    }

    .container {
      max-width:960px;
      margin:24px auto;
      padding:0 16px;
    }
    .card {
      background:white;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:16px 20px;
      margin-bottom:16px;
    }
    .empty {
      margin-top:16px;
      color:#777;
    }

    .order-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .order-id {
      font-weight:bold;
      font-size:15px;
    }
    .badge {
      display:inline-block;
      padding:2px 8px;
      border-radius:10px;
      font-size:12px;
      color:white;
    }
    .badge-pending { background:#e67e22; }
    .badge-paid { background:#2980b9; }
    .badge-shipped { background:#16a085; }
    .badge-completed { background:#2ecc71; }
    .badge-canceled { background:#7f8c8d; }

    .badge-cancel-req { background:#f39c12; }
    .badge-cancel-rej { background:#c0392b; }

    .order-meta {
      font-size:13px;
      color:#555;
      margin-bottom:6px;
    }
    .order-total {
      font-weight:bold;
      margin-top:4px;
    }
    .order-actions {
      margin-top:8px;
    }

    .items-toggle {
      cursor:pointer;
      font-size:13px;
      color:#1f354d;
      margin-top:4px;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .items-list {
      margin-top:8px;
      font-size:13px;
      border-top:1px solid #eee;
      padding-top:6px;
      display:none;
    }

    .msg {
      margin-top:10px;
      font-size:14px;
      color:#c0392b;
    }
    .msg-ok { color:#27ae60; }
  </style>
</head>
<body>
<header>
  <h1>æˆ‘çš„è¨‚å–®</h1>
  <div class="right">
    <button class="btn btn-light" onclick="location.href='buyer_shop.html'">ç¹¼çºŒè³¼ç‰©</button>
    <button class="btn btn-light" onclick="location.href='buyer_cart.html'">ğŸ›’ è³¼ç‰©è»Š</button>
    <button id="btnLogout" class="btn btn-danger">ç™»å‡º</button>
  </div>
</header>

<div class="container">
  <h2>è¨‚å–®åˆ—è¡¨</h2>
  <div id="globalMsg" class="msg"></div>
  <div id="ordersEmpty" class="empty" style="display:none;">ç›®å‰æ²’æœ‰ä»»ä½•è¨‚å–®ã€‚</div>
  <div id="ordersWrap"></div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    collection,
    query,
    where,
    getDocs,
    doc,
    updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const btnLogout   = document.getElementById("btnLogout");
  const ordersEmpty = document.getElementById("ordersEmpty");
  const ordersWrap  = document.getElementById("ordersWrap");
  const globalMsg   = document.getElementById("globalMsg");

  let currentBuyerUid = null;

  // ç™»å‡º
  btnLogout.addEventListener("click", async () => {
    try {
      await signOut(auth);
      alert("å·²ç™»å‡º");
      window.location.href = "buyer_login.html";
    } catch (err) {
      console.error(err);
      alert("ç™»å‡ºå¤±æ•—ï¼š" + err.message);
    }
  });

  // ç›£è½ç™»å…¥
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("è«‹å…ˆç™»å…¥è²·å®¶å¸³è™Ÿ");
      window.location.href = "buyer_login.html";
      return;
    }
    currentBuyerUid = user.uid;
    await loadOrders();
  });

  function formatDate(ts) {
    if (!ts || !ts.toDate) return "-";
    const d = ts.toDate();
    const yyyy = d.getFullYear();
    const mm   = String(d.getMonth()+1).padStart(2,"0");
    const dd   = String(d.getDate()).padStart(2,"0");
    const hh   = String(d.getHours()).padStart(2,"0");
    const mi   = String(d.getMinutes()).padStart(2,"0");
    return `${yyyy}/${mm}/${dd} ${hh}:${mi}`;
  }

  function getStatusBadge(data) {
    const span = document.createElement("span");
    span.classList.add("badge");

    // å…ˆè™•ç†å–æ¶ˆç›¸é—œ
    if (data.status === "canceled" || data.cancelStatus === "approved") {
      span.classList.add("badge-canceled");
      span.textContent = "å·²å–æ¶ˆ";
      return span;
    }
    if (data.cancelStatus === "requested") {
      span.classList.add("badge-cancel-req");
      span.textContent = "å–æ¶ˆç”³è«‹ä¸­";
      return span;
    }
    if (data.cancelStatus === "rejected") {
      span.classList.add("badge-cancel-rej");
      span.textContent = "å–æ¶ˆè¢«æ‹’çµ•";
      return span;
    }

    // ä¸€èˆ¬ç‹€æ…‹
    switch (data.status) {
      case "pending":
        span.classList.add("badge-pending");
        span.textContent = "pending";
        break;
      case "paid":
        span.classList.add("badge-paid");
        span.textContent = "å·²ä»˜æ¬¾";
        break;
      case "shipped":
        span.classList.add("badge-shipped");
        span.textContent = "å·²å‡ºè²¨";
        break;
      case "completed":
        span.classList.add("badge-completed");
        span.textContent = "å·²å®Œæˆ";
        break;
      default:
        span.classList.add("badge-pending");
        span.textContent = data.status || "unknown";
    }
    return span;
  }

  async function loadOrders() {
    ordersWrap.innerHTML = "";
    ordersEmpty.style.display = "none";
    globalMsg.textContent = "";

    try {
      // åªç”¨ buyerId éæ¿¾ï¼Œä¸ orderByï¼Œé¿å…ç´¢å¼•éŒ¯èª¤
      const q = query(
        collection(db, "orders"),
        where("buyerId", "==", currentBuyerUid)
      );
      const snap = await getDocs(q);

      if (snap.empty) {
        ordersEmpty.style.display = "block";
        return;
      }

      snap.forEach(docSnap => {
        const data = docSnap.data();
        const card = document.createElement("div");
        card.className = "card";

        const header = document.createElement("div");
        header.className = "order-header";

        const idDiv = document.createElement("div");
        idDiv.className = "order-id";
        idDiv.textContent = "è¨‚å–®ç·¨è™Ÿï¼š" + docSnap.id;

        const badge = getStatusBadge(data);
        header.appendChild(idDiv);
        header.appendChild(badge);

        const meta = document.createElement("div");
        meta.className = "order-meta";
        meta.textContent = "è¨‚å–®æ—¥æœŸï¼š" + formatDate(data.createdAt || data.created_at);

        const statusLine = document.createElement("div");
        statusLine.className = "order-meta";
        statusLine.textContent = "ç‹€æ…‹ï¼š" + (badge.textContent || data.status);

        const totalDiv = document.createElement("div");
        totalDiv.className = "order-total";
        totalDiv.textContent = "è¨‚å–®ç¸½é¡ï¼šNT$ " + (data.totalAmount || 0);

        const actions = document.createElement("div");
        actions.className = "order-actions";

        // æ˜¯å¦å¯ä»¥æå‡ºå–æ¶ˆï¼š
        const canRequestCancel =
          (data.status === "pending" || data.status === "paid") &&
          (!data.cancelStatus || data.cancelStatus === "none");

        if (canRequestCancel) {
          const btnCancel = document.createElement("button");
          btnCancel.className = "btn btn-cancel-request";
          btnCancel.textContent = "æå‡ºå–æ¶ˆè¨‚å–®";
          btnCancel.addEventListener("click", () => {
            requestCancel(docSnap.id, data);
          });
          actions.appendChild(btnCancel);
        } else if (data.cancelStatus === "requested") {
          const tip = document.createElement("div");
          tip.className = "order-meta";
          tip.textContent = "ï¼ˆå·²é€å‡ºå–æ¶ˆç”³è«‹ï¼Œç­‰å¾…è³£å®¶è™•ç†ï¼‰";
          actions.appendChild(tip);
        }

        // å±•é–‹å•†å“åˆ—è¡¨çš„é€£çµ
        const toggle = document.createElement("div");
        toggle.className = "items-toggle";
        toggle.textContent = "æŸ¥çœ‹å•†å“æ˜ç´° ï¼‹";

        const itemsDiv = document.createElement("div");
        itemsDiv.className = "items-list";

        if (Array.isArray(data.items)) {
          data.items.forEach(it => {
            const line = document.createElement("div");
            line.textContent = `${it.title || "å•†å“"} x ${it.qty || 1}ï¼ˆå–®åƒ¹ NT$ ${it.price || 0}ï¼‰`;
            itemsDiv.appendChild(line);
          });
        } else {
          itemsDiv.textContent = "ï¼ˆç„¡å•†å“æ˜ç´°ï¼‰";
        }

        toggle.addEventListener("click", () => {
          if (itemsDiv.style.display === "none" || itemsDiv.style.display === "") {
            itemsDiv.style.display = "block";
            toggle.textContent = "æ”¶åˆå•†å“æ˜ç´° ï¼";
          } else {
            itemsDiv.style.display = "none";
            toggle.textContent = "æŸ¥çœ‹å•†å“æ˜ç´° ï¼‹";
          }
        });

        card.appendChild(header);
        card.appendChild(meta);
        card.appendChild(statusLine);
        card.appendChild(totalDiv);
        card.appendChild(actions);
        card.appendChild(toggle);
        card.appendChild(itemsDiv);

        ordersWrap.appendChild(card);
      });

    } catch (err) {
      console.error(err);
      globalMsg.textContent = "è®€å–è¨‚å–®éŒ¯èª¤ï¼š" + err.message;
    }
  }

  // è²·å®¶æå‡ºå–æ¶ˆ
  async function requestCancel(orderId, data) {
    const ok = confirm("ç¢ºå®šè¦æå‡ºå–æ¶ˆé€™ç­†è¨‚å–®å—ï¼Ÿ\nï¼ˆé€å‡ºå¾Œéœ€ç­‰å¾…è³£å®¶åŒæ„æˆ–æ‹’çµ•ï¼‰");
    if (!ok) return;

    let reason = prompt("å¯ä»¥å¡«å¯«å–æ¶ˆåŸå› ï¼ˆå¯ç•™ç©ºï¼‰ï¼š", "");
    if (reason === null) reason = ""; // æŒ‰å–æ¶ˆå°±ç•¶ç©ºå­—ä¸²

    try {
      await updateDoc(doc(db, "orders", orderId), {
        cancelStatus: "requested",
        cancelReason: reason,
        cancelRequestBy: currentBuyerUid,
        cancelRequestAt: serverTimestamp()
      });
      alert("å·²é€å‡ºå–æ¶ˆç”³è«‹ï¼");
      await loadOrders();
    } catch (err) {
      console.error(err);
      alert("é€å‡ºå–æ¶ˆç”³è«‹å¤±æ•—ï¼š" + err.message);
    }
  }
</script>
</body>
</html>
