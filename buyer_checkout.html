<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - çµå¸³</title>
  <style>
    /* =========================================
       1. å…¨å±€èˆ‡ Header æ¨£å¼
       ========================================= */
    body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
    
    header {
      background: #1f354d;
      color: white;
      padding: 10px 24px;
      display: flex;
      align-items: center;
      gap: 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      height: 50px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .logo {
      font-size: 28px;
      font-weight: bold;
      color: white;
      text-decoration: none;
      white-space: nowrap;
      margin-right: 10px;
    }

    .header-search {
      flex: 1;
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      position: relative;
    }
    .header-search input {
      width: 100%;
      padding: 8px 36px 8px 12px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      outline: none;
    }
    .search-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      pointer-events: none;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-left: auto;
    }

    .icon-btn {
      color: white;
      text-decoration: none;
      font-size: 24px;
      transition: opacity 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .icon-btn:hover { opacity: 0.8; }

    .user-menu {
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      height: 50px;
      padding-left: 8px;
    }
    .user-name { font-size: 16px; font-weight: bold; color: white; }
    .user-name::after { content: ' â–¼'; font-size: 10px; margin-left: 6px; vertical-align: middle; }
    
    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: white;
      min-width: 140px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 0 0 4px 4px;
      overflow: hidden;
      z-index: 1001;
    }
    .dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
    }
    .dropdown-content a:hover { background-color: #f5f5f5; color: #1f354d; }
    .user-menu:hover .dropdown-content { display: block; }
    .user-avatar { width: 30px; height: 30px; background-color: #bdc3c7; border-radius: 50%;display: flex; justify-content: center; align-items: center; font-size: 14px; color: #2c3e50;margin-right: 8px;}

    /* =========================================
       2. çµå¸³é é¢æ¨£å¼
       ========================================= */
    .container {
      max-width:960px; margin:24px auto;
      background:white; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
      padding:24px;
    }

    h2 { margin-top:0; }
    .section { margin-top:16px; }

    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:8px; }
    th { background:#f0f3f6; }
    
    th.price, th.qty, th.subtotal { text-align:right; }
    td.price, td.qty, td.subtotal { text-align:right; }

    .total-row td { font-weight:bold; border-top:2px solid #ccc; }

    .form-row { margin:8px 0; }
    .form-row label { display:inline-block; width:90px; color:#555; }
    .form-row input {
      width:260px; padding:6px 8px;
      border-radius:4px; border:1px solid #ccc;
    }
    .payment-info { margin: 8px 0; font-weight: bold; color: #1f354d; }

    .msg { margin-top:10px; font-size:14px; color:#c0392b; }
    .msg-ok { color:#27ae60; }
    .empty { margin-top:10px; color:#777; }
  </style>
</head>

<body>

  <header>
    <a href="buyer_shop.html" class="logo">SGTP</a>
    
    <div class="header-search">
      <input id="navSearch" type="text" placeholder="æœå°‹å•†å“åç¨±..." />
    </div>

    <div class="header-right">
      <a href="buyer_cart.html" class="icon-btn" title="è³¼ç‰©è»Š">ğŸ›’</a>
      <a href="buyer_chats.html" class="icon-btn" title="èŠå¤©å®¤">ğŸ’¬</a>
      
      <div class="user-menu">
        <div class="user-avatar">B</div>
        <span class="user-name" id="headerUser">è¼‰å…¥ä¸­...</span>
        <div class="dropdown-content">
          <a href="buyer_home.html">æˆ‘çš„è³‡æ–™</a>
          <a href="buyer_orders.html">è¨‚å–®æŸ¥è©¢</a>
          <a href="#" id="headerLogoutBtn">ç™»å‡º</a>
        </div>
      </div>
    </div>
  </header>

<div class="container">
  <h2>è¨‚å–®ç¢ºèª</h2>

  <div class="section">
    <h3>è³¼ç‰©è»Šå…§å®¹</h3>
    <div id="cartEmpty" class="empty" style="display:none;">è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„ã€‚</div>
    <div id="cartTableWrap" style="display:none;">
      <table>
        <thead>
          <tr>
            <th>å•†å“åç¨±</th>
            <th class="price">å–®åƒ¹</th>
            <th class="qty">æ•¸é‡</th>
            <th class="subtotal">å°è¨ˆ</th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="3" style="text-align:right;">ç¸½é‡‘é¡</td>
            <td id="totalAmount">0</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="section">
    <h3>æ”¶ä»¶è³‡è¨Šèˆ‡ä»˜æ¬¾</h3>
    
    <div class="payment-info">ä»˜æ¬¾æ–¹å¼ï¼šè²¨åˆ°ä»˜æ¬¾ (Cash on Delivery)</div>
    
    <div class="form-row">
      <label>æ”¶ä»¶äºº</label><input id="shipName">
    </div>
    <div class="form-row">
      <label>é›»è©±</label><input id="shipPhone">
    </div>
    <div class="form-row">
      <label>åœ°å€</label><input id="shipAddress" style="width:360px;">
    </div>
  </div>

  <div class="section">
    <button id="btnSubmitOrder" class="btn btn-primary">é€å‡ºè¨‚å–®</button>
    <div id="msg" class="msg"></div>
  </div>
</div>

<script>
  /* ========== 1. Header é‚è¼¯ ========== */
  const headerUserEl = document.getElementById('headerUser');
  const headerLogoutBtn = document.getElementById('headerLogoutBtn');
  const navSearch = document.getElementById('navSearch');

  // ç™»å‡ºåŠŸèƒ½
  if(headerLogoutBtn){
    headerLogoutBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      localStorage.removeItem('token');
      alert('å·²ç™»å‡º');
      window.location.href = 'buyer_login.html';
    });
  }

  // æœå°‹æ¡†åŠŸèƒ½ (æŒ‰ä¸‹ Enter è·³è½‰)
  if(navSearch){
    navSearch.addEventListener('keypress', (e)=>{
      if(e.key === 'Enter'){
        const val = navSearch.value.trim();
        if(val) {
          window.location.href = 'buyer_shop.html?q=' + encodeURIComponent(val);
        }
      }
    });
  }

  /* ========== 2. çµå¸³é é¢é‚è¼¯ ========== */
  const cartEmptyEl    = document.getElementById('cartEmpty');
  const cartTableWrap  = document.getElementById('cartTableWrap');
  const cartBody       = document.getElementById('cartBody');
  const totalAmountEl  = document.getElementById('totalAmount');

  const shipNameInput  = document.getElementById('shipName');
  const shipPhoneInput = document.getElementById('shipPhone');
  const shipAddrInput  = document.getElementById('shipAddress');

  const btnSubmitOrder = document.getElementById('btnSubmitOrder');
  const msgEl          = document.getElementById('msg');

  let currentUser = null;
  let cartItems = [];

  function getToken(){ return localStorage.getItem('token'); }
  function getAuthHeader(){ const t = getToken(); return t ? { 'Authorization': 'Bearer ' + t } : {}; }
  function getJsonAuthHeader(){ return { 'Content-Type': 'application/json', ...getAuthHeader() }; }

  (async function init(){
    try{
      const me = await fetch('/api/auth/me', { headers: getAuthHeader() });
      if (!me.ok) { alert('è«‹å…ˆç™»å…¥è²·å®¶å¸³è™Ÿ'); window.location.href='buyer_login.html'; return; }
      
      currentUser = await me.json();
      if (!currentUser || currentUser.role !== 'buyer') {
        alert('æ­¤å¸³è™Ÿç„¡çµå¸³æ¬Šé™');
        localStorage.removeItem('token');
        window.location.href='buyer_login.html';
        return;
      }

      // âœ… [ä¿®æ­£] æ›´æ–° Header é¡¯ç¤ºåå­—
      if(headerUserEl) headerUserEl.textContent = currentUser.name || currentUser.email;

      // å¡«å…¥é è¨­æ”¶ä»¶è³‡è¨Š
      shipNameInput.value  = currentUser.name || '';
      shipPhoneInput.value = currentUser.phone || '';
      shipAddrInput.value  = currentUser.address || '';

      await loadCartItems();
    }catch(err){
      console.error(err);
      alert('è®€å–ä½¿ç”¨è€…è³‡æ–™å¤±æ•—ï¼š'+(err.message||err));
      window.location.href='buyer_login.html';
    }
  })();

  function normalizeSellerId(row){
    return row.sellerId ?? row.seller_id ?? row.sellerID ?? null;
  }

  async function loadCartItems(){
    cartItems = [];
    cartBody.innerHTML = '';
    totalAmountEl.textContent = '0';
    cartEmptyEl.style.display = 'none';
    cartTableWrap.style.display = 'none';

    try{
      const res = await fetch('/api/cart', { headers: getAuthHeader() });
      if (!res.ok) {
        cartEmptyEl.style.display='block';
        // è‹¥ api/cart å›å‚³ 404 æˆ– errorï¼Œè¦–ç‚ºç©ºè³¼ç‰©è»Š
        return;
      }

      const rows = await res.json();
      if (!rows || rows.length===0) {
        cartEmptyEl.style.display='block';
        return;
      }

      let total = 0;

      rows.forEach(r => {
        const sellerId = normalizeSellerId(r);
        const item = {
          id: r.productId ?? r.product_id ?? r.id,
          title: r.title || 'æœªå‘½åå•†å“',
          price: +r.price || 0,
          qty: +r.qty || 1,
          image: r.image || '',
          sellerId: sellerId
        };

        cartItems.push(item);

        const tr = document.createElement('tr');
        const sub = item.price * item.qty;
        total += sub;

        tr.innerHTML = `
          <td>${item.title}</td>
          <td class="price">${item.price}</td>
          <td class="qty">${item.qty}</td>
          <td class="subtotal">${sub}</td>
        `;
        cartBody.appendChild(tr);
      });

      totalAmountEl.textContent = total;
      cartTableWrap.style.display = 'block';

    }catch(err){
      console.error(err);
      cartEmptyEl.style.display='block';
      cartEmptyEl.textContent='è¼‰å…¥è³¼ç‰©è»Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š'+(err.message||err);
    }
  }

  btnSubmitOrder.addEventListener('click', async () => {
    msgEl.textContent = '';
    msgEl.classList.remove('msg-ok');

    if (!currentUser) { alert('å°šæœªç¢ºèªç™»å…¥ç‹€æ…‹ï¼Œè«‹é‡æ–°ç™»å…¥'); return; }
    if (!cartItems.length) { msgEl.textContent='è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„ï¼Œç„¡æ³•å»ºç«‹è¨‚å–®ã€‚'; return; }

    const shipName  = shipNameInput.value.trim();
    const shipPhone = shipPhoneInput.value.trim();
    const shipAddr  = shipAddrInput.value.trim();
    if (!shipName || !shipPhone || !shipAddr) {
      msgEl.textContent='è«‹å®Œæ•´å¡«å¯«æ”¶ä»¶äººå§“åã€é›»è©±èˆ‡åœ°å€ã€‚';
      return;
    }

    let total = 0;
    const orderItems = cartItems.map(it => {
      const sub = it.price * it.qty;
      total += sub;
      return {
        productId: it.id,
        title: it.title,
        price: it.price,
        qty: it.qty,
        image: it.image,
        sellerId: it.sellerId || null
      };
    });

    try{
      btnSubmitOrder.disabled = true;
      btnSubmitOrder.textContent = 'è¨‚å–®å»ºç«‹ä¸­...';

      const payload = {
        items: orderItems,
        totalAmount: total,
        shipName,
        shipPhone,
        shipAddress: shipAddr
      };

      const res = await fetch('/api/orders', {
        method: 'POST',
        headers: getJsonAuthHeader(),
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const err = await res.json().catch(()=>null);
        throw new Error(err && err.error ? err.error : 'å»ºç«‹è¨‚å–®å¤±æ•—');
      }

      await fetch('/api/cart/clear', { method: 'DELETE', headers: getAuthHeader() });

      msgEl.classList.add('msg-ok');
      msgEl.textContent = 'è¨‚å–®å»ºç«‹æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„è³¼è²·ã€‚';

      setTimeout(()=> window.location.href='buyer_orders.html', 800);
    }catch(err){
      console.error(err);
      msgEl.textContent = 'å»ºç«‹è¨‚å–®å¤±æ•—ï¼š' + (err.message || err);
    } finally {
      btnSubmitOrder.disabled = false;
      btnSubmitOrder.textContent = 'é€å‡ºè¨‚å–®';
    }
  });
</script>
</body>
</html>