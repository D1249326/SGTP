<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - å•†å“åˆ—è¡¨</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }

    header {
      background:#1f354d; color:#fff; padding:16px 24px;
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { margin:0; font-size:22px; }
    .header-right { font-size:14px; }
    .header-right a { color:#fff; text-decoration:none; margin-left:12px; }

    .container { max-width:960px; margin:24px auto; padding:0 16px; }

    /* ===== æœå°‹ + åˆ†é¡ ===== */
    .toolbar {
      display:flex;
      gap:10px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    .search-input, .filter-select {
      padding:8px;
      border-radius:4px;
      border:1px solid #ccc;
      background:#fff;
      font-size:14px;
    }
    .search-input { flex:1; min-width:220px; }
    .filter-select { width:180px; }

    /* ===== å•†å“å¡ç‰‡ ===== */
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap:16px;
    }

    .card {
      background:#fff;
      border-radius:8px;
      overflow:hidden;
      box-shadow:0 2px 6px rgba(0,0,0,0.12);
      display:flex;
      flex-direction:column;
      cursor:pointer;
      transition:0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow:0 4px 10px rgba(0,0,0,0.16);
    }

    .card-img-wrapper {
      width:100%;
      height:160px;
      background:#eee;
      overflow:hidden;
    }
    .card-img-wrapper img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .card-body {
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .card-title { font-weight:bold; font-size:16px; color:#333; }
    .card-price { color:#c0392b; font-weight:bold; }
    .card-desc {
      font-size:13px;
      color:#777;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* åˆ†é¡æ¨™ç±¤ */
    .card-cat {
      display:inline-block;
      font-size:12px;
      color:#1f354d;
      background:#eef3fa;
      padding:2px 8px;
      border-radius:999px;
      width:fit-content;
    }

    .multi-img-tip {
      font-size:11px;
      color:#999;
    }

    .btn-cart {
      margin-top:8px;
      padding:6px;
      background:#1f354d;
      color:white;
      border:none;
      border-radius:4px;
      font-size:13px;
      cursor:pointer;
    }
    .btn-cart:hover { background:#274563; }

    .empty {
      margin-top:30px;
      text-align:center;
      color:#777;
    }
  </style>
</head>

<body>

<header>
  <h1>SGTP äºŒæ‰‹å•†å“å¹³å° - å•†å“åˆ—è¡¨</h1>
  <div class="header-right">
    <a href="buyer_home.html">è²·å®¶è³‡æ–™</a>
    <a href="buyer_cart.html">ğŸ›’ è³¼ç‰©è»Š</a>
    <a href="buyer_orders.html">è¨‚å–®æŸ¥è©¢</a>
    <a href="buyer_login.html">ç™»å‡º</a>
  </div>
</header>

<div class="container">

  <!-- æœå°‹ / åˆ†é¡ -->
  <div class="toolbar">
    <input id="searchInput" class="search-input" placeholder="æœå°‹å•†å“åç¨±..." />
    <select id="categoryFilter" class="filter-select">
      <option value="å…¨éƒ¨">å…¨éƒ¨åˆ†é¡</option>
      <option value="é‹å‹•å™¨æ">é‹å‹•å™¨æ</option>
      <option value="3Cç”¢å“">3Cç”¢å“</option>
      <option value="è¡£æœ">è¡£æœ</option>
      <option value="ç”Ÿæ´»é›œå‹™">ç”Ÿæ´»é›œå‹™</option>
      <option value="æ›¸ç±">æ›¸ç±</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>
  </div>

  <div id="productGrid" class="grid"></div>
  <div id="emptyMsg" class="empty" style="display:none;">
    ç›®å‰æ²’æœ‰ä»»ä½•å•†å“
  </div>

</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    collection, getDocs, query, orderBy
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const productGrid = document.getElementById("productGrid");
  const emptyMsg = document.getElementById("emptyMsg");
  const searchInput = document.getElementById("searchInput");
  const categoryFilter = document.getElementById("categoryFilter");

  let allProducts = [];
  const FALLBACK_IMG = "https://via.placeholder.com/400x300?text=No+Image";

  onAuthStateChanged(auth, () => {});

  async function loadProducts() {
    const q = query(
      collection(db, "products"),
      orderBy("createdAt", "desc")
    );

    const snap = await getDocs(q);
    allProducts = [];

    snap.forEach(docSnap => {
      const d = docSnap.data();
      const images = Array.isArray(d.images) ? d.images : [];
      const cover =
        (images.length > 0 && images[0]) ||
        d.image ||
        FALLBACK_IMG;

      allProducts.push({
        id: docSnap.id,
        title: d.title || "æœªå‘½åå•†å“",
        price: typeof d.price === "number" ? d.price : 0,
        desc: d.desc || "",
        category: d.category || "å…¶ä»–",
        images,
        cover
      });
    });

    applyFilters();
  }

  function applyFilters() {
    const key = (searchInput.value || "").toLowerCase().trim();
    const cat = categoryFilter.value;

    const list = allProducts.filter(p => {
      const matchName = p.title.toLowerCase().includes(key);
      const matchCat = (cat === "å…¨éƒ¨") || (p.category === cat);
      return matchName && matchCat;
    });

    render(list);
  }

  function render(list) {
    productGrid.innerHTML = "";
    if (!list.length) {
      emptyMsg.style.display = "block";
      return;
    }
    emptyMsg.style.display = "none";

    list.forEach(p => {
      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="card-img-wrapper">
          <img src="${p.cover}" onerror="this.src='${FALLBACK_IMG}'">
        </div>
        <div class="card-body">
          <div class="card-title">${p.title}</div>
          <div class="card-price">NT$ ${p.price}</div>
          <div class="card-desc">${p.desc}</div>
          <div class="card-cat">${p.category}</div>
          ${p.images.length > 1
            ? `<div class="multi-img-tip">å…±æœ‰ ${p.images.length} å¼µåœ–ç‰‡</div>`
            : ""}
          <button class="btn-cart">æŸ¥çœ‹å•†å“</button>
        </div>
      `;

      card.onclick = () => {
        window.location.href = `buyer_product.html?pid=${p.id}`;
      };

      productGrid.appendChild(card);
    });
  }

  searchInput.addEventListener("input", applyFilters);
  categoryFilter.addEventListener("change", applyFilters);

  loadProducts();
</script>

</body>
</html>
