<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - 上架商品</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f7f7f7; }
    header {
      background:#1f354d; color:white; padding:18px 32px;
      font-size:22px; display:flex; justify-content:space-between; align-items:center;
    }
    .user-info { font-size:14px; }
    .btn {
      padding:6px 12px; border-radius:4px; border:none;
      cursor:pointer; font-size:14px; margin-left:8px;
    }
    .btn-light { background:#ffffff; color:#1f354d; }
    .btn-danger { background:#c0392b; color:white; }
    .container {
      max-width:600px; margin:30px auto; background:white;
      padding:24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    h2 { margin-top:0; }
    label { display:block; margin-top:12px; font-size:14px; }
    input, textarea {
      width:100%; padding:8px; margin-top:4px; box-sizing:border-box;
      border-radius:4px; border:1px solid #ccc;
      font-family:inherit;
    }
    textarea { min-height:100px; resize:vertical; }
    button.main-btn {
      margin-top:18px; width:100%; padding:10px;
      background:#1f354d; color:white; border:none; border-radius:4px;
      font-size:16px; cursor:pointer;
    }
    button.main-btn:hover { background:#28486a; }
    .error { margin-top:10px; color:#c0392b; font-size:14px; }
    .success { margin-top:10px; color:#27ae60; font-size:14px; }
    .back { margin-top:12px; font-size:14px; }
    .back a { color:#1f354d; text-decoration:none; }
  </style>
</head>
<body>

<header>
  <div>SGTP 二手商品平台 - 上架商品</div>
  <div class="user-info">
    <span id="userName">賣家</span>
    <button class="btn btn-light" onclick="location.href='seller_home.html'">回賣家首頁</button>
    <button id="btnLogout" class="btn btn-danger">登出</button>
  </div>
</header>

<div class="container">
  <h2>新增商品</h2>

  <label>商品名稱</label>
  <input id="title" type="text" />

  <label>價格 (NT$)</label>
  <input id="price" type="number" min="0" />

  <label>庫存數量</label>
  <input id="stock" type="number" min="0" />

  <label>商品圖片 URL</label>
  <input id="imageUrl" type="text"
         placeholder="貼上圖片網址，例如：https://example.com/photo.jpg" />

  <label>商品描述</label>
  <textarea id="desc"></textarea>

  <button id="btnAdd" class="main-btn">上架商品</button>

  <div id="msg" class="error"></div>
  <div id="ok" class="success"></div>

  <div class="back">
    <a href="seller_home.html">&lt; 返回賣家首頁</a>
  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    addDoc, collection, serverTimestamp,
    doc, getDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const $ = id => document.getElementById(id);
  const userNameSpan = $("userName");
  const btnLogout = $("btnLogout");
  const btnAdd = $("btnAdd");
  const msgEl = $("msg");
  const okEl = $("ok");

  let currentSellerId = null;

  // --- 確認登入者為 seller ---
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("請先登入賣家帳號");
      window.location.href = "seller_login.html";
      return;
    }

    try {
      const snap = await getDoc(doc(db, "users", user.uid));
      if (!snap.exists()) {
        alert("找不到使用者資料，請重新登入");
        await signOut(auth);
        window.location.href = "seller_login.html";
        return;
      }

      const data = snap.data();
      if (data.role !== "seller") {
        alert("此帳號不是賣家角色");
        await signOut(auth);
        window.location.href = "seller_login.html";
        return;
      }

      currentSellerId = user.uid;
      userNameSpan.textContent = data.name || data.email || "賣家";
    } catch (err) {
      console.error(err);
      alert("讀取使用者資料失敗：" + err.message);
      window.location.href = "seller_login.html";
    }
  });

  // --- 上架商品（只寫入 Firestore，image 用 URL） ---
  btnAdd.addEventListener("click", async () => {
    msgEl.textContent = "";
    okEl.textContent = "";

    if (!currentSellerId) {
      msgEl.textContent = "尚未確認賣家身分，請重新登入。";
      return;
    }

    const title = $("title").value.trim();
    const priceStr = $("price").value;
    const stockStr = $("stock").value;
    const imageUrl = $("imageUrl").value.trim();
    const desc = $("desc").value.trim();

    if (!title || !priceStr) {
      msgEl.textContent = "請至少填寫商品名稱與價格。";
      return;
    }

    const price = Number(priceStr);
    const stock = stockStr ? Number(stockStr) : 0;

    if (isNaN(price) || price < 0) {
      msgEl.textContent = "價格格式不正確。";
      return;
    }
    if (isNaN(stock) || stock < 0) {
      msgEl.textContent = "庫存格式不正確。";
      return;
    }

    // imageUrl 可以允許空白，如果你想強制要填，就把下面這段打開
    // if (!imageUrl) {
    //   msgEl.textContent = "請填寫商品圖片網址。";
    //   return;
    // }

    try {
      btnAdd.disabled = true;
      btnAdd.textContent = "上架中...";

      const productsRef = collection(db, "products");
      const docRef = await addDoc(productsRef, {
        title,
        price,
        stock,
        image: imageUrl || "",   // 存在 image 欄位
        desc,
        sellerId: currentSellerId,
        createdAt: serverTimestamp()
      });

      okEl.textContent = "上架成功！商品ID：" + docRef.id;

      // 清空輸入
      $("title").value = "";
      $("price").value = "";
      $("stock").value = "";
      $("imageUrl").value = "";
      $("desc").value = "";
    } catch (err) {
      console.error(err);
      msgEl.textContent = "上架失敗：" + err.message;
    } finally {
      btnAdd.disabled = false;
      btnAdd.textContent = "上架商品";
    }
  });

  // --- 登出 ---
  btnLogout.addEventListener("click", async () => {
    try {
      await signOut(auth);
      window.location.href = "seller_login.html";
    } catch (err) {
      console.error(err);
      alert("登出失敗：" + err.message);
    }
  });
</script>

</body>
</html>
