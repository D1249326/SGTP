<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - ä¸Šæ¶å•†å“</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f7f7f7; }
    
    /* Header */
    header {
      background: #2c3e50; /* æ·±è—è‰² */
      color: white;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header-logo {
      font-size: 20px;
      font-weight: bold;
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .icon-btn {
      color: white;
      text-decoration: none;
      font-size: 24px;
      cursor: pointer;
      position: relative;
    }
    .icon-btn:hover { opacity: 0.8; }

    /* ä¸‹æ‹‰é¸å–® */
    .user-menu {
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      height: 60px;
    }
    .user-name { font-size: 16px; font-weight: bold; margin-right: 5px; }
    .user-avatar {
      width: 32px; height: 32px;
      background-color: #bdc3c7;
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      font-size: 14px; color: #2c3e50;
      margin-right: 8px;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: white;
      min-width: 150px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 0 0 4px 4px;
      overflow: hidden;
      z-index: 1000;
    }
    .dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
    }
    .dropdown-content a:hover { background-color: #f5f5f5; color: #2c3e50; }
    .user-menu:hover .dropdown-content { display: block; }

    /* å®¹å™¨èˆ‡è¡¨å–® */
    .container {
      max-width:600px; margin:30px auto; background:white;
      padding:24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    h2 { margin-top:0; }
    label { display:block; margin-top:12px; font-size:14px; }
    input, textarea, select {
      width:100%; padding:8px; margin-top:4px; box-sizing:border-box;
      border-radius:4px; border:1px solid #ccc;
      font-family:inherit; font-size:14px;
    }
    textarea { min-height:100px; resize:vertical; }
    button.main-btn {
      margin-top:18px; width:100%; padding:10px;
      background:#1f354d; color:white; border:none; border-radius:4px;
      font-size:16px; cursor:pointer;
    }
    button.main-btn:hover { background:#28486a; }
    .error { margin-top:10px; color:#c0392b; font-size:14px; }
    .success { margin-top:10px; color:#27ae60; font-size:14px; }
    .back { margin-top:12px; font-size:14px; }
    .back a { color:#1f354d; text-decoration:none; }
    .hint { font-size:12px; color:#777; margin-top:2px; }
  </style>
</head>
<body>

<header>
  <a href="seller_home.html" class="header-logo">SGTP-è³£å®¶ä¸­å¿ƒ</a>
  <div class="header-right">
    <a href="seller_chats.html" class="icon-btn" title="èŠèŠ">ğŸ’¬</a>
    <div class="user-menu">
      <div class="user-avatar">S</div>
      <span class="user-name" id="headerUserName">è³£å®¶</span>
      <span>â–¼</span>
      <div class="dropdown-content">
        <a href="seller_profile.html">æˆ‘çš„è³‡æ–™</a>
        <a href="#" id="headerLogoutBtn">ç™»å‡º</a>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <h2>æ–°å¢å•†å“</h2>

  <label>å•†å“åç¨±</label>
  <input id="title" type="text" />

  <label>å•†å“åˆ†é¡</label>
  <select id="category">
    <option value="">è«‹é¸æ“‡åˆ†é¡</option>
    <option value="é‹å‹•å™¨æ">é‹å‹•å™¨æ</option>
    <option value="3Cç”¢å“">3Cç”¢å“</option>
    <option value="è¡£æœ">è¡£æœ</option>
    <option value="ç”Ÿæ´»é›œå‹™">ç”Ÿæ´»é›œå‹™</option>
    <option value="æ›¸ç±">æ›¸ç±</option>
    <option value="å…¶ä»–">å…¶ä»–</option>
  </select>

  <label>åƒ¹æ ¼ (NT$)</label>
  <input id="price" type="number" min="0" />

  <label>åº«å­˜æ•¸é‡</label>
  <input id="stock" type="number" min="0" />

  <label>å•†å“åœ–ç‰‡ï¼ˆå¯å¤šå¼µï¼‰</label>
  <input
    type="file"
    id="imageFiles"
    accept="image/*"
    multiple
  />
  <div class="hint">
    å¯ä¸€æ¬¡é¸æ“‡å¤šå¼µåœ–ç‰‡ï¼Œç¬¬ä¸€å¼µæœƒç•¶ä½œå°é¢åœ–ã€‚
  </div>

  <div id="imagePreview" style="display:flex; gap:8px; margin-top:8px;"></div>

  <label>å•†å“æè¿°</label>
  <textarea id="desc"></textarea>

  <button id="btnAdd" class="main-btn">ä¸Šæ¶å•†å“</button>

  <div id="msg" class="error"></div>
  <div id="ok" class="success"></div>

</div>

<script>
  const $ = id => document.getElementById(id);

  // âœ… [ä¿®æ­£] é€™è£¡æ”¹ç‚ºæ­£ç¢ºçš„ HTML ID (headerUserName, headerLogoutBtn)
  const userNameSpan = $("headerUserName");
  const btnLogout = $("headerLogoutBtn");
  
  const btnAdd = $("btnAdd");
  const msgEl = $("msg");
  const okEl = $("ok");

  const fileInput = $("imageFiles");
  const preview = $("imagePreview");

  let currentSellerId = null;

  function getAuthHeader(){
    const t = localStorage.getItem('token');
    return t ? { 'Authorization':'Bearer ' + t } : {};
  }

  /* ===============================
     é©—è­‰ç™»å…¥è€…ç‚ºè³£å®¶
  ================================ */
  (async function(){
    try{
      const res = await fetch('/api/auth/me', { headers: getAuthHeader() });
      if (!res.ok) {
        alert('è«‹å…ˆç™»å…¥è³£å®¶å¸³è™Ÿ');
        window.location.href='seller_login.html';
        return;
      }
      const user = await res.json();
      if (!user || user.role !== 'seller') {
        alert('æ­¤å¸³è™Ÿä¸æ˜¯è³£å®¶è§’è‰²');
        localStorage.removeItem('token');
        window.location.href='seller_login.html';
        return;
      }
      currentSellerId = user.id;
      
      // ç¢ºä¿å…ƒç´ å­˜åœ¨å†è³¦å€¼ï¼Œé¿å…å ±éŒ¯
      if(userNameSpan) {
        userNameSpan.textContent = user.name || user.email || 'è³£å®¶';
      }
    } catch (err) {
      console.error(err);
      alert('è®€å–ä½¿ç”¨è€…è³‡æ–™å¤±æ•—');
      // window.location.href='seller_login.html'; // æš«æ™‚è¨»è§£æ–¹ä¾¿é™¤éŒ¯
    }
  })();

  /* ===============================
     ä¸Šå‚³åœ–ç‰‡
  ================================ */
  async function uploadFile(file){
    const form = new FormData();
    form.append('file', file);

    const res = await fetch('/api/uploads', {
      method: 'POST',
      headers: getAuthHeader(),
      body: form
    });

    if (!res.ok) throw new Error('Upload failed');
    const data = await res.json();
    return data.url;
  }

  /* ===============================
     åœ–ç‰‡é¸æ“‡ + é è¦½ + ä¸Šå‚³
  ================================ */
  fileInput.addEventListener('change', async (ev) => {
    const files = Array.from(ev.target.files || []);
    preview.innerHTML = ""; // é‡æ–°é¸æ“‡æ™‚æ¸…ç©º

    for (const f of files) {
      const img = document.createElement('img');
      img.style.width = '80px';
      img.style.height = '80px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '4px';
      img.style.opacity = '0.6';

      img.src = URL.createObjectURL(f);
      preview.appendChild(img);

      try {
        const url = await uploadFile(f);
        img.dataset.url = url;
        img.style.opacity = '1';
      } catch (err) {
        console.error(err);
        img.style.opacity = '0.3';
      }
    }
  });

  /* ===============================
     ä¸Šæ¶å•†å“
  ================================ */
  btnAdd.addEventListener("click", async () => {
    msgEl.textContent = "";
    okEl.textContent = "";

    if (!currentSellerId) {
      msgEl.textContent = "å°šæœªç¢ºèªè³£å®¶èº«åˆ†";
      return;
    }

    const title = $("title").value.trim();
    const category = $("category").value;
    const price = Number($("price").value);
    const stock = Number($("stock").value || 0);
    const desc = $("desc").value.trim();

    if (!title || isNaN(price)) {
      msgEl.textContent = "è«‹å¡«å¯«æ­£ç¢ºçš„å•†å“åç¨±èˆ‡åƒ¹æ ¼";
      return;
    }
    if (!category) {
      msgEl.textContent = "è«‹é¸æ“‡å•†å“åˆ†é¡";
      return;
    }

    const images = Array.from(
      document.querySelectorAll('#imagePreview img[data-url]')
    ).map(img => img.dataset.url);

    try {
      btnAdd.disabled = true;
      btnAdd.textContent = "ä¸Šæ¶ä¸­...";

      const payload = {
        title,
        category,
        description: desc,
        price,
        stock: stock,
        quantity: stock,
        image: images[0] || null,  // å°é¢
        images: images.length ? images : null
      };

      const res = await fetch('/api/seller/products', {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          ...getAuthHeader()
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'ä¸Šæ¶å¤±æ•—');

      okEl.textContent = "ä¸Šæ¶æˆåŠŸï¼å•†å“IDï¼š" + data.id;

      // æ¸…ç©ºè¡¨å–®
      $("title").value = "";
      $("category").value = "";
      $("price").value = "";
      $("stock").value = "";
      $("desc").value = "";
      preview.innerHTML = "";
      fileInput.value = ""; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥

    } catch (err) {
      msgEl.textContent = err.message;
    } finally {
      btnAdd.disabled = false;
      btnAdd.textContent = "ä¸Šæ¶å•†å“";
      window.location.href = 'seller_home.html'; 
    }
  });

  /* ===============================
     ç™»å‡º
  ================================ */
  if (btnLogout) {
    btnLogout.addEventListener("click", (e) => {
        e.preventDefault();
        localStorage.removeItem('token');
        window.location.href = 'seller_login.html';
    });
  }
</script>

</body>
</html>