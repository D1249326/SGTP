<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - 結帳</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
    header {
      background:#1f354d; color:white; padding:16px 24px;
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { margin:0; font-size:22px; }
    header .right button { margin-left:8px; }

    .btn { padding:8px 14px; border:none; border-radius:4px; cursor:pointer; font-size:14px; }
    .btn-light { background:#ffffff; color:#1f354d; }
    .btn-danger { background:#c0392b; color:white; }
    .btn-primary { background:#1f354d; color:white; }

    .container {
      max-width:960px; margin:24px auto;
      background:white; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
      padding:24px;
    }

    h2 { margin-top:0; }
    .section { margin-top:16px; }

    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:8px; }
    th { background:#f0f3f6; }
    td.price, td.qty, td.subtotal { text-align:right; }

    .total-row td { font-weight:bold; border-top:2px solid #ccc; }

    .form-row { margin:8px 0; }
    .form-row label { display:inline-block; width:90px; color:#555; }
    .form-row input {
      width:260px; padding:6px 8px;
      border-radius:4px; border:1px solid #ccc;
    }

    .msg { margin-top:10px; font-size:14px; color:#c0392b; }
    .msg-ok { color:#27ae60; }
    .empty { margin-top:10px; color:#777; }
  </style>
</head>

<body>
<header>
  <h1>SGTP 二手商品平台 - 結帳</h1>
  <div class="right">
    <button class="btn btn-light" onclick="location.href='buyer_cart.html'">← 回購物車</button>
    <button class="btn btn-light" onclick="location.href='buyer_shop.html'">逛逛其他商品</button>
    <button id="btnLogout" class="btn btn-danger">登出</button>
  </div>
</header>

<div class="container">
  <h2>訂單確認</h2>

  <div class="section">
    <h3>購物車內容</h3>
    <div id="cartEmpty" class="empty" style="display:none;">購物車目前是空的。</div>
    <div id="cartTableWrap" style="display:none;">
      <table>
        <thead>
          <tr>
            <th>商品名稱</th>
            <th class="price">單價</th>
            <th class="qty">數量</th>
            <th class="subtotal">小計</th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="3" style="text-align:right;">總金額</td>
            <td id="totalAmount">0</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="section">
    <h3>收件資訊</h3>
    <div class="form-row">
      <label>收件人</label><input id="shipName">
    </div>
    <div class="form-row">
      <label>電話</label><input id="shipPhone">
    </div>
    <div class="form-row">
      <label>地址</label><input id="shipAddress" style="width:360px;">
    </div>
  </div>

  <div class="section">
    <button id="btnSubmitOrder" class="btn btn-primary">送出訂單</button>
    <div id="msg" class="msg"></div>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut }
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  collection, doc, getDoc, getDocs,
  addDoc, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const cartBody = document.getElementById("cartBody");
const cartEmpty = document.getElementById("cartEmpty");
const cartWrap = document.getElementById("cartTableWrap");
const totalEl = document.getElementById("totalAmount");
const msgEl = document.getElementById("msg");

const shipNameInput = document.getElementById("shipName");
const shipPhoneInput = document.getElementById("shipPhone");
const shipAddressInput = document.getElementById("shipAddress");
const btnLogout = document.getElementById("btnLogout");

let cartItems = [];
let currentUser = null;

btnLogout.onclick = async () => {
  await signOut(auth);
  location.href = "buyer_login.html";
};

onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "buyer_login.html";
  currentUser = user;

  // ✅ 自動帶入買家資料（你要的功能）
  const userSnap = await getDoc(doc(db, "users", user.uid));
  if (userSnap.exists()) {
    const u = userSnap.data();
    shipNameInput.value = u.name || "";
    shipPhoneInput.value = u.phone || "";
    shipAddressInput.value = u.address || "";
  }

  await loadCartItems();
});

async function loadCartItems() {
  cartItems = [];
  cartBody.innerHTML = "";
  let total = 0;

  const snap = await getDocs(collection(db, "carts", currentUser.uid, "items"));
  if (snap.empty) {
    cartEmpty.style.display = "block";
    return;
  }

  for (const d of snap.docs) {
    const data = d.data();

    // ✅ 關鍵：從 products 回查 sellerId
    let sellerId = null;
    const prodSnap = await getDoc(doc(db, "products", d.id));
    if (prodSnap.exists()) {
      sellerId = prodSnap.data().sellerId || null;
    }

    const item = {
      productId: d.id,
      title: data.title,
      price: data.price,
      qty: data.qty,
      sellerId
    };

    cartItems.push(item);
    const sub = item.price * item.qty;
    total += sub;

    cartBody.innerHTML += `
      <tr>
        <td>${item.title}</td>
        <td class="price">${item.price}</td>
        <td class="qty">${item.qty}</td>
        <td class="subtotal">${sub}</td>
      </tr>`;
  }

  totalEl.textContent = total;
  cartWrap.style.display = "block";
}

document.getElementById("btnSubmitOrder").onclick = async () => {
  const sellerIds = [...new Set(cartItems.map(i => i.sellerId).filter(Boolean))];
  const total = cartItems.reduce((s,i)=>s+i.price*i.qty,0);

  await addDoc(collection(db,"orders"),{
    buyerId: currentUser.uid,
    buyerEmail: currentUser.email,
    sellerIds,
    sellerId: sellerIds.length===1 ? sellerIds[0] : null,
    shipName: shipNameInput.value,
    shipPhone: shipPhoneInput.value,
    shipAddress: shipAddressInput.value,
    items: cartItems,
    totalAmount: total,
    status:"pending",
    createdAt: serverTimestamp()
  });

  const itemsSnap = await getDocs(collection(db,"carts",currentUser.uid,"items"));
  itemsSnap.forEach(d=>deleteDoc(d.ref));

  location.href="buyer_orders.html";
};
</script>
</body>
</html>
ss