<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - 購物車</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
    header {
      background:#1f354d; color:#fff; padding:16px 24px;
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { margin:0; font-size:22px; }
    .header-right a { color:#fff; text-decoration:none; margin-left:12px; font-size:14px; }

    .container { max-width:960px; margin:24px auto; padding:0 16px; }

    .card {
      background:#fff; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
      padding:16px 18px;
    }

    table {
      width:100%; border-collapse:collapse;
      margin-top:8px;
    }
    th, td {
      padding:8px 6px; text-align:left; font-size:14px;
      border-bottom:1px solid #eee;
      vertical-align:middle;
    }
    th { background:#f0f0f0; font-weight:bold; }

    .prod-img {
      width:64px; height:64px; object-fit:cover; border-radius:4px; background:#eee;
    }
    .qty-controls {
      display:flex; align-items:center; gap:4px;
    }
    .qty-btn {
      width:24px; height:24px; border-radius:4px; border:none;
      cursor:pointer; background:#bdc3c7; color:#2c3e50; font-size:16px;
      display:flex; align-items:center; justify-content:center;
    }
    .qty-input {
      width:40px; text-align:center; border:1px solid #ccc;
      border-radius:4px; padding:3px;
    }
    .btn-remove {
      padding:5px 10px; border-radius:4px; border:none;
      background:#e74c3c; color:#fff; font-size:13px; cursor:pointer;
    }

    .summary {
      margin-top:16px; display:flex; justify-content:space-between; align-items:center;
      flex-wrap:wrap; gap:10px;
    }
    .total {
      font-size:18px; font-weight:bold; color:#c0392b;
    }
    .btn-row {
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .btn {
      padding:8px 14px; border-radius:4px; border:none;
      cursor:pointer; font-size:14px;
    }
    .btn-back { background:#bdc3c7; color:#2c3e50; }
    .btn-checkout { background:#1f354d; color:#fff; }

    .empty {
      margin-top:20px; text-align:center; color:#777;
    }
    .msg {
      margin-top:10px; font-size:14px; color:#c0392b;
    }
    .msg-ok { color:#27ae60; }
  </style>
</head>
<body>
<header>
  <h1>購物車</h1>
  <div class="header-right">
    <a href="buyer_shop.html">繼續逛商品</a>
    <a href="buyer_home.html">買家資料</a>
  </div>
</header>

<div class="container">
  <div class="card">
    <div id="loading">載入購物車中...</div>
    <div id="emptyMsg" class="empty" style="display:none;">
      購物車目前是空的，去 <a href="buyer_shop.html">逛逛商品</a> 吧！
    </div>

    <table id="cartTable" style="display:none;">
      <thead>
        <tr>
          <th>商品</th>
          <th>名稱</th>
          <th>單價</th>
          <th>數量</th>
          <th>小計</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="cartBody">
      </tbody>
    </table>

    <div class="summary" id="summary" style="display:none;">
      <div class="total" id="totalPrice">總金額：NT$ 0</div>
      <div class="btn-row">
        <button class="btn btn-back" onclick="location.href='buyer_shop.html'">
          &lt; 繼續逛逛商品
        </button>
        <button onclick="location.href='buyer_checkout.html'">前往結帳</button>
        </button>
      </div>
    </div>

    <div id="msg" class="msg"></div>
  </div>
</div>

<script>
  const loadingEl   = document.getElementById('loading');
  const emptyMsgEl  = document.getElementById('emptyMsg');
  const cartTable   = document.getElementById('cartTable');
  const cartBody    = document.getElementById('cartBody');
  const summaryEl   = document.getElementById('summary');
  const totalPriceEl= document.getElementById('totalPrice');
  const msgEl       = document.getElementById('msg');
  const btnCheckout = document.getElementById('btnCheckout');

  const FALLBACK_IMG = 'https://via.placeholder.com/80x80?text=No+Image';

  let currentUser = null;

  function getAuthHeader(){ const t = localStorage.getItem('token'); return t?{ 'Authorization':'Bearer '+t, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' }; }

  (async function(){
    try{
      const me = await fetch('/api/auth/me', { headers: getAuthHeader() });
      if (!me.ok) { alert('請先登入買家帳號再查看購物車。'); window.location.href='buyer_login.html'; return; }
      currentUser = await me.json();
      await loadCart();
    }catch(err){ console.error(err); alert('請先登入買家帳號再查看購物車。'); window.location.href='buyer_login.html'; }
  })();

  async function loadCart(){
    loadingEl.style.display='block'; msgEl.textContent=''; msgEl.classList.remove('msg-ok'); cartBody.innerHTML=''; cartTable.style.display='none'; summaryEl.style.display='none'; emptyMsgEl.style.display='none';
    try{
      const res = await fetch('/api/cart', { headers: getAuthHeader() });
      if (!res.ok) { loadingEl.style.display='none'; emptyMsgEl.style.display='block'; totalPriceEl.textContent='總金額：NT$ 0'; return; }
      const rows = await res.json(); if (!rows || rows.length===0) { loadingEl.style.display='none'; emptyMsgEl.style.display='block'; totalPriceEl.textContent='總金額：NT$ 0'; return; }
      let total = 0;
      rows.forEach(r => {
        const productId = r.productId; const title = r.title || '未命名商品'; const price = +r.price || 0; const qty = +r.qty || 0; const image = r.image || FALLBACK_IMG; const subtotal = price * qty; total += subtotal;
        const tr = document.createElement('tr');
        const tdImg = document.createElement('td'); const img = document.createElement('img'); img.src=image; img.alt=title; img.className='prod-img'; img.onerror=()=>img.src=FALLBACK_IMG; tdImg.appendChild(img);
        const tdTitle = document.createElement('td'); tdTitle.textContent = title;
        const tdPrice = document.createElement('td'); tdPrice.textContent = 'NT$ ' + price;
        const tdQty = document.createElement('td'); const qtyBox = document.createElement('div'); qtyBox.className='qty-controls'; const btnMinus = document.createElement('button'); btnMinus.className='qty-btn'; btnMinus.textContent='－'; btnMinus.addEventListener('click', ()=> updateQuantity(productId, -1)); const qtyInput = document.createElement('input'); qtyInput.className='qty-input'; qtyInput.type='text'; qtyInput.value=qty; qtyInput.readOnly=true; const btnPlus = document.createElement('button'); btnPlus.className='qty-btn'; btnPlus.textContent='＋'; btnPlus.addEventListener('click', ()=> updateQuantity(productId, +1)); qtyBox.appendChild(btnMinus); qtyBox.appendChild(qtyInput); qtyBox.appendChild(btnPlus); tdQty.appendChild(qtyBox);
        const tdSub = document.createElement('td'); tdSub.textContent = 'NT$ ' + subtotal;
        const tdAct = document.createElement('td'); const btnRemove = document.createElement('button'); btnRemove.className='btn-remove'; btnRemove.textContent='移除'; btnRemove.addEventListener('click', ()=> removeItem(productId)); tdAct.appendChild(btnRemove);
        tr.appendChild(tdImg); tr.appendChild(tdTitle); tr.appendChild(tdPrice); tr.appendChild(tdQty); tr.appendChild(tdSub); tr.appendChild(tdAct); cartBody.appendChild(tr);
      });
      totalPriceEl.textContent = '總金額：NT$ ' + total; loadingEl.style.display='none'; cartTable.style.display='table'; summaryEl.style.display='flex';
    }catch(err){ console.error(err); loadingEl.style.display='none'; msgEl.textContent = '載入購物車失敗：' + (err.message||err); }
  }

  async function updateQuantity(productId, delta){
    try{
      // fetch existing to compute new qty
      const res = await fetch('/api/cart', { headers: getAuthHeader() }); if (!res.ok) throw new Error('讀取購物車失敗'); const rows = await res.json(); const item = rows.find(r=>r.productId==productId); if (!item) { await loadCart(); return; }
      const newQty = (item.qty || 0) + delta; if (newQty <= 0) { await fetch('/api/cart/items/' + encodeURIComponent(productId), { method:'DELETE', headers: getAuthHeader() }); } else { await fetch('/api/cart/items/' + encodeURIComponent(productId), { method:'PUT', headers: getAuthHeader(), body: JSON.stringify({ qty: newQty }) }); }
      await loadCart();
    }catch(err){ console.error(err); msgEl.textContent = '更新數量失敗：' + (err.message||err); }
  }

  async function removeItem(productId){ if (!confirm('確定要從購物車移除這項商品嗎？')) return; try{ const res = await fetch('/api/cart/items/' + encodeURIComponent(productId), { method: 'DELETE', headers: getAuthHeader() }); if (!res.ok) throw new Error('移除失敗'); msgEl.classList.add('msg-ok'); msgEl.textContent='已移除該商品。'; await loadCart(); }catch(err){ console.error(err); msgEl.classList.remove('msg-ok'); msgEl.textContent = '移除失敗：' + (err.message||err); } }

  btnCheckout.addEventListener('click', ()=>{ window.location.href='buyer_checkout.html'; });
</script>

</body>
</html>
