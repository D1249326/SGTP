<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - è³¼ç‰©è»Š</title>
  <style>
    /* =========================================
       1. å…¨å±€èˆ‡ Header æ¨£å¼ (çµ±ä¸€é¢¨æ ¼)
       ========================================= */
    body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
    
    header {
      background: #1f354d;
      color: white;
      padding: 10px 24px;
      display: flex;
      align-items: center;
      gap: 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      height: 50px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .logo {
      font-size: 28px;
      font-weight: bold;
      color: white;
      text-decoration: none;
      white-space: nowrap;
      margin-right: 10px;
    }

    .header-search {
      flex: 1;
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      position: relative;
    }
    .header-search input {
      width: 100%;
      padding: 8px 36px 8px 12px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      outline: none;
    }
    .search-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      pointer-events: none;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-left: auto;
    }

    .icon-btn {
      color: white;
      text-decoration: none;
      font-size: 24px;
      transition: opacity 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .icon-btn:hover { opacity: 0.8; }

    .user-menu {
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      height: 50px;
      padding-left: 8px;
    }
    .user-name { font-size: 16px; font-weight: bold; color: white; }
    .user-name::after { content: ' â–¼'; font-size: 10px; margin-left: 6px; vertical-align: middle; }
    
    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: white;
      min-width: 140px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 0 0 4px 4px;
      overflow: hidden;
      z-index: 1001;
    }
    .dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
    }
    .dropdown-content a:hover { background-color: #f5f5f5; color: #1f354d; }
    .user-menu:hover .dropdown-content { display: block; }
    .user-avatar { width: 30px; height: 30px; background-color: #bdc3c7; border-radius: 50%;display: flex; justify-content: center; align-items: center; font-size: 14px; color: #2c3e50;margin-right: 8px;}

    /* =========================================
       2. è³¼ç‰©è»Šé é¢æ¨£å¼
       ========================================= */
    .container { max-width:960px; margin:24px auto; padding:0 16px; }
    
    h2 { margin-top: 0; color: #333; }

    .card {
      background:#fff; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
      padding:16px 18px;
    }

    table {
      width:100%; border-collapse:collapse;
      margin-top:8px;
    }
    th, td {
      padding:8px 6px; text-align:left; font-size:14px;
      border-bottom:1px solid #eee;
      vertical-align:middle;
    }
    th { background:#f0f0f0; font-weight:bold; }

    .prod-img {
      width:64px; height:64px; object-fit:cover; border-radius:4px; background:#eee;
    }
    .qty-controls {
      display:flex; align-items:center; gap:4px;
    }
    .qty-btn {
      width:24px; height:24px; border-radius:4px; border:none;
      cursor:pointer; background:#bdc3c7; color:#2c3e50; font-size:16px;
      display:flex; align-items:center; justify-content:center;
    }
    .qty-input {
      width:40px; text-align:center; border:1px solid #ccc;
      border-radius:4px; padding:3px;
    }
    .btn-remove {
      padding:5px 10px; border-radius:4px; border:none;
      background:#e74c3c; color:#fff; font-size:13px; cursor:pointer;
    }

    .summary {
      margin-top:16px; display:flex; justify-content:space-between; align-items:center;
      flex-wrap:wrap; gap:10px;
    }
    .total {
      font-size:18px; font-weight:bold; color:#c0392b;
    }
    .btn-row {
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .btn {
      padding:8px 14px; border-radius:4px; border:none;
      cursor:pointer; font-size:14px;
    }
    .btn-back { background:#bdc3c7; color:#2c3e50; }
    .btn-checkout { background:#1f354d; color:#fff; }

    .empty {
      margin-top:20px; text-align:center; color:#777;
    }
    .msg {
      margin-top:10px; font-size:14px; color:#c0392b;
    }
    .msg-ok { color:#27ae60; }
  </style>
</head>
<body>

  <header>
    <a href="buyer_shop.html" class="logo">SGTP</a>
    
    <div class="header-search">
      <input id="navSearch" type="text" placeholder="æœå°‹å•†å“åç¨±..." />
    </div>

    <div class="header-right">
      <a href="buyer_cart.html" class="icon-btn" title="è³¼ç‰©è»Š">ğŸ›’</a>
      <a href="buyer_chats.html" class="icon-btn" title="èŠå¤©å®¤">ğŸ’¬</a>
      
      <div class="user-menu">
        <div class="user-avatar">B</div>
        <span class="user-name" id="headerUser">è¼‰å…¥ä¸­...</span>
        <div class="dropdown-content">
          <a href="buyer_home.html">æˆ‘çš„è³‡æ–™</a>
          <a href="buyer_orders.html">è¨‚å–®æŸ¥è©¢</a>
          <a href="#" id="headerLogoutBtn">ç™»å‡º</a>
        </div>
      </div>
    </div>
  </header>

<div class="container">
  <h2>æˆ‘çš„è³¼ç‰©è»Š</h2>
  <div class="card">
    <div id="loading">è¼‰å…¥è³¼ç‰©è»Šä¸­...</div>
    <div id="emptyMsg" class="empty" style="display:none;">
      è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„ï¼Œå» <a href="buyer_shop.html">é€›é€›å•†å“</a> å§ï¼
    </div>

    <table id="cartTable" style="display:none;">
      <thead>
        <tr>
          <th>å•†å“</th>
          <th>åç¨±</th>
          <th>å–®åƒ¹</th>
          <th>æ•¸é‡</th>
          <th>å°è¨ˆ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="cartBody">
      </tbody>
    </table>

    <div class="summary" id="summary" style="display:none;">
      <div class="total" id="totalPrice">ç¸½é‡‘é¡ï¼šNT$ 0</div>
      <div class="btn-row">
        <button id="btnCheckout" class="btn btn-checkout">å‰å¾€çµå¸³</button>
      </div>
    </div>

    <div id="msg" class="msg"></div>
  </div>
</div>

<script>
  /* ========== 1. Header é‚è¼¯ ========== */
  const headerUserEl = document.getElementById('headerUser');
  const headerLogoutBtn = document.getElementById('headerLogoutBtn');
  const navSearch = document.getElementById('navSearch');

  // ç™»å‡ºåŠŸèƒ½
  if(headerLogoutBtn){
    headerLogoutBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      localStorage.removeItem('token');
      alert('å·²ç™»å‡º');
      window.location.href = 'buyer_login.html';
    });
  }

  // æœå°‹æ¡†åŠŸèƒ½ (æŒ‰ä¸‹ Enter è·³è½‰)
  if(navSearch){
    navSearch.addEventListener('keypress', (e)=>{
      if(e.key === 'Enter'){
        const val = navSearch.value.trim();
        if(val) {
          window.location.href = 'buyer_shop.html?q=' + encodeURIComponent(val);
        }
      }
    });
  }

  /* ========== 2. è³¼ç‰©è»Šé‚è¼¯ ========== */
  const loadingEl   = document.getElementById('loading');
  const emptyMsgEl  = document.getElementById('emptyMsg');
  const cartTable   = document.getElementById('cartTable');
  const cartBody    = document.getElementById('cartBody');
  const summaryEl   = document.getElementById('summary');
  const totalPriceEl= document.getElementById('totalPrice');
  const msgEl       = document.getElementById('msg');
  const btnCheckout = document.getElementById('btnCheckout');

  const FALLBACK_IMG = 'https://via.placeholder.com/80x80?text=No+Image';

  let currentUser = null;

  function getAuthHeader(){ const t = localStorage.getItem('token'); return t?{ 'Authorization':'Bearer '+t, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' }; }

  (async function(){
    try{
      const me = await fetch('/api/auth/me', { headers: getAuthHeader() });
      if (!me.ok) { alert('è«‹å…ˆç™»å…¥è²·å®¶å¸³è™Ÿå†æŸ¥çœ‹è³¼ç‰©è»Šã€‚'); window.location.href='buyer_login.html'; return; }
      
      currentUser = await me.json();
      
      // âœ… æ›´æ–° Header é¡¯ç¤ºåå­—
      if(headerUserEl) headerUserEl.textContent = currentUser.name || currentUser.email;

      await loadCart();
    }catch(err){ console.error(err); alert('è«‹å…ˆç™»å…¥è²·å®¶å¸³è™Ÿå†æŸ¥çœ‹è³¼ç‰©è»Šã€‚'); window.location.href='buyer_login.html'; }
  })();

  async function loadCart(){
    loadingEl.style.display='block'; msgEl.textContent=''; msgEl.classList.remove('msg-ok'); cartBody.innerHTML=''; cartTable.style.display='none'; summaryEl.style.display='none'; emptyMsgEl.style.display='none';
    try{
      const res = await fetch('/api/cart', { headers: getAuthHeader() });
      if (!res.ok) { loadingEl.style.display='none'; emptyMsgEl.style.display='block'; totalPriceEl.textContent='ç¸½é‡‘é¡ï¼šNT$ 0'; return; }
      const rows = await res.json(); if (!rows || rows.length===0) { loadingEl.style.display='none'; emptyMsgEl.style.display='block'; totalPriceEl.textContent='ç¸½é‡‘é¡ï¼šNT$ 0'; return; }
      let total = 0;
      rows.forEach(r => {
        const productId = r.productId; const title = r.title || 'æœªå‘½åå•†å“'; const price = +r.price || 0; const qty = +r.qty || 0; const image = r.image || FALLBACK_IMG; const subtotal = price * qty; total += subtotal;
        const tr = document.createElement('tr');
        const tdImg = document.createElement('td'); const img = document.createElement('img'); img.src=image; img.alt=title; img.className='prod-img'; img.onerror=()=>img.src=FALLBACK_IMG; tdImg.appendChild(img);
        const tdTitle = document.createElement('td'); tdTitle.textContent = title;
        const tdPrice = document.createElement('td'); tdPrice.textContent = 'NT$ ' + price;
        const tdQty = document.createElement('td'); const qtyBox = document.createElement('div'); qtyBox.className='qty-controls'; const btnMinus = document.createElement('button'); btnMinus.className='qty-btn'; btnMinus.textContent='ï¼'; btnMinus.addEventListener('click', ()=> updateQuantity(productId, -1)); const qtyInput = document.createElement('input'); qtyInput.className='qty-input'; qtyInput.type='text'; qtyInput.value=qty; qtyInput.readOnly=true; const btnPlus = document.createElement('button'); btnPlus.className='qty-btn'; btnPlus.textContent='ï¼‹'; btnPlus.addEventListener('click', ()=> updateQuantity(productId, +1)); qtyBox.appendChild(btnMinus); qtyBox.appendChild(qtyInput); qtyBox.appendChild(btnPlus); tdQty.appendChild(qtyBox);
        const tdSub = document.createElement('td'); tdSub.textContent = 'NT$ ' + subtotal;
        const tdAct = document.createElement('td'); const btnRemove = document.createElement('button'); btnRemove.className='btn-remove'; btnRemove.textContent='ç§»é™¤'; btnRemove.addEventListener('click', ()=> removeItem(productId)); tdAct.appendChild(btnRemove);
        tr.appendChild(tdImg); tr.appendChild(tdTitle); tr.appendChild(tdPrice); tr.appendChild(tdQty); tr.appendChild(tdSub); tr.appendChild(tdAct); cartBody.appendChild(tr);
      });
      totalPriceEl.textContent = 'ç¸½é‡‘é¡ï¼šNT$ ' + total; loadingEl.style.display='none'; cartTable.style.display='table'; summaryEl.style.display='flex';
    }catch(err){ console.error(err); loadingEl.style.display='none'; msgEl.textContent = 'è¼‰å…¥è³¼ç‰©è»Šå¤±æ•—ï¼š' + (err.message||err); }
  }

  async function updateQuantity(productId, delta){
    msgEl.textContent = ''; 
    msgEl.classList.remove('msg-ok');

    try{
      const res = await fetch('/api/cart', { headers: getAuthHeader() }); 
      if (!res.ok) throw new Error('è®€å–è³¼ç‰©è»Šå¤±æ•—'); 
      const rows = await res.json(); 
      const item = rows.find(r => r.productId == productId); 
      
      if (!item) { await loadCart(); return; }

      const currentQty = item.qty || 0;
      const maxStock = (item.stock !== undefined && item.stock !== null) ? item.stock : 9999;

      if (delta > 0 && currentQty >= maxStock) {
        msgEl.textContent = 'å·²é”è³¼è²·æ•¸é‡ä¸Šé™ (åº«å­˜åƒ…å‰© ' + maxStock + ' ä»¶)';
        return; 
      }

      const newQty = currentQty + delta; 
      
      if (newQty <= 0) { 
        if(!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤å•†å“å—ï¼Ÿ')) return; 
        await fetch('/api/cart/items/' + encodeURIComponent(productId), { method:'DELETE', headers: getAuthHeader() }); 
      } else { 
        await fetch('/api/cart/items/' + encodeURIComponent(productId), { method:'PUT', headers: getAuthHeader(), body: JSON.stringify({ qty: newQty }) }); 
      }
      
      await loadCart();

    }catch(err){ 
      console.error(err); 
      msgEl.textContent = 'æ›´æ–°æ•¸é‡å¤±æ•—ï¼š' + (err.message||err); 
    }
  }

  async function removeItem(productId){ 
    if (!confirm('ç¢ºå®šè¦å¾è³¼ç‰©è»Šç§»é™¤é€™é …å•†å“å—ï¼Ÿ')) return; 
    try{ 
      const res = await fetch('/api/cart/items/' + encodeURIComponent(productId), { method: 'DELETE', headers: getAuthHeader() }); 
      if (!res.ok) throw new Error('ç§»é™¤å¤±æ•—'); 
      msgEl.classList.add('msg-ok'); 
      msgEl.textContent='å·²ç§»é™¤è©²å•†å“ã€‚'; 
      await loadCart(); 
    }catch(err){ 
      console.error(err); 
      msgEl.classList.remove('msg-ok'); 
      msgEl.textContent = 'ç§»é™¤å¤±æ•—ï¼š' + (err.message||err); 
    } 
  }

  if(btnCheckout) btnCheckout.addEventListener('click', ()=>{ window.location.href='buyer_checkout.html'; });
</script>

</body>
</html>