<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - 後台訂單管理</title>
  <style>
    body {
      margin:0;
      font-family: Arial, sans-serif;
      background:#f5f5f5;
    }
    header {
      background:#1f354d;
      color:white;
      padding:16px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    :root{
      --base-bg: #f4f7fb;
      --panel-bg: #ffffff;
      --brand: #1f354d;
      --brand-600: #26374b;
      --danger: #c0392b;
      --muted: #6b7280;
      --radius: 8px;
      --max-width: 1100px;
    }

    *{box-sizing:border-box}
    body{font-family:Inter, 'Segoe UI', Roboto, Arial, sans-serif;background:var(--base-bg);margin:0;color:#111}
    header{background:linear-gradient(90deg,var(--brand-600),var(--brand));color:#fff;padding:18px 24px;display:flex;justify-content:space-between;align-items:center}
    .admin-nav{background:var(--panel-bg);padding:10px 24px;display:flex;gap:10px;align-items:center;border-bottom:1px solid #e6edf3}
    .admin-nav a{color:var(--muted);text-decoration:none;padding:8px 12px;border-radius:8px;font-weight:600}
    .admin-nav a.active{background:var(--brand);color:#fff}

    .container{max-width:var(--max-width);margin:24px auto;padding:0 16px}
    .panel{background:var(--panel-bg);border-radius:var(--radius);padding:16px;box-shadow:0 6px 18px rgba(31,53,77,0.06)}

    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--brand);color:#fff;cursor:pointer}
    .btn-light{background:#ffffff;color:var(--brand);border:1px solid #e6edf3}
    .btn-danger{background:var(--danger)}
    .btn-small{padding:6px 10px;border-radius:8px}

    .card{border-radius:var(--radius);padding:12px;margin-bottom:16px;background:var(--panel-bg);box-shadow:0 4px 12px rgba(31,53,77,0.04)}
    .empty{color:var(--muted);}
    .order-meta{font-size:13px;color:var(--muted);margin-bottom:6px}
    header h1 { margin:0; font-size:22px; }
    header .right button { margin-left:8px; }

    .btn {
      padding:6px 12px;
      border:none;
      border-radius:4px;
      font-size:14px;
      cursor:pointer;
    }
    .btn-light { background:#ffffff; color:#1f354d; }
    .btn-danger { background:#c0392b; color:#fff; }
    .btn-primary { background:#1f354d; color:#fff; }
    .btn-small {
      padding:4px 8px;
      font-size:12px;
      border-radius:4px;
      border:none;
      cursor:pointer;
    }
    .btn-cancel { background:#e67e22; color:white; }
    .btn-delete { background:#c0392b; color:white; }

    .container {
      max-width:1200px;
      margin:24px auto;
      padding:0 16px;
    }

    .top-card {
      background:white;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:16px 20px;
      margin-bottom:16px;
    }

    .card {
      background:white;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:16px 20px;
      margin-bottom:16px;
    }
    .empty {
      margin-top:16px;
      color:#777;
    }

    .order-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .order-id {
      font-weight:bold;
      font-size:15px;
    }

    .badge {
      display:inline-block;
      padding:2px 8px;
      border-radius:10px;
      font-size:12px;
      color:white;
    }
    .badge-pending   { background:#e67e22; }
    .badge-paid      { background:#2980b9; }
    .badge-shipped   { background:#16a085; }
    .badge-completed { background:#2ecc71; }
    .badge-canceled  { background:#7f8c8d; }
    .badge-cancel-req{ background:#f39c12; }
    .badge-cancel-rej{ background:#c0392b; }

    .order-meta {
      font-size:13px;
      color:#555;
      margin-bottom:4px;
    }
    .order-total {
      font-weight:bold;
      margin-top:4px;
    }
    .order-actions {
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .items-list {
      margin-top:8px;
      font-size:13px;
      border-top:1px solid #eee;
      padding-top:6px;
    }
    .note {
      font-size:13px;
      color:#777;
    }
    .global-msg {
      margin-top:8px;
      font-size:14px;
      color:#c0392b;
    }
    .global-msg.ok {
      color:#27ae60;
    }
  </style>
</head>
<body>
<header>
  <h1>SGTP 二手商品平台 - 後台訂單管理</h1>
  <div class="right">
    <button class="btn btn-light" onclick="location.href='index.html'">回起始頁</button>
    <button id="btnLogout" class="btn btn-danger">登出</button>
  </div>
</header>

<div class="admin-nav" style="margin:0 0 8px 0;">
  <a href="admin_products.html">商品管理</a>
  <a href="admin_users.html">使用者管理</a>
  <a href="admin_orders.html" class="active">訂單管理</a>
</div>

<div class="container">
  <div class="top-card">
    <h2>全部訂單總覽（管理者）</h2>
    <p class="note">
      只有 <b>後台資料管理者（role = "admin"）</b> 可以進入此頁面。<br/>
      在這裡可以：
      <ul>
        <li>查看所有買家 / 賣家的訂單</li>
        <li>將訂單狀態改成「已取消」</li>
        <li>直接刪除訂單文件（注意：刪除後無法復原）</li>
      </ul>
    </p>
    <div id="globalMsg" class="global-msg"></div>
  </div>

  <div id="ordersEmpty" class="empty" style="display:none;">目前資料庫中沒有任何訂單。</div>
  <div id="ordersWrap"></div>
</div>

<script>
  const btnLogout   = document.getElementById('btnLogout');
  const ordersEmpty = document.getElementById('ordersEmpty');
  const ordersWrap  = document.getElementById('ordersWrap');
  const globalMsg   = document.getElementById('globalMsg');

  let currentAdminUid = null;

  function getAuthHeader() { const t = localStorage.getItem('token'); return t ? { 'Authorization': 'Bearer ' + t, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' }; }

  // 登出（清除 token）
  btnLogout.addEventListener('click', () => {
    localStorage.removeItem('token');
    alert('已登出');
    window.location.href = 'admin_login.html';
  });

  // 進入時檢查身分
  (async function(){
    try {
      const res = await fetch('/api/auth/me', { headers: getAuthHeader() });
      if (!res.ok) { alert('請先登入帳號'); window.location.href = 'admin_login.html'; return; }
      const user = await res.json();
      if (!user || user.role !== 'admin') { alert('此帳號不是後台資料管理者，無法進入此頁面。'); localStorage.removeItem('token'); window.location.href = 'admin_login.html'; return; }
      currentAdminUid = user.id;
      await loadAllOrders();
    } catch (err) {
      console.error(err);
      alert('讀取使用者資料失敗：' + (err.message || err));
      window.location.href = 'admin_login.html';
    }
  })();

  function formatDate(value) {
    if (!value) return '-';
    const d = (typeof value === 'string' || typeof value === 'number') ? new Date(value) : (value instanceof Object && value.toDate ? value.toDate() : new Date(value));
    if (isNaN(d)) return '-';
    return d.toLocaleString();
  }

  function getStatusBadge(data) {
    const span = document.createElement('span'); span.classList.add('badge');
    if (data.status === 'canceled' || data.cancelStatus === 'approved' || data.cancelStatus === 'admin_canceled') { span.classList.add('badge-canceled'); span.textContent = '已取消'; return span; }
    if (data.cancelStatus === 'requested') { span.classList.add('badge-cancel-req'); span.textContent = '取消申請中'; return span; }
    if (data.cancelStatus === 'rejected') { span.classList.add('badge-cancel-rej'); span.textContent = '取消被拒絕'; return span; }
    switch (data.status) {
      case 'pending': span.classList.add('badge-pending'); span.textContent = 'pending'; break;
      case 'paid': span.classList.add('badge-paid'); span.textContent = '已付款'; break;
      case 'shipped': span.classList.add('badge-shipped'); span.textContent = '已出貨'; break;
      case 'completed': span.classList.add('badge-completed'); span.textContent = '已完成'; break;
      default: span.classList.add('badge-pending'); span.textContent = data.status || 'unknown';
    }
    return span;
  }

  async function loadAllOrders() {
    ordersWrap.innerHTML = '';
    ordersEmpty.style.display = 'none';
    globalMsg.textContent = '';
    globalMsg.classList.remove('ok');
    try {
      const res = await fetch('/api/orders', { headers: getAuthHeader() });
      if (!res.ok) { throw new Error('無法取得訂單，狀態碼 ' + res.status); }
      const list = await res.json();
      if (!list || list.length === 0) { ordersEmpty.style.display = 'block'; return; }
      list.forEach(doc => {
        const data = doc;
        const card = document.createElement('div'); card.className = 'card';
        const header = document.createElement('div'); header.className = 'order-header';
        const idDiv = document.createElement('div'); idDiv.className = 'order-id'; idDiv.textContent = '訂單編號：' + (doc.id || data.id || '');
        const badge = getStatusBadge(data);
        header.appendChild(idDiv); header.appendChild(badge);

        const meta1 = document.createElement('div'); meta1.className = 'order-meta'; meta1.textContent = '建立時間：' + formatDate(data.created_at || data.createdAt || data.createdAtISO);
        const meta2 = document.createElement('div'); meta2.className = 'order-meta'; meta2.textContent = '買家：' + (data.buyerEmail || data.buyerId || data.buyer || '');
        const meta3 = document.createElement('div'); meta3.className = 'order-meta'; meta3.textContent = '收件人：' + (data.shipName || '') + '，電話：' + (data.shipPhone || '') + '，地址：' + (data.shipAddress || '');
        const meta4 = document.createElement('div'); meta4.className = 'order-meta'; meta4.textContent = '取消狀態：' + (data.cancelStatus || '（無）') + (data.cancelReason ? `，原因：${data.cancelReason}` : '');

        const totalDiv = document.createElement('div'); totalDiv.className = 'order-total'; totalDiv.textContent = '訂單總額：NT$ ' + (data.totalAmount || data.total || 0);

        const actions = document.createElement('div'); actions.className = 'order-actions';
        if (data.status !== 'canceled') {
          const btnCancel = document.createElement('button'); btnCancel.className = 'btn-small btn-cancel'; btnCancel.textContent = '管理者取消訂單'; btnCancel.addEventListener('click', () => adminCancelOrder(doc.id || data.id)); actions.appendChild(btnCancel);
        }
        const btnDel = document.createElement('button'); btnDel.className = 'btn-small btn-delete'; btnDel.textContent = '刪除訂單（不可復原）'; btnDel.addEventListener('click', () => adminDeleteOrder(doc.id || data.id)); actions.appendChild(btnDel);

        const itemsDiv = document.createElement('div'); itemsDiv.className = 'items-list';
        const items = data.items || [];
        if (Array.isArray(items) && items.length > 0) {
          items.forEach(it => { const line = document.createElement('div'); line.textContent = `${it.title || '商品'} x ${it.qty || it.quantity || 1}（單價 NT$ ${it.price || 0}` + (it.sellerId ? `，賣家ID: ${it.sellerId}` : '') + '）'; itemsDiv.appendChild(line); });
        } else { itemsDiv.textContent = '（無商品明細）'; }

        card.appendChild(header); card.appendChild(meta1); card.appendChild(meta2); card.appendChild(meta3); card.appendChild(meta4); card.appendChild(totalDiv); card.appendChild(actions); card.appendChild(itemsDiv);
        ordersWrap.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      globalMsg.textContent = '讀取訂單錯誤：' + (err.message || err);
    }
  }

  // 管理者取消訂單（在後端更新狀態）
  async function adminCancelOrder(orderId) {
    const ok = confirm('確定要將此訂單標記為「已取消」嗎？'); if (!ok) return;
    try {
      const res = await fetch('/api/orders/' + encodeURIComponent(orderId), {
        method: 'PUT', headers: getAuthHeader(), body: JSON.stringify({ status: 'canceled', cancelStatus: 'admin_canceled', canceledBy: currentAdminUid })
      });
      if (!res.ok) throw new Error('取消失敗，狀態碼 ' + res.status);
      globalMsg.textContent = '已將訂單標記為已取消。'; globalMsg.classList.add('ok'); await loadAllOrders();
    } catch (err) { console.error(err); globalMsg.textContent = '取消訂單失敗：' + (err.message || err); globalMsg.classList.remove('ok'); }
  }

  // 管理者刪除訂單（後端刪除）
  async function adminDeleteOrder(orderId) {
    const ok = confirm('⚠ 注意：這會「直接刪除」訂單，無法復原。\n若只是要取消訂單，請用「管理者取消訂單」。\n\n仍然要刪除嗎？'); if (!ok) return;
    try {
      const res = await fetch('/api/orders/' + encodeURIComponent(orderId), { method: 'DELETE', headers: getAuthHeader() });
      if (!res.ok) throw new Error('刪除失敗，狀態碼 ' + res.status);
      globalMsg.textContent = '已刪除訂單。'; globalMsg.classList.add('ok'); await loadAllOrders();
    } catch (err) { console.error(err); globalMsg.textContent = '刪除訂單失敗：' + (err.message || err); globalMsg.classList.remove('ok'); }
  }
</script>
</body>
</html>
