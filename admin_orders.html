<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - 後台訂單管理</title>
  <style>
    body {
      margin:0;
      font-family: Arial, sans-serif;
      background:#f5f5f5;
    }
    header {
      background:#1f354d;
      color:white;
      padding:16px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    header h1 { margin:0; font-size:22px; }
    header .right button { margin-left:8px; }

    .btn {
      padding:6px 12px;
      border:none;
      border-radius:4px;
      font-size:14px;
      cursor:pointer;
    }
    .btn-light { background:#ffffff; color:#1f354d; }
    .btn-danger { background:#c0392b; color:#fff; }
    .btn-primary { background:#1f354d; color:#fff; }
    .btn-small {
      padding:4px 8px;
      font-size:12px;
      border-radius:4px;
      border:none;
      cursor:pointer;
    }
    .btn-cancel { background:#e67e22; color:white; }
    .btn-delete { background:#c0392b; color:white; }

    .container {
      max-width:1200px;
      margin:24px auto;
      padding:0 16px;
    }

    .top-card {
      background:white;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:16px 20px;
      margin-bottom:16px;
    }

    .card {
      background:white;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:16px 20px;
      margin-bottom:16px;
    }
    .empty {
      margin-top:16px;
      color:#777;
    }

    .order-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .order-id {
      font-weight:bold;
      font-size:15px;
    }

    .badge {
      display:inline-block;
      padding:2px 8px;
      border-radius:10px;
      font-size:12px;
      color:white;
    }
    .badge-pending   { background:#e67e22; }
    .badge-paid      { background:#2980b9; }
    .badge-shipped   { background:#16a085; }
    .badge-completed { background:#2ecc71; }
    .badge-canceled  { background:#7f8c8d; }
    .badge-cancel-req{ background:#f39c12; }
    .badge-cancel-rej{ background:#c0392b; }

    .order-meta {
      font-size:13px;
      color:#555;
      margin-bottom:4px;
    }
    .order-total {
      font-weight:bold;
      margin-top:4px;
    }
    .order-actions {
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .items-list {
      margin-top:8px;
      font-size:13px;
      border-top:1px solid #eee;
      padding-top:6px;
    }
    .note {
      font-size:13px;
      color:#777;
    }
    .global-msg {
      margin-top:8px;
      font-size:14px;
      color:#c0392b;
    }
    .global-msg.ok {
      color:#27ae60;
    }
  </style>
</head>
<body>
<header>
  <h1>SGTP 二手商品平台 - 後台訂單管理</h1>
  <div class="right">
    <button class="btn btn-light" onclick="location.href='index.html'">回起始頁</button>
    <button id="btnLogout" class="btn btn-danger">登出</button>
  </div>
</header>

<div class="container">
  <div class="top-card">
    <h2>全部訂單總覽（管理者）</h2>
    <p class="note">
      只有 <b>後台資料管理者（role = "admin"）</b> 可以進入此頁面。<br/>
      在這裡可以：
      <ul>
        <li>查看所有買家 / 賣家的訂單</li>
        <li>將訂單狀態改成「已取消」</li>
        <li>直接刪除訂單文件（注意：刪除後無法復原）</li>
      </ul>
    </p>
    <div id="globalMsg" class="global-msg"></div>
  </div>

  <div id="ordersEmpty" class="empty" style="display:none;">目前資料庫中沒有任何訂單。</div>
  <div id="ordersWrap"></div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    collection,
    query,
    orderBy,
    getDocs,
    doc,
    getDoc,
    updateDoc,
    deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const btnLogout   = document.getElementById("btnLogout");
  const ordersEmpty = document.getElementById("ordersEmpty");
  const ordersWrap  = document.getElementById("ordersWrap");
  const globalMsg   = document.getElementById("globalMsg");

  let currentAdminUid = null;

  // 登出
  btnLogout.addEventListener("click", async () => {
    try {
      await signOut(auth);
      alert("已登出");
      window.location.href = "buyer_login.html"; // 你也可以改成 admin_login.html
    } catch (err) {
      console.error(err);
      alert("登出失敗：" + err.message);
    }
  });

  // 監聽登入狀態 & 檢查 role
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("請先登入帳號");
      window.location.href = "buyer_login.html";
      return;
    }
    try {
      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      if (!snap.exists() || snap.data().role !== "admin") {
        alert("此帳號不是後台資料管理者，無法進入此頁面。");
        await signOut(auth);
        window.location.href = "buyer_login.html";
        return;
      }
      currentAdminUid = user.uid;
      await loadAllOrders();
    } catch (err) {
      console.error(err);
      alert("讀取使用者資料失敗：" + err.message);
      window.location.href = "buyer_login.html";
    }
  });

  function formatDate(ts) {
    if (!ts || !ts.toDate) return "-";
    const d = ts.toDate();
    const yyyy = d.getFullYear();
    const mm   = String(d.getMonth()+1).padStart(2,"0");
    const dd   = String(d.getDate()).padStart(2,"0");
    const hh   = String(d.getHours()).padStart(2,"0");
    const mi   = String(d.getMinutes()).padStart(2,"0");
    return `${yyyy}/${mm}/${dd} ${hh}:${mi}`;
  }

  function getStatusBadge(data) {
    const span = document.createElement("span");
    span.classList.add("badge");

    if (data.status === "canceled" || data.cancelStatus === "approved") {
      span.classList.add("badge-canceled");
      span.textContent = "已取消";
      return span;
    }
    if (data.cancelStatus === "requested") {
      span.classList.add("badge-cancel-req");
      span.textContent = "取消申請中";
      return span;
    }
    if (data.cancelStatus === "rejected") {
      span.classList.add("badge-cancel-rej");
      span.textContent = "取消被拒絕";
      return span;
    }

    switch (data.status) {
      case "pending":
        span.classList.add("badge-pending");
        span.textContent = "pending";
        break;
      case "paid":
        span.classList.add("badge-paid");
        span.textContent = "已付款";
        break;
      case "shipped":
        span.classList.add("badge-shipped");
        span.textContent = "已出貨";
        break;
      case "completed":
        span.classList.add("badge-completed");
        span.textContent = "已完成";
        break;
      default:
        span.classList.add("badge-pending");
        span.textContent = data.status || "unknown";
    }
    return span;
  }

  async function loadAllOrders() {
    ordersWrap.innerHTML = "";
    ordersEmpty.style.display = "none";
    globalMsg.textContent = "";
    globalMsg.classList.remove("ok");

    try {
      const q = query(
        collection(db, "orders"),
        orderBy("createdAt", "desc")
      );
      const snap = await getDocs(q);

      if (snap.empty) {
        ordersEmpty.style.display = "block";
        return;
      }

      snap.forEach(docSnap => {
        const data = docSnap.data();
        const card = document.createElement("div");
        card.className = "card";

        const header = document.createElement("div");
        header.className = "order-header";

        const idDiv = document.createElement("div");
        idDiv.className = "order-id";
        idDiv.textContent = "訂單編號：" + docSnap.id;

        const badge = getStatusBadge(data);
        header.appendChild(idDiv);
        header.appendChild(badge);

        const meta1 = document.createElement("div");
        meta1.className = "order-meta";
        meta1.textContent = "建立時間：" + formatDate(data.createdAt);

        const meta2 = document.createElement("div");
        meta2.className = "order-meta";
        meta2.textContent = "買家：" + (data.buyerEmail || data.buyerId || "");

        const meta3 = document.createElement("div");
        meta3.className = "order-meta";
        meta3.textContent =
          "收件人：" + (data.shipName || "") +
          "，電話：" + (data.shipPhone || "") +
          "，地址：" + (data.shipAddress || "");

        const meta4 = document.createElement("div");
        meta4.className = "order-meta";
        meta4.textContent =
          "取消狀態：" + (data.cancelStatus || "（無）") +
          (data.cancelReason ? `，原因：${data.cancelReason}` : "");

        const totalDiv = document.createElement("div");
        totalDiv.className = "order-total";
        totalDiv.textContent = "訂單總額：NT$ " + (data.totalAmount || 0);

        const actions = document.createElement("div");
        actions.className = "order-actions";

        // 按鈕：管理者取消訂單
        if (data.status !== "canceled") {
          const btnCancel = document.createElement("button");
          btnCancel.className = "btn-small btn-cancel";
          btnCancel.textContent = "管理者取消訂單";
          btnCancel.addEventListener("click", () => adminCancelOrder(docSnap.id));
          actions.appendChild(btnCancel);
        }

        // 按鈕：刪除訂單（不管狀態）
        const btnDel = document.createElement("button");
        btnDel.className = "btn-small btn-delete";
        btnDel.textContent = "刪除訂單（不可復原）";
        btnDel.addEventListener("click", () => adminDeleteOrder(docSnap.id));
        actions.appendChild(btnDel);

        // 商品清單
        const itemsDiv = document.createElement("div");
        itemsDiv.className = "items-list";

        if (Array.isArray(data.items)) {
          data.items.forEach(it => {
            const line = document.createElement("div");
            line.textContent =
              `${it.title || "商品"} x ${it.qty || 1}（單價 NT$ ${it.price || 0}` +
              (it.sellerId ? `，賣家ID: ${it.sellerId}` : "") + "）";
            itemsDiv.appendChild(line);
          });
        } else {
          itemsDiv.textContent = "（無商品明細）";
        }

        card.appendChild(header);
        card.appendChild(meta1);
        card.appendChild(meta2);
        card.appendChild(meta3);
        card.appendChild(meta4);
        card.appendChild(totalDiv);
        card.appendChild(actions);
        card.appendChild(itemsDiv);

        ordersWrap.appendChild(card);
      });

    } catch (err) {
      console.error(err);
      globalMsg.textContent = "讀取訂單錯誤：" + err.message;
    }
  }

  // 管理者取消訂單（只改狀態，不刪文件）
  async function adminCancelOrder(orderId) {
    const ok = confirm("確定要將此訂單標記為『已取消』嗎？");
    if (!ok) return;

    try {
      await updateDoc(doc(db, "orders", orderId), {
        status: "canceled",
        cancelStatus: "admin_canceled",
        canceledBy: currentAdminUid,
        canceledAt: serverTimestamp()
      });
      globalMsg.textContent = "已將訂單標記為已取消。";
      globalMsg.classList.add("ok");
      await loadAllOrders();
    } catch (err) {
      console.error(err);
      globalMsg.textContent = "取消訂單失敗：" + err.message;
      globalMsg.classList.remove("ok");
    }
  }

  // 管理者刪除訂單（直接刪 doc）
  async function adminDeleteOrder(orderId) {
    const ok = confirm(
      "⚠ 注意：這會『直接刪除』訂單文件，無法復原。\n" +
      "若只是要取消訂單，請用『管理者取消訂單』即可。\n\n" +
      "仍然要刪除嗎？"
    );
    if (!ok) return;

    try {
      await deleteDoc(doc(db, "orders", orderId));
      globalMsg.textContent = "已刪除訂單。";
      globalMsg.classList.add("ok");
      await loadAllOrders();
    } catch (err) {
      console.error(err);
      globalMsg.textContent = "刪除訂單失敗：" + err.message;
      globalMsg.classList.remove("ok");
    }
  }
</script>
</body>
</html>
