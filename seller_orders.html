<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>SGTP - è³£å®¶è¨‚å–®ç®¡ç†</title>
<style>
  body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }

  /* ===== Header (èˆ‡ seller_home ä¸€è‡´) ===== */
  header {
    background: #2c3e50; /* æ·±è—è‰²èƒŒæ™¯ */
    color: white;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  
  .header-logo {
    font-size: 20px;
    font-weight: bold;
    color: white;
    text-decoration: none;
    display: flex;
    align-items: center;
    cursor: pointer;
  }
  
  .header-right {
    display: flex;
    align-items: center;
    gap: 24px;
  }

  /* æ‰€æœ‰è¨‚å–®æŒ‰éˆ•æ¨£å¼ */
  .all-order {
    color: white;
    text-decoration: none;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: opacity 0.2s;
  }
  .all-order:hover { opacity: 0.8; }

  /* èŠå¤©æŒ‰éˆ• */
  .icon-chat {
    color: white;
    text-decoration: none;
    font-size: 24px;
    position: relative;
    cursor: pointer;
    display: flex; align-items: center;
  }
  .icon-chat:hover { opacity: 0.8; }

  /* ä¸‹æ‹‰é¸å–®å€å¡Š */
  .user-menu {
    position: relative;
    cursor: pointer;
    display: flex;
    align-items: center;
    height: 60px;
  }
  .user-name {
    font-size: 16px;
    font-weight: bold;
    margin-right: 5px;
  }
  .dropdown-content {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background-color: white;
    min-width: 150px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: 0 0 4px 4px;
    overflow: hidden;
    z-index: 1001;
  }
  .dropdown-content a {
    color: #333;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    font-size: 14px;
    border-bottom: 1px solid #f0f0f0;
  }
  .dropdown-content a:hover { background-color: #f5f5f5; color: #2c3e50; }
  .user-menu:hover .dropdown-content { display: block; }
  .user-avatar {
      width: 32px; height: 32px;
      background-color: #bdc3c7;
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      font-size: 14px; color: #2c3e50;
      margin-right: 8px;
    }
  /* ===== é é¢å…§å®¹æ¨£å¼ ===== */
  .container { max-width:1100px; margin:24px auto; padding:0 16px; }

  .card { background:white; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:16px 20px; margin-bottom:16px; }

  h2 { margin-top: 0; margin-bottom: 10px; color: #333; }

  .btn { padding:6px 12px; border:none; border-radius:4px; cursor:pointer; }
  .btn-small { padding:4px 8px; font-size:12px; border-radius:4px; cursor:pointer; }

  .btn-accept  { background:#27ae60; color:white; }
  .btn-reject  { background:#e67e22; color:white; }
  .btn-status-shipped   { background:#16a085; color:#fff; }
  
  .btn-chat { background: #e67e22; color: white; margin-right: 6px; }
  .btn-chat:hover { opacity: 0.9; }

  .order-header { display:flex; justify-content:space-between; margin-bottom:6px; gap: 10px; align-items: center; }
  .order-id { font-weight:bold; }

  .badge { padding:2px 8px; border-radius:10px; color:#fff; font-size:12px; white-space: nowrap; }
  .badge-pending { background:#7f8c8d; }
  .badge-shipped { background:#16a085; }
  .badge-completed { background:#2ecc71; }
  .badge-canceled { background:#c0392b; }
  .badge-cancel-req { background:#f39c12; }
  .badge-cancel-rej { background:#8e44ad; }

  .order-meta { font-size:13px; color:#555; margin-bottom:4px; }
  .order-total { margin-top:4px; font-weight:bold; }

  .items-list { margin-top:8px; border-top:1px solid #eee; padding-top:6px; font-size:13px; }

  .order-actions { margin-top:12px; display:flex; flex-direction: column; gap:8px; font-size:13px; }
  .actions-row { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }

  #globalMsg { display:none; color:#c0392b; margin-top:10px; }
</style>
</head>

<body>

<header>
  <a href="seller_home.html" class="header-logo">SGTP-è³£å®¶ä¸­å¿ƒ</a>

  <div class="header-right">
    <a href="seller_orders.html" class="all-order" title="æŸ¥çœ‹æ‰€æœ‰è¨‚å–®">æ‰€æœ‰è¨‚å–®</a>

    <a href="seller_chats.html" class="icon-chat" title="èŠå¤©å®¤">ğŸ’¬</a>

    <div class="user-menu">
      <div class="user-avatar">S</div>
      <span class="user-name" id="headerUserName">è³£å®¶</span>
      <span>â–¼</span>
      <div class="dropdown-content">
        <a href="seller_profile.html">æˆ‘çš„è³‡æ–™</a>
        <a href="#" id="btnLogout">ç™»å‡º</a>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <div class="card">
    <h2>è³£å®¶è¨‚å–®ç®¡ç†</h2>
    <p style="font-size:13px; color:#777;">é¡¯ç¤ºæ‰€æœ‰åŒ…å«ä½ å•†å“çš„è¨‚å–®ã€‚è«‹åœ¨å‡ºè²¨å¾Œæ›´æ–°ç‹€æ…‹ç‚ºã€Œå·²å‡ºè²¨ã€ã€‚</p>
    <div id="globalMsg"></div>
  </div>
  <div id="ordersEmpty" style="display:none; color:#777; text-align:center; margin-top:20px;">ç›®å‰æ²’æœ‰ä»»ä½•è¨‚å–®ã€‚</div>
  <div id="ordersWrap"></div>
</div>

<script>
const ordersWrap = document.getElementById("ordersWrap");
const ordersEmpty = document.getElementById("ordersEmpty");
const btnLogout = document.getElementById("btnLogout");
const globalMsg = document.getElementById("globalMsg");
const headerUserName = document.getElementById("headerUserName"); // å–å¾— Header åå­—æ¬„ä½

let currentSellerUid = null;

// ç™»å‡ºåŠŸèƒ½
btnLogout.addEventListener('click', (e)=>{ 
    e.preventDefault();
    localStorage.removeItem('token'); 
    alert('å·²ç™»å‡º'); 
    location.href='seller_login.html'; 
});

function getAuthHeader(){ const t = localStorage.getItem('token'); return t ? { 'Authorization':'Bearer ' + t } : {}; }
function showError(msg){ globalMsg.style.display='block'; globalMsg.textContent = msg; }
function clearError(){ globalMsg.style.display='none'; globalMsg.textContent=''; }
function formatDate(s){ if(!s) return '-'; const d = new Date(s); if(isNaN(d.getTime())) return '-'; return d.toLocaleString(); }

function statusBadge(data){
  const s = document.createElement('span'); s.classList.add('badge');
  const status = (data.status || '').toLowerCase();
  const cancelStatus = (data.cancelStatus || '').toLowerCase();

  if (status === 'cancelled' || cancelStatus === 'approved'){ s.classList.add('badge-canceled'); s.textContent = 'å·²å–æ¶ˆ'; }
  else if (status === 'cancellation requested' || cancelStatus === 'requested'){ s.classList.add('badge-cancel-req'); s.textContent = 'å–æ¶ˆç”³è«‹ä¸­'; }
  else if (cancelStatus === 'rejected'){ s.classList.add('badge-cancel-rej'); s.textContent = 'å–æ¶ˆè¢«æ‹’çµ•'; }
  else {
    switch(status){
      case 'pending': case 'created': s.classList.add('badge-pending'); s.textContent='å·²æˆç«‹'; break;
      case 'shipped': s.classList.add('badge-shipped'); s.textContent='å·²å‡ºè²¨'; break;
      case 'completed': s.classList.add('badge-completed'); s.textContent='å·²å®Œæˆ'; break;
      default: s.classList.add('badge-pending'); s.textContent=data.status||'unknown';
    }
  }
  return s;
}

(async function init(){
  try{
    const me = await fetch('/api/auth/me',{headers:getAuthHeader()});
    if(!me.ok){ alert('è«‹å…ˆç™»å…¥è³£å®¶å¸³è™Ÿ'); location.href='seller_login.html'; return; }
    
    const user = await me.json();
    if(!user || user.role!=='seller'){ alert('éè³£å®¶å¸³è™Ÿ'); localStorage.removeItem('token'); location.href='seller_login.html'; return; }
    
    currentSellerUid = user.id; 
    
    // âœ… [æ–°å¢] è¨­å®š Header è³£å®¶åç¨±
    if(headerUserName) headerUserName.textContent = user.name || 'è³£å®¶';

    await loadOrders();
  }catch(e){ console.error(e); alert('è®€å–ä½¿ç”¨è€…å¤±æ•—'); location.href='seller_login.html'; }
})();

async function loadOrders(){
  ordersWrap.innerHTML=''; ordersEmpty.style.display='none'; clearError();
  let rows=null;
  try{
    const res = await fetch('/api/seller/orders/my',{headers:getAuthHeader()});
    if(!res.ok) throw new Error('è¼‰å…¥è¨‚å–®å¤±æ•—');
    rows = await res.json();
  }catch(e){ showError('è¼‰å…¥è¨‚å–®å¤±æ•—'); ordersEmpty.style.display='block'; return; }

  if(!Array.isArray(rows) || rows.length===0){ ordersEmpty.style.display='block'; return; }

  rows.forEach(r=>{
    const data = r||{};
    const card=document.createElement('div'); card.className='card';
    const header=document.createElement('div'); header.className='order-header';
    const idDiv=document.createElement('div'); idDiv.className='order-id'; idDiv.textContent='è¨‚å–®ç·¨è™Ÿï¼š'+(r.id||r.orderId||'');
    header.appendChild(idDiv); header.appendChild(statusBadge(data));

    const metaHtml=`
      <div class="order-meta">è¨‚å–®æ—¥æœŸï¼š${formatDate(data.created_at||data.createdAt)}</div>
      <div class="order-meta">è²·å®¶ï¼š${data.buyer_email||data.buyerEmail||''}</div>
      <div class="order-meta">æ”¶ä»¶äººï¼š${data.shipName||data.ship_name||''}ï¼Œé›»è©±ï¼š${data.shipPhone||data.ship_phone||''}ï¼Œåœ°å€ï¼š${data.shipAddress||data.ship_address||''}</div>
      <div class="order-total">è¨‚å–®ç¸½é¡ï¼šNT$ ${data.total_amount||data.totalAmount||0}</div>
    `;

    const actionsDiv=document.createElement('div'); actionsDiv.className='order-actions';
    const status = (data.status || '').toLowerCase();
    const cancelStatus = (data.cancelStatus || '').toLowerCase();
    const isRequestingCancel = (status === 'cancellation requested' || cancelStatus === 'requested');
    const isCancelled = (status === 'cancelled' || cancelStatus === 'approved');
    const isCompleted = (status === 'completed');

    // è¯çµ¡è²·å®¶æŒ‰éˆ•
    const buyerId = data.buyer_id || data.buyerId;
    if (buyerId && !isCancelled && !isCompleted) {
        const row = document.createElement('div'); row.className='actions-row';
        const btnChat = document.createElement('button');
        btnChat.className = 'btn-small btn-chat';
        btnChat.textContent = 'è¯çµ¡è²·å®¶';
        btnChat.onclick = () => {
            location.href = `chat.html?targetId=${buyerId}&role=seller&orderId=${r.id}`;
        };
        row.appendChild(btnChat);
        actionsDiv.appendChild(row);
    }

    // === å€å¡Š 1: ä¸€èˆ¬ç‹€æ…‹æ›´æ”¹æŒ‰éˆ• ===
    if (!isRequestingCancel && !isCancelled && !isCompleted && status !== 'shipped') {
      const row=document.createElement('div'); row.className='actions-row';
      const label=document.createElement('span'); label.textContent='è®Šæ›´è¨‚å–®ç‹€æ…‹ï¼š';
      const btn=document.createElement('button'); btn.className='btn-small btn-status-shipped'; btn.textContent='é€šçŸ¥è²·å®¶å·²å‡ºè²¨';
      btn.onclick=()=>updateStatus(r.id, 'Shipped'); 
      row.appendChild(label); row.appendChild(btn); actionsDiv.appendChild(row);
    } 
    else if (status === 'shipped') {
        const row=document.createElement('div'); row.className='actions-row';
        row.textContent='ğŸšš å·²å‡ºè²¨ï¼Œç­‰å¾…è²·å®¶å®Œæˆè¨‚å–®ã€‚'; row.style.color='#16a085'; actionsDiv.appendChild(row);
    }
    else if (status === 'completed') {
        const row=document.createElement('div'); row.className='actions-row';
        row.textContent='âœ… è²·å®¶å·²æ”¶è²¨ï¼Œè¨‚å–®å®Œæˆã€‚'; row.style.color='#2ecc71'; actionsDiv.appendChild(row);
    }

    // === å€å¡Š 2: å–æ¶ˆç”³è«‹è™•ç† ===
    if(isRequestingCancel && !isCancelled){
      const row=document.createElement('div'); row.className='actions-row';
      row.style.background = '#fff3cd'; row.style.padding = '8px'; row.style.borderRadius = '4px';
      const info=document.createElement('span'); info.style.fontWeight = 'bold'; info.style.color = '#856404';
      info.textContent='âš ï¸ è²·å®¶å·²æå‡ºå–æ¶ˆç”³è«‹'+(data.cancelReason?('ï¼ˆåŸå› ï¼š'+data.cancelReason+'ï¼‰'):'')+'ï¼Œè«‹é¸æ“‡ï¼š';
      const btnOk=document.createElement('button'); btnOk.className='btn-small btn-accept'; btnOk.textContent='åŒæ„å–æ¶ˆ'; btnOk.onclick=()=>approveCancel(r.id);
      const btnNo=document.createElement('button'); btnNo.className='btn-small btn-reject'; btnNo.textContent='æ‹’çµ•å–æ¶ˆ'; btnNo.onclick=()=>rejectCancel(r.id);
      row.appendChild(info); row.appendChild(btnOk); row.appendChild(btnNo); actionsDiv.appendChild(row);
    } 
    else if(isCancelled){
      const row=document.createElement('div'); row.className='actions-row'; row.textContent='âŒ æ­¤è¨‚å–®å·²å–æ¶ˆã€‚'; actionsDiv.appendChild(row);
    } 
    else if (cancelStatus === 'rejected') {
      const row = document.createElement('div'); row.className = 'actions-row'; row.style.color = '#8e44ad'; row.style.fontWeight = 'bold'; row.textContent = 'â„¹ï¸ æ‚¨å·²æ‹’çµ•è²·å®¶çš„å–æ¶ˆç”³è«‹ã€‚'; actionsDiv.appendChild(row);
    }

    const itemsDiv=document.createElement('div'); itemsDiv.className='items-list';
    let items = data.items;
    if (typeof items === 'string') { try { items = JSON.parse(items); } catch(e){ items = []; } }
    if(Array.isArray(items) && items.length){
        items.forEach(it=>{ 
            const line=document.createElement('div'); 
            line.textContent=`${it.name||it.title||'å•†å“'} x ${it.qty||it.quantity||1}ï¼ˆå–®åƒ¹ NT$ ${it.price||0}ï¼‰`; 
            itemsDiv.appendChild(line); 
        });
    } else { itemsDiv.textContent='ï¼ˆç„¡å•†å“æ˜ç´°ï¼‰'; }

    card.appendChild(header); card.insertAdjacentHTML('beforeend',metaHtml); card.appendChild(itemsDiv); card.appendChild(actionsDiv); 
    ordersWrap.appendChild(card);
  });
}

async function updateStatus(orderId, newStatus){
  if(!confirm(`ç¢ºå®šè¦å°‡æ­¤è¨‚å–®å•†å“ç‹€æ…‹æ”¹ç‚ºã€Œå·²å‡ºè²¨ã€å—ï¼Ÿ`)) return;
  try{
    const res=await fetch(`/api/seller/orders/${encodeURIComponent(orderId)}/status`, { method:'PUT', headers:Object.assign({'Content-Type':'application/json'}, getAuthHeader()), body:JSON.stringify({ newStatus: newStatus }) });
    if(!res.ok){ const e=await res.json().catch(()=>null); throw new Error(e && e.error ? e.error : 'Status '+res.status); }
    alert(`å·²æ›´æ–°ç‚ºã€Œå·²å‡ºè²¨ã€ã€‚`); await loadOrders();
  } catch(err){ console.error(err); alert('æ›´æ–°å•†å“ç‹€æ…‹å¤±æ•—ï¼š'+(err.message||err)); }
}

async function approveCancel(id){
  if(!confirm('ç¢ºå®šè¦åŒæ„å–æ¶ˆæ­¤è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œæœƒå°‡è¨‚å–®æ¨™ç¤ºç‚ºå·²å–æ¶ˆã€‚')) return;
  try{
    const res=await fetch('/api/seller/orders/'+encodeURIComponent(id)+'/cancel',{ method:'PUT', headers:Object.assign({'Content-Type':'application/json'},getAuthHeader()), body:JSON.stringify({action:'approve'}) });
    if(!res.ok){ const e=await res.json().catch(()=>null); throw new Error(e&&e.error?e.error:'Status '+res.status); }
    alert('å·²åŒæ„å–æ¶ˆ'); await loadOrders();
  }catch(err){ console.error(err); alert('åŒæ„å–æ¶ˆå¤±æ•—ï¼š'+(err.message||err)); }
}

async function rejectCancel(id){
  if(!confirm('ç¢ºå®šè¦æ‹’çµ•å–æ¶ˆç”³è«‹å—ï¼Ÿè¨‚å–®å°‡å›å¾©ç‚ºæœ‰æ•ˆç‹€æ…‹ã€‚')) return;
  try{
    const res=await fetch('/api/seller/orders/'+encodeURIComponent(id)+'/cancel',{ method:'PUT', headers:Object.assign({'Content-Type':'application/json'},getAuthHeader()), body:JSON.stringify({action:'reject'}) });
    if(!res.ok){ const e=await res.json().catch(()=>null); throw new Error(e&&e.error?e.error:'Status '+res.status); }
    alert('å·²æ‹’çµ•å–æ¶ˆç”³è«‹ï¼Œè¨‚å–®ç‹€æ…‹å·²å›å¾©'); await loadOrders();
  }catch(err){ console.error(err); alert('æ‹’çµ•å–æ¶ˆå¤±æ•—ï¼š'+(err.message||err)); }
}
</script>
</body>
</html>