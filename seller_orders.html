<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP 二手商品平台 - 賣家訂單管理</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
    header {
      background:#1f354d; color:white; padding:16px 24px;
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { margin:0; font-size:22px; }

    .btn { padding:6px 12px; border:none; border-radius:4px; cursor:pointer; }
    .btn-light { background:#fff; color:#1f354d; }
    .btn-danger { background:#c0392b; color:#fff; }
    .btn-small { padding:4px 8px; font-size:12px; border-radius:4px; cursor:pointer; }

    .btn-accept  { background:#27ae60; color:white; }
    .btn-reject  { background:#e67e22; color:white; }

    /* ⭐ 新增：狀態修改按鈕樣式 */
    .btn-status-paid      { background:#2980b9; color:#fff; margin-right:4px; }
    .btn-status-shipped   { background:#16a085; color:#fff; margin-right:4px; }
    .btn-status-completed { background:#2ecc71; color:#fff; margin-right:4px; }

    .container { max-width:1100px; margin:24px auto; padding:0 16px; }

    .card {
      background:white; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:16px 20px; margin-bottom:16px;
    }

    .order-header { display:flex; justify-content:space-between; margin-bottom:6px; }
    .order-id { font-weight:bold; }

    .badge { padding:2px 8px; border-radius:10px; color:#fff; font-size:12px; }
    .badge-pending { background:#e67e22; }
    .badge-paid { background:#2980b9; }
    .badge-shipped { background:#16a085; }
    .badge-completed { background:#2ecc71; }
    .badge-canceled { background:#7f8c8d; }
    .badge-cancel-req { background:#f39c12; }

    .order-meta { font-size:13px; color:#555; margin-bottom:4px; }
    .order-total { margin-top:4px; font-weight:bold; }

    .items-list { margin-top:8px; border-top:1px solid #eee; padding-top:6px; font-size:13px; }

    /* ⭐ 新增：動作區塊 */
    .order-actions {
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:13px;
      align-items:center;
    }
    .actions-row { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
  </style>
</head>

<body>
<header>
  <h1>SGTP 二手商品平台 - 賣家訂單管理</h1>
  <div class="right">
    <button class="btn btn-light" onclick="location.href='seller_home.html'">回賣家後台</button>
    <button id="btnLogout" class="btn btn-danger">登出</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <h2>我的訂單（賣家）</h2>
    <p style="font-size:13px; color:#777;">
      顯示所有由你販售的商品所產生的訂單。<br>
      可直接修改訂單狀態為：
      <b>已付款 / 已出貨 / 已完成</b>。<br>
      若買家提出取消，可按「同意取消」或「拒絕取消」處理。
    </p>
  </div>

  <div id="ordersEmpty" style="display:none; color:#777;">目前沒有任何訂單。</div>
  <div id="ordersWrap"></div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  import {
    collection, query, where, getDocs,
    updateDoc, doc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const ordersWrap = document.getElementById("ordersWrap");
  const ordersEmpty = document.getElementById("ordersEmpty");
  const btnLogout = document.getElementById("btnLogout");

  let currentSellerUid = null;

  btnLogout.onclick = async () => {
    await signOut(auth);
    alert("已登出");
    location.href = "seller_login.html";
  };

  onAuthStateChanged(auth, async user => {
    if (!user) {
      alert("請先登入賣家帳號");
      location.href = "seller_login.html";
      return;
    }
    currentSellerUid = user.uid;
    loadOrders();
  });

  function formatDate(ts) {
    if (!ts || !ts.toDate) return "-";
    const d = ts.toDate();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mi = String(d.getMinutes()).padStart(2, "0");
    return `${yyyy}/${mm}/${dd} ${hh}:${mi}`;
  }

  function statusBadge(data) {
    const s = document.createElement("span");
    s.classList.add("badge");

    if (data.cancelStatus === "requested") {
      s.classList.add("badge-cancel-req");
      s.textContent = "取消申請中";
      return s;
    }
    if (data.status === "canceled") {
      s.classList.add("badge-canceled");
      s.textContent = "已取消";
      return s;
    }

    switch (data.status) {
      case "pending":
        s.classList.add("badge-pending");
        s.textContent = "pending";
        break;
      case "paid":
        s.classList.add("badge-paid");
        s.textContent = "已付款";
        break;
      case "shipped":
        s.classList.add("badge-shipped");
        s.textContent = "已出貨";
        break;
      case "completed":
        s.classList.add("badge-completed");
        s.textContent = "已完成";
        break;
      default:
        s.classList.add("badge-pending");
        s.textContent = data.status || "unknown";
    }
    return s;
  }

  async function loadOrders() {
    ordersWrap.innerHTML = "";
    ordersEmpty.style.display = "none";

    // 用 sellerId 查賣家自己的訂單
    const q = query(
      collection(db, "orders"),
      where("sellerId", "==", currentSellerUid)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      ordersEmpty.style.display = "block";
      return;
    }

    snap.forEach(docSnap => {
      const data = docSnap.data();

      const card = document.createElement("div");
      card.className = "card";

      const header = document.createElement("div");
      header.className = "order-header";

      const idDiv = document.createElement("div");
      idDiv.className = "order-id";
      idDiv.textContent = "訂單編號：" + docSnap.id;

      header.appendChild(idDiv);
      header.appendChild(statusBadge(data));

      const metaHtml = `
        <div class="order-meta">訂單日期：${formatDate(data.createdAt)}</div>
        <div class="order-meta">買家：${data.buyerEmail || ""}</div>
        <div class="order-meta">
          收件人：${data.shipName || ""}，
          電話：${data.shipPhone || ""}，
          地址：${data.shipAddress || ""}
        </div>
        <div class="order-total">訂單總額：NT$ ${data.totalAmount || 0}</div>
      `;

      // ⭐ 動作區塊
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "order-actions";

      // 1️⃣ 狀態修改按鈕（若已取消就不顯示）
      if (data.status !== "canceled") {
        const row1 = document.createElement("div");
        row1.className = "actions-row";

        const label = document.createElement("span");
        label.textContent = "變更訂單狀態：";

        const btnPaid = document.createElement("button");
        btnPaid.className = "btn-small btn-status-paid";
        btnPaid.textContent = "設為已付款";
        btnPaid.onclick = () => updateStatus(docSnap.id, "paid");

        const btnShipped = document.createElement("button");
        btnShipped.className = "btn-small btn-status-shipped";
        btnShipped.textContent = "設為已出貨";
        btnShipped.onclick = () => updateStatus(docSnap.id, "shipped");

        const btnCompleted = document.createElement("button");
        btnCompleted.className = "btn-small btn-status-completed";
        btnCompleted.textContent = "設為已完成";
        btnCompleted.onclick = () => updateStatus(docSnap.id, "completed");

        row1.appendChild(label);
        row1.appendChild(btnPaid);
        row1.appendChild(btnShipped);
        row1.appendChild(btnCompleted);

        actionsDiv.appendChild(row1);
      }

      // 2️⃣ 取消申請處理
      if (data.cancelStatus === "requested" && data.status !== "canceled") {
        const row2 = document.createElement("div");
        row2.className = "actions-row";

        const info = document.createElement("span");
        info.textContent =
          "買家已提出取消申請" +
          (data.cancelReason ? `（原因：${data.cancelReason}）` : "") +
          "。";

        const btnOk = document.createElement("button");
        btnOk.className = "btn-small btn-accept";
        btnOk.textContent = "同意取消";
        btnOk.onclick = () => approveCancel(docSnap.id);

        const btnNo = document.createElement("button");
        btnNo.className = "btn-small btn-reject";
        btnNo.textContent = "拒絕取消";
        btnNo.onclick = () => rejectCancel(docSnap.id);

        row2.appendChild(info);
        row2.appendChild(btnOk);
        row2.appendChild(btnNo);

        actionsDiv.appendChild(row2);
      } else if (data.cancelStatus === "approved" || data.status === "canceled") {
        const row = document.createElement("div");
        row.className = "actions-row";
        row.textContent = "此訂單已取消。";
        actionsDiv.appendChild(row);
      } else if (data.cancelStatus === "rejected") {
        const row = document.createElement("div");
        row.className = "actions-row";
        row.textContent = "已拒絕取消申請。";
        actionsDiv.appendChild(row);
      }

      // 商品明細（只顯示屬於此賣家的商品）
      const itemsDiv = document.createElement("div");
      itemsDiv.className = "items-list";

      if (Array.isArray(data.items)) {
        data.items
          .filter(it => !it.sellerId || it.sellerId === currentSellerUid)
          .forEach(it => {
            const line = document.createElement("div");
            line.textContent = `${it.title || "商品"} x ${it.qty || 1}（NT$ ${it.price || 0}）`;
            itemsDiv.appendChild(line);
          });
      } else {
        itemsDiv.textContent = "（無商品明細）";
      }

      card.appendChild(header);
      card.insertAdjacentHTML("beforeend", metaHtml);
      card.appendChild(actionsDiv);
      card.appendChild(itemsDiv);

      ordersWrap.appendChild(card);
    });
  }

  // ⭐ 修改訂單狀態
  async function updateStatus(orderId, newStatus) {
    const labelMap = {
      "paid": "已付款",
      "shipped": "已出貨",
      "completed": "已完成"
    };
    const ok = confirm(`確定要將此訂單狀態改為「${labelMap[newStatus] || newStatus}」嗎？`);
    if (!ok) return;

    try {
      await updateDoc(doc(db, "orders", orderId), {
        status: newStatus,
        updatedAt: serverTimestamp()
      });
      alert(`已將訂單狀態更新為「${labelMap[newStatus] || newStatus}」。`);
      loadOrders();
    } catch (err) {
      console.error(err);
      alert("更新訂單狀態失敗：" + err.message);
    }
  }

  // 同意取消
  async function approveCancel(id){
    const ok = confirm("確定要同意取消這筆訂單嗎？\n此操作會將訂單狀態設為『已取消』。");
    if (!ok) return;

    try {
      await updateDoc(doc(db,"orders",id),{
        status:"canceled",
        cancelStatus:"approved",
        canceledAt: serverTimestamp(),
        canceledBy: currentSellerUid
      });
      alert("已同意取消");
      loadOrders();
    } catch (err) {
      console.error(err);
      alert("同意取消失敗：" + err.message);
    }
  }

  // 拒絕取消
  async function rejectCancel(id){
    const ok = confirm("確定要拒絕取消申請嗎？");
    if (!ok) return;

    try {
      await updateDoc(doc(db,"orders",id),{
        cancelStatus:"rejected"
      });
      alert("已拒絕取消申請");
      loadOrders();
    } catch (err) {
      console.error(err);
      alert("拒絕取消失敗：" + err.message);
    }
  }
</script>

</body>
</html>
