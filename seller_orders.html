<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP 二手商品平台 - 賣家訂單管理</title>

  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
    header {
      background:#1f354d; color:white; padding:16px 24px;
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { margin:0; font-size:22px; }

    .btn { padding:6px 12px; border:none; border-radius:4px; cursor:pointer; }
    .btn-light { background:#fff; color:#1f354d; }
    .btn-danger { background:#c0392b; color:#fff; }
    .btn-small { padding:4px 8px; font-size:12px; border-radius:4px; cursor:pointer; }

    .btn-accept  { background:#27ae60; color:white; }
    .btn-reject  { background:#e67e22; color:white; }

    .btn-status-paid      { background:#2980b9; color:#fff; }
    .btn-status-shipped   { background:#16a085; color:#fff; }
    .btn-status-completed { background:#2ecc71; color:#fff; }

    .container { max-width:1100px; margin:24px auto; padding:0 16px; }

    .card {
      background:white; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:16px 20px; margin-bottom:16px;
    }

    .order-header {
      display:flex;
      justify-content:space-between;
      margin-bottom:6px;
    }

    .order-id { font-weight:bold; }

    .badge {
      padding:2px 8px;
      border-radius:10px;
      color:#fff;
      font-size:12px;
    }
    .badge-pending { background:#e67e22; }
    .badge-paid { background:#2980b9; }
    .badge-shipped { background:#16a085; }
    .badge-completed { background:#2ecc71; }
    .badge-canceled { background:#7f8c8d; }
    .badge-cancel-req { background:#f39c12; }

    .order-meta { font-size:13px; color:#555; margin-bottom:4px; }
    .order-total { margin-top:4px; font-weight:bold; }

    .items-list {
      margin-top:8px;
      border-top:1px solid #eee;
      padding-top:6px;
      font-size:13px;
    }

    .order-actions {
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      font-size:13px;
    }
    .actions-row {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
  </style>
</head>

<body>
<header>
  <h1>SGTP 二手商品平台 - 賣家訂單管理</h1>
  <div>
    <button class="btn btn-light" onclick="location.href='seller_home.html'">回賣家後台</button>
    <button id="btnLogout" class="btn btn-danger">登出</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <h2>我的訂單（賣家）</h2>
    <p style="font-size:13px; color:#777;">
      顯示所有包含你商品的訂單（新訂單結構）。<br>
      可修改狀態、處理取消申請。
    </p>
  </div>

  <div id="ordersEmpty" style="display:none; color:#777;">目前沒有任何訂單。</div>
  <div id="ordersWrap"></div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    collection, query, where, getDocs,
    updateDoc, doc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const ordersWrap = document.getElementById("ordersWrap");
  const ordersEmpty = document.getElementById("ordersEmpty");
  const btnLogout = document.getElementById("btnLogout");

  let currentSellerUid = null;

  btnLogout.onclick = async () => {
    await signOut(auth);
    location.href = "seller_login.html";
  };

  onAuthStateChanged(auth, async user => {
    if (!user) {
      location.href = "seller_login.html";
      return;
    }
    currentSellerUid = user.uid;
    loadOrders();
  });

  function formatDate(ts) {
    if (!ts || !ts.toDate) return "-";
    const d = ts.toDate();
    return d.toLocaleString();
  }

  function statusBadge(data) {
    const s = document.createElement("span");
    s.classList.add("badge");

    if (data.cancelStatus === "requested") {
      s.classList.add("badge-cancel-req");
      s.textContent = "取消申請中";
      return s;
    }
    if (data.status === "canceled") {
      s.classList.add("badge-canceled");
      s.textContent = "已取消";
      return s;
    }

    const map = {
      pending: ["badge-pending", "pending"],
      paid: ["badge-paid", "已付款"],
      shipped: ["badge-shipped", "已出貨"],
      completed: ["badge-completed", "已完成"]
    };

    const [cls, txt] = map[data.status] || ["badge-pending", data.status];
    s.classList.add(cls);
    s.textContent = txt;
    return s;
  }

  async function loadOrders() {
    ordersWrap.innerHTML = "";
    ordersEmpty.style.display = "none";

    const q = query(
      collection(db, "orders"),
      where("sellerIds", "array-contains", currentSellerUid)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      ordersEmpty.style.display = "block";
      return;
    }

    snap.forEach(docSnap => {
      const data = docSnap.data();

      const card = document.createElement("div");
      card.className = "card";

      const header = document.createElement("div");
      header.className = "order-header";

      const idDiv = document.createElement("div");
      idDiv.className = "order-id";
      idDiv.textContent = "訂單編號：" + docSnap.id;

      header.appendChild(idDiv);
      header.appendChild(statusBadge(data));

      const metaHtml = `
        <div class="order-meta">訂單日期：${formatDate(data.createdAt)}</div>
        <div class="order-meta">買家：${data.buyerEmail || ""}</div>
        <div class="order-meta">
          收件人：${data.shipName || ""}，
          電話：${data.shipPhone || ""}，
          地址：${data.shipAddress || ""}
        </div>
        <div class="order-total">訂單總額：NT$ ${data.totalAmount || 0}</div>
      `;

      const actionsDiv = document.createElement("div");
      actionsDiv.className = "order-actions";

      if (data.status !== "canceled") {
        const row = document.createElement("div");
        row.className = "actions-row";
        row.innerHTML = `
          <span>變更狀態：</span>
          <button class="btn-small btn-status-paid">已付款</button>
          <button class="btn-small btn-status-shipped">已出貨</button>
          <button class="btn-small btn-status-completed">已完成</button>
        `;

        const [btnPaid, btnShipped, btnCompleted] = row.querySelectorAll("button");
        btnPaid.onclick = () => updateStatus(docSnap.id, "paid");
        btnShipped.onclick = () => updateStatus(docSnap.id, "shipped");
        btnCompleted.onclick = () => updateStatus(docSnap.id, "completed");

        actionsDiv.appendChild(row);
      }

      if (data.cancelStatus === "requested" && data.status !== "canceled") {
        const row = document.createElement("div");
        row.className = "actions-row";
        row.innerHTML = `
          <span>買家申請取消${data.cancelReason ? `（原因：${data.cancelReason}）` : ""}</span>
          <button class="btn-small btn-accept">同意</button>
          <button class="btn-small btn-reject">拒絕</button>
        `;
        row.querySelector(".btn-accept").onclick = () => approveCancel(docSnap.id);
        row.querySelector(".btn-reject").onclick = () => rejectCancel(docSnap.id);
        actionsDiv.appendChild(row);
      }

      const itemsDiv = document.createElement("div");
      itemsDiv.className = "items-list";

      (data.items || [])
        .filter(it => it.sellerId === currentSellerUid)
        .forEach(it => {
          const line = document.createElement("div");
          line.textContent = `${it.title} x ${it.qty}（NT$ ${it.price}）`;
          itemsDiv.appendChild(line);
        });

      card.appendChild(header);
      card.insertAdjacentHTML("beforeend", metaHtml);
      card.appendChild(actionsDiv);
      card.appendChild(itemsDiv);

      ordersWrap.appendChild(card);
    });
  }

  async function updateStatus(orderId, status) {
    if (!confirm(`確定將狀態改為 ${status}？`)) return;
    await updateDoc(doc(db, "orders", orderId), {
      status,
      updatedAt: serverTimestamp()
    });
    loadOrders();
  }

  async function approveCancel(id) {
    if (!confirm("確定同意取消？")) return;
    await updateDoc(doc(db, "orders", id), {
      status: "canceled",
      cancelStatus: "approved",
      canceledAt: serverTimestamp()
    });
    loadOrders();
  }

  async function rejectCancel(id) {
    if (!confirm("確定拒絕取消？")) return;
    await updateDoc(doc(db, "orders", id), {
      cancelStatus: "rejected"
    });
    loadOrders();
  }
</script>
</body>
</html>
