<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>賣家評價 - SGTP</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; }
    header { background: #1f354d; color: white; padding: 16px 24px; display: flex; align-items: center; }
    .btn-back { background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; margin-right: 15px; }
    h1 { margin: 0; font-size: 20px; }

    .container { max-width: 800px; margin: 20px auto; padding: 0 16px; }
    
    /* 賣家資訊 */
    .seller-info-card { background: white; padding: 20px; border-radius: 8px; display: flex; align-items: center; gap: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .avatar { width: 60px; height: 60px; background: #bdc3c7; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; color: white; }
    .seller-meta h2 { margin: 0 0 5px 0; font-size: 18px; }
    .rating-big { color: #f39c12; font-weight: bold; font-size: 16px; }

    /* 評價列表 */
    .review-card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .r-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px; color: #555; }
    .r-user { font-weight: bold; color: #333; }
    
    /* ✅ [新增] 商品名稱樣式 */
    .r-product { 
        font-size: 13px; 
        color: #7f8c8d; 
        background: #f0f2f5; 
        padding: 4px 8px; 
        border-radius: 4px; 
        display: inline-block; 
        margin-bottom: 8px; 
    }

    .r-stars { color: #f39c12; margin-bottom: 6px; }
    .r-content { font-size: 15px; line-height: 1.5; color: #333; margin-bottom: 10px; }
    
    /* 賣家回覆 */
    .reply-box { background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid #1f354d; margin-top: 10px; font-size: 14px; }
    .reply-title { font-weight: bold; color: #1f354d; margin-bottom: 4px; font-size: 13px; }
    .reply-text { color: #555; }
    
    .empty-msg { text-align: center; color: #777; margin-top: 40px; }
  </style>
</head>
<body>

<header>
  <button class="btn-back" onclick="history.back()">&#8592;</button>
  <h1>賣家評價詳情</h1>
</header>

<div class="container">
  <div class="seller-info-card">
    <div class="avatar">S</div>
    <div class="seller-meta">
      <h2 id="sellerName">載入中...</h2>
      <div id="sellerRating" class="rating-big">-</div>
    </div>
  </div>

  <div id="reviewList">
    <div style="text-align:center; padding:20px;">載入評價中...</div>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const sellerId = params.get('sellerId');
  
  const sellerNameEl = document.getElementById('sellerName');
  const sellerRatingEl = document.getElementById('sellerRating');
  const reviewListEl = document.getElementById('reviewList');

  if(!sellerId) { alert('無效的連結'); window.location.href='index.html'; }

  // 1. 載入賣家資料
  fetch(`/api/users/${sellerId}`)
    .then(r => r.json())
    .then(user => {
      sellerNameEl.textContent = user.name || '未命名賣家';
      if(user.avg_rating) {
        sellerRatingEl.textContent = `★ ${Number(user.avg_rating).toFixed(1)} (${user.review_count} 則評價)`;
      } else {
        sellerRatingEl.textContent = '尚無評價';
      }
    });

  // 2. 載入評價列表
  fetch(`/api/users/${sellerId}/reviews`)
    .then(r => r.json())
    .then(reviews => {
      renderReviews(reviews);
    })
    .catch(err => {
      console.error(err);
      reviewListEl.innerHTML = '<div class="empty-msg">讀取失敗</div>';
    });

  function renderReviews(list) {
    reviewListEl.innerHTML = '';
    if(!list || list.length === 0) {
      reviewListEl.innerHTML = '<div class="empty-msg">此賣家目前還沒有收到任何評價。</div>';
      return;
    }

    list.forEach(r => {
      const stars = '★'.repeat(r.rating) + '☆'.repeat(5 - r.rating);
      const date = new Date(r.created_at).toLocaleDateString();
      // 名字遮碼 (例如: 王小明 -> 王*明)
      let buyerName = r.buyer_name || '匿名買家';
      if(buyerName.length > 1) buyerName = buyerName[0] + '*' + buyerName.slice(2);

      const div = document.createElement('div');
      div.className = 'review-card';
      

      let html = `
        <div class="r-header">
          <span class="r-user">${buyerName}</span>
          <span>${date}</span>
        </div>
        
        <div class="r-product">${r.product_title || '商品資料無法讀取'}</div>

        <div class="r-stars">${stars}</div>
        <div class="r-content">${r.comment || ''}</div>
      `;

      // 如果有回覆
      if(r.reply) {
        html += `
          <div class="reply-box">
            <div class="reply-title">賣家回覆：</div>
            <div class="reply-text">${r.reply}</div>
          </div>
        `;
      }

      div.innerHTML = html;
      reviewListEl.appendChild(div);
    });
  }
</script>

</body>
</html>