<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - 編輯商品</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f7f7f7; }
    header { background:#1f354d; color:white; padding:18px 32px; font-size:22px; display:flex; justify-content:space-between; align-items:center; }
    .user-info { font-size:14px; }
    .btn { padding:6px 12px; border-radius:4px; border:none; cursor:pointer; font-size:14px; margin-left:8px; }
    .btn-light { background:#ffffff; color:#1f354d; }
    .btn-danger { background:#c0392b; color:white; }
    .container { max-width:600px; margin:30px auto; background:white; padding:24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15); }
    label { display:block; margin-top:12px; font-size:14px; }
    input, textarea, select { width:100%; padding:8px; margin-top:4px; box-sizing:border-box; border-radius:4px; border:1px solid #ccc; font-family:inherit; }
    textarea { min-height:90px; resize:vertical; }
    .main-btn { margin-top:18px; width:100%; padding:10px; background:#1f354d; color:white; border:none; border-radius:4px; font-size:16px; cursor:pointer; }
    .sub-btn { margin-top:10px; width:100%; padding:10px; border:none; border-radius:4px; font-size:14px; cursor:pointer; }
    .msg-error { margin-top:10px; color:#c0392b; font-size:14px; }
    .msg-ok    { margin-top:10px; color:#27ae60; font-size:14px; }
    .back-link { margin-top:12px; font-size:14px; }
    .back-link a { color:#1f354d; text-decoration:none; }
    /* 圖片預覽區 */
    .img-preview-wrap { margin-top:8px; padding:8px; background:#fafafa; border:1px solid #eee; border-radius:4px; }
    .img-preview-label { font-size:12px; color:#777; margin-bottom:6px; }
    .thumb-list { display:flex; flex-wrap:wrap; gap:8px; }
    .thumb-item { width:80px; height:80px; border-radius:4px; overflow:hidden; background:#eee; position:relative; font-size:11px; color:#333; }
    .thumb-item img { width:100%; height:100%; object-fit:cover; display:block; }
    .thumb-badge { position:absolute; left:2px; top:2px; background:rgba(0,0,0,0.6); color:white; padding:1px 4px; border-radius:3px; font-size:10px; }
    .thumb-empty { font-size:12px; color:#999; }
  </style>
</head>
<body>
<header>
  <div>SGTP 二手商品平台 - 編輯商品</div>
  <div class="user-info">
    <span id="userName">賣家</span>
    <button class="btn btn-light" onclick="location.href='seller_home.html'">回賣家後台</button>
    <button id="btnLogout" class="btn btn-danger">登出</button>
  </div>
</header>

<div class="container">
  <h2 id="titleBar">編輯商品</h2>

  <div id="loading">載入中...</div>
  <div id="notFound" style="display:none; color:#c0392b;">找不到此商品，或你無權編輯。</div>

  <div id="formArea" style="display:none;">
    <label>商品名稱</label>
    <input id="prodTitle" type="text" />

    <!-- ⭐ 新增：商品分類 -->
    <label>商品分類</label>
    <select id="prodCategory">
      <option value="">請選擇分類</option>
      <option value="運動器材">運動器材</option>
      <option value="3C產品">3C產品</option>
      <option value="衣服">衣服</option>
      <option value="生活雜務">生活雜務</option>
      <option value="書籍">書籍</option>
      <option value="其他">其他</option>
    </select>

    <label>價格 (NT$)</label>
    <input id="prodPrice" type="number" min="0" />

    <label>庫存數量</label>
    <input id="prodStock" type="number" min="0" />

    <label>商品描述（可選）</label>
    <textarea id="prodDesc"></textarea>

    <!-- ⭐ 多張圖片輸入：每行一張網址 -->
    <label>商品圖片網址（可多張，一行一張）</label>
    <textarea id="prodImages" placeholder="例：\nhttps://example.com/pic1.jpg\nhttps://example.com/pic2.jpg"></textarea>
    <!-- 多張圖片預覽 -->
    <div class="img-preview-wrap">
      <div class="img-preview-label">圖片預覽（第 1 張會作為封面顯示）：</div>
      <div id="imgPreviewList" class="thumb-list"></div>
    </div>

    <button id="btnSave" class="main-btn">儲存變更</button>

    <button id="btnDelete" class="sub-btn btn-danger">刪除商品（無法復原）</button>

    <div id="msgError" class="msg-error"></div>
    <div id="msgOk" class="msg-ok"></div>

    <div class="back-link">
      <a href="seller_home.html">&lt; 返回賣家後台</a>
    </div>
  </div>
</div>

<script>
  // Helper
  const $ = id => document.getElementById(id);
  const FALLBACK_IMG = 'https://via.placeholder.com/400x300?text=No+Image';

  const userNameSpan = $('userName');
  const btnLogout = $('btnLogout');
  const loadingEl = $('loading');
  const notFoundEl = $('notFound');
  const formArea = $('formArea');

  // form elements
  const titleBar = $('titleBar');
  const titleInput = $('prodTitle');
  const categorySelect = $('prodCategory');
  const priceInput = $('prodPrice');
  const stockInput = $('prodStock');
  const descInput = $('prodDesc');
  const imagesInput = $('prodImages');
  const imgPreviewList = $('imgPreviewList');
  const btnSave = $('btnSave');
  const btnDelete = $('btnDelete');
  const msgErrorEl = $('msgError');
  const msgOkEl = $('msgOk');
  const params = new URLSearchParams(window.location.search);
  const pid = params.get('pid');

  let currentSellerUid = null;
  let currentProductData = null;

  function getAuthHeader(){ const t = localStorage.getItem('token'); return t?{ 'Authorization':'Bearer '+t } : {}; }

  // 渲染圖片預覽（每行一張）
  function renderPreview(){
    imgPreviewList.innerHTML = '';
    const raw = (imagesInput.value||'').split('\n').map(s=>s.trim()).filter(Boolean);
    if(!raw.length){ const span = document.createElement('div'); span.className='thumb-empty'; span.textContent='尚未設定圖片。'; imgPreviewList.appendChild(span); return; }
    raw.forEach((url, idx)=>{
      const wrap = document.createElement('div'); wrap.className='thumb-item';
      const img = document.createElement('img'); img.src = url; img.onerror = ()=>{ img.src = FALLBACK_IMG; };
      wrap.appendChild(img);
      if(idx===0){ const b = document.createElement('div'); b.className='thumb-badge'; b.textContent='封面'; wrap.appendChild(b); }
      imgPreviewList.appendChild(wrap);
    });
  }
  imagesInput && imagesInput.addEventListener('input', renderPreview);

  btnLogout.addEventListener('click', ()=>{ localStorage.removeItem('token'); window.location.href='seller_login.html'; });

  (async function(){
    try{
      const res = await fetch('/api/auth/me', { headers: getAuthHeader() });
      if(!res.ok){ alert('請先登入賣家帳號'); window.location.href='seller_login.html'; return; }
      const user = await res.json();
      if(!user || user.role !== 'seller'){ alert('此帳號不是賣家角色'); localStorage.removeItem('token'); window.location.href='seller_login.html'; return; }
      currentSellerUid = user.id; userNameSpan.textContent = user.name || user.email || '賣家';
      if(pid) await loadProduct();
    }catch(err){ console.error(err); alert('讀取使用者資料失敗：'+(err.message||err)); window.location.href='seller_login.html'; }
  })();

  async function loadProduct(){
    try{
      const res = await fetch('/api/products/' + encodeURIComponent(pid), { headers: getAuthHeader() });
      loadingEl.style.display = 'none';
      if(!res.ok){ notFoundEl.style.display='block'; notFoundEl.textContent='找不到此商品或您無權檢視'; return; }
      const data = await res.json(); currentProductData = data;
      const ownerId = data.seller_id || data.sellerId;
      if(!ownerId || String(ownerId) !== String(currentSellerUid)){ notFoundEl.textContent = '你不是此商品的賣家，無法編輯。'; notFoundEl.style.display='block'; return; }
      titleInput.value = data.title || '';
      categorySelect.value = data.category || '';
      priceInput.value = (typeof data.price === 'number' || data.price) ? data.price : '';
      stockInput.value = (typeof data.quantity === 'number' || data.quantity) ? data.quantity : (data.stock||'');
      descInput.value = data.description || data.desc || '';
      // images
      let imgArray = [];
      if(Array.isArray(data.images) && data.images.length) imgArray = data.images;
      else if(data.image) imgArray = [data.image];
      imagesInput.value = imgArray.join('\n'); renderPreview();
      titleBar.textContent = '編輯商品 - ' + (data.title||'(未命名)'); formArea.style.display = 'block';
    }catch(err){ console.error(err); loadingEl.style.display='none'; notFoundEl.textContent = '載入商品發生錯誤：'+(err.message||err); notFoundEl.style.display='block'; }
  }

  btnSave.addEventListener('click', async ()=>{
    msgErrorEl.textContent=''; msgOkEl.textContent='';
    const title = titleInput.value.trim(); const category = categorySelect.value; const priceStr = priceInput.value; const stockStr = stockInput.value;
    if(!title){ msgErrorEl.textContent='請填寫商品名稱。'; return; }
    if(!category){ msgErrorEl.textContent='請選擇商品分類。'; return; }
    if(priceStr==='' || stockStr===''){ msgErrorEl.textContent='請填寫價格與庫存數量。'; return; }
    const price = Number(priceStr); const stock = Number(stockStr);
    if(isNaN(price) || price<0){ msgErrorEl.textContent='價格格式不正確。'; return; }
    if(isNaN(stock) || stock<0){ msgErrorEl.textContent='庫存格式不正確。'; return; }
    const imagesArr = (imagesInput.value||'').split('\n').map(s=>s.trim()).filter(Boolean);
    try{
      btnSave.disabled = true; btnSave.textContent = '儲存中...';
      const payload = { title, category, price, quantity: stock, description: descInput.value.trim(), images: imagesArr, image: imagesArr[0] || null };
      const res = await fetch('/api/products/' + encodeURIComponent(pid), { method:'PUT', headers: Object.assign({ 'Content-Type':'application/json' }, getAuthHeader()), body: JSON.stringify(payload) });
      if(!res.ok){ const e = await res.json().catch(()=>null); throw new Error(e && e.error ? e.error : ('Status '+res.status)); }
      msgOkEl.textContent = '已成功更新商品資料！'; titleBar.textContent = '編輯商品 - '+title; renderPreview();
    }catch(err){ console.error(err); msgErrorEl.textContent = '更新失敗：'+(err.message||err); }
    finally{ btnSave.disabled = false; btnSave.textContent = '儲存變更'; }
  });
  btnDelete.addEventListener('click', async ()=>{
    if(!pid) return; if(!confirm('確定要刪除此商品嗎？\n刪除後無法復原，買家也將無法再看到此商品。')) return;
    try{ btnDelete.disabled = true; btnDelete.textContent = '刪除中...'; const res = await fetch('/api/products/' + encodeURIComponent(pid), { method:'DELETE', headers: getAuthHeader() }); if(!res.ok){ const e = await res.json().catch(()=>null); throw new Error(e && e.error ? e.error : ('Status '+res.status)); } alert('商品已刪除！'); window.location.href = 'seller_home.html'; }
    catch(err){ console.error(err); alert('刪除失敗：'+(err.message||err)); }
    finally{ btnDelete.disabled = false; btnDelete.textContent = '刪除商品（無法復原）'; }
  });
</script>
</body>
</html>
