<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - ç·¨è¼¯å•†å“</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f7f7f7; }
    /* Header */
    header {
      background: #2c3e50; /* æ·±è—è‰² */
      color: white;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header-logo {
      font-size: 20px;
      font-weight: bold;
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .icon-btn {
      color: white;
      text-decoration: none;
      font-size: 24px;
      cursor: pointer;
      position: relative;
    }
    .icon-btn:hover { opacity: 0.8; }

    /* ä¸‹æ‹‰é¸å–® */
    .user-menu {
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      height: 60px;
    }
    .user-name { font-size: 16px; font-weight: bold; margin-right: 5px; }
    .user-avatar {
      width: 32px; height: 32px;
      background-color: #bdc3c7;
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      font-size: 14px; color: #2c3e50;
      margin-right: 8px;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: white;
      min-width: 150px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 0 0 4px 4px;
      overflow: hidden;
      z-index: 1000;
    }
    .dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
    }
    .dropdown-content a:hover { background-color: #f5f5f5; color: #2c3e50; }
    .user-menu:hover .dropdown-content { display: block; }
    
    .container { max-width:600px; margin:30px auto; background:white; padding:24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15); }
    label { display:block; margin-top:12px; font-size:14px; }
    input, textarea, select { width:100%; padding:8px; margin-top:4px; box-sizing:border-box; border-radius:4px; border:1px solid #ccc; font-family:inherit; }
    textarea { min-height:90px; resize:vertical; }
    .main-btn { margin-top:18px; width:100%; padding:10px; background:#1f354d; color:white; border:none; border-radius:4px; font-size:16px; cursor:pointer; }
    .sub-btn { margin-top:10px; width:100%; padding:10px; border:none; border-radius:4px; font-size:14px; cursor:pointer; }
    .btn-danger { background:#c0392b; color:white; }
    .btn-danger:hover { background:#a93226; }
    
    .msg-error { margin-top:10px; color:#c0392b; font-size:14px; }
    .msg-ok    { margin-top:10px; color:#27ae60; font-size:14px; }
    .back-link { margin-top:12px; font-size:14px; }
    .back-link a { color:#1f354d; text-decoration:none; }
    
    /* åœ–ç‰‡é è¦½å€ */
    .img-preview-wrap { margin-top:8px; padding:8px; background:#fafafa; border:1px solid #eee; border-radius:4px; }
    .img-preview-label { font-size:12px; color:#777; margin-bottom:6px; }
    .thumb-list { display:flex; flex-wrap:wrap; gap:8px; }
    .thumb-item { width:80px; height:80px; border-radius:4px; overflow:hidden; background:#eee; position:relative; font-size:11px; color:#333; }
    .thumb-item img { width:100%; height:100%; object-fit:cover; display:block; }
    .thumb-badge { position:absolute; left:2px; top:2px; background:rgba(0,0,0,0.6); color:white; padding:1px 4px; border-radius:3px; font-size:10px; }
    .thumb-empty { font-size:12px; color:#999; }
  </style>
</head>
<body>
<header>
  <a href="seller_home.html" class="header-logo">SGTP-è³£å®¶ä¸­å¿ƒ</a>
  <div class="header-right">
    <a href="seller_chats.html" class="icon-btn" title="èŠèŠ">ğŸ’¬</a>
    <div class="user-menu">
      <div class="user-avatar">S</div>
      <span class="user-name" id="headerUserName">è³£å®¶</span>
      <span>â–¼</span>
      <div class="dropdown-content">
        <a href="seller_profile.html">æˆ‘çš„è³‡æ–™</a>
        <a href="#" id="headerLogoutBtn">ç™»å‡º</a>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <h2 id="titleBar">ç·¨è¼¯å•†å“</h2>

  <div id="loading">è¼‰å…¥ä¸­...</div>
  <div id="notFound" style="display:none; color:#c0392b;">æ‰¾ä¸åˆ°æ­¤å•†å“ï¼Œæˆ–ä½ ç„¡æ¬Šç·¨è¼¯ã€‚</div>

  <div id="formArea" style="display:none;">
    <label>å•†å“åç¨±</label>
    <input id="prodTitle" type="text" />

    <label>å•†å“åˆ†é¡</label>
    <select id="prodCategory">
      <option value="">è«‹é¸æ“‡åˆ†é¡</option>
      <option value="é‹å‹•å™¨æ">é‹å‹•å™¨æ</option>
      <option value="3Cç”¢å“">3Cç”¢å“</option>
      <option value="è¡£æœ">è¡£æœ</option>
      <option value="ç”Ÿæ´»é›œå‹™">ç”Ÿæ´»é›œå‹™</option>
      <option value="æ›¸ç±">æ›¸ç±</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>

    <label>åƒ¹æ ¼ (NT$)</label>
    <input id="prodPrice" type="number" min="0" />

    <label>åº«å­˜æ•¸é‡</label>
    <input id="prodStock" type="number" min="0" />

    <label>å•†å“æè¿°ï¼ˆå¯é¸ï¼‰</label>
    <textarea id="prodDesc"></textarea>
    
    <label>å•†å“åœ–ç‰‡ï¼ˆå¯å¤šå¼µï¼‰</label>
    <input type="file" id="imageFiles" accept="image/*" multiple />

    <div class="img-preview-wrap">
      <div class="img-preview-label">
        åœ–ç‰‡é è¦½ï¼ˆç¬¬ä¸€å¼µç‚ºå°é¢ï¼Œå¯åˆªé™¤ï¼‰ï¼š
      </div>
      <div id="imgPreviewList" class="thumb-list"></div>
    </div>

    <button id="btnSave" class="main-btn">å„²å­˜è®Šæ›´</button>

    <button id="btnDelete" class="sub-btn btn-danger">åˆªé™¤å•†å“ï¼ˆç„¡æ³•å¾©åŸï¼‰</button>

    <div id="msgError" class="msg-error"></div>
    <div id="msgOk" class="msg-ok"></div>

  </div>
</div>

<script>
  // Helper
  const $ = id => document.getElementById(id);
  const FALLBACK_IMG = 'https://via.placeholder.com/400x300?text=No+Image';

  const userNameSpan = $('headerUserName');
  const btnLogout = $('headerLogoutBtn');
  const loadingEl = $('loading');
  const notFoundEl = $('notFound');
  const formArea = $('formArea');

  // form elements
  const titleBar = $('titleBar');
  const titleInput = $('prodTitle');
  const categorySelect = $('prodCategory');
  const priceInput = $('prodPrice');
  const stockInput = $('prodStock'); // âœ… æ­£ç¢ºè®Šæ•¸åç¨±
  const descInput = $('prodDesc');
  const imgPreviewList = $('imgPreviewList');
  const btnSave = $('btnSave');
  const btnDelete = $('btnDelete');
  const msgErrorEl = $('msgError');
  const msgOkEl = $('msgOk');
  
  const params = new URLSearchParams(window.location.search);
  const pid = params.get('pid');

  const fileInput = $('imageFiles');
  let imageUrls = []; 

  let currentSellerUid = null;
  let currentProductData = null;

  function getAuthHeader(){ const t = localStorage.getItem('token'); return t?{ 'Authorization':'Bearer '+t } : {}; }

  // ç™»å‡º
  if(btnLogout){
      btnLogout.addEventListener('click', (e)=>{ 
          e.preventDefault();
          localStorage.removeItem('token'); 
          window.location.href='seller_login.html'; 
      });
  }

  // åˆå§‹åŒ–
  (async function(){
    try{
      const res = await fetch('/api/auth/me', { headers: getAuthHeader() });
      if(!res.ok){ alert('è«‹å…ˆç™»å…¥è³£å®¶å¸³è™Ÿ'); window.location.href='seller_login.html'; return; }
      
      const user = await res.json();
      if(!user || user.role !== 'seller'){ alert('æ­¤å¸³è™Ÿä¸æ˜¯è³£å®¶è§’è‰²'); localStorage.removeItem('token'); window.location.href='seller_login.html'; return; }
      
      currentSellerUid = user.id; 
      if(userNameSpan) userNameSpan.textContent = user.name || user.email || 'è³£å®¶';
      
      if(pid) await loadProduct();
      else {
          loadingEl.style.display='none';
          notFoundEl.textContent='ç¶²å€ç¼ºå°‘å•†å“IDåƒæ•¸';
          notFoundEl.style.display='block';
      }
    }catch(err){ 
        console.error(err); 
        alert('è®€å–ä½¿ç”¨è€…è³‡æ–™å¤±æ•—ï¼š'+(err.message||err)); 
        // window.location.href='seller_login.html'; 
    }
  })();

  async function loadProduct() {
    if (!pid) return;

    try {
      const res = await fetch('/api/products/' + encodeURIComponent(pid), { 
        headers: getAuthHeader() 
      });

      loadingEl.style.display = 'none';

      if (!res.ok) {
        let errMsg = 'æ‰¾ä¸åˆ°æ­¤å•†å“æˆ–æ‚¨ç„¡æ¬Šæª¢è¦–';
        try {
          const errData = await res.json();
          if (errData.error) errMsg = errData.error;
        } catch {}
        notFoundEl.style.display = 'block';
        notFoundEl.textContent = errMsg;
        return;
      }

      const data = await res.json();
      currentProductData = data;

      // æ¬Šé™æª¢æŸ¥
      const ownerId = data.seller_id || data.sellerId;
      if (!ownerId || String(ownerId) !== String(currentSellerUid)) {
        notFoundEl.style.display = 'block';
        notFoundEl.textContent = 'ä½ ä¸æ˜¯æ­¤å•†å“çš„è³£å®¶ï¼Œç„¡æ³•ç·¨è¼¯ã€‚';
        return;
      }

      // å¡«å…¥è³‡æ–™
      titleInput.value = data.title || '';
      categorySelect.value = data.category || '';
      priceInput.value = (typeof data.price === 'number' || data.price) ? data.price : '';
      stockInput.value = (typeof data.quantity === 'number' || data.quantity) ? data.quantity : (data.stock || '');
      descInput.value = data.description || data.desc || '';

      // åœ–ç‰‡è™•ç†
      let imgArray = [];
      if (Array.isArray(data.images) && data.images.length) imgArray = data.images;
      else if (data.image) imgArray = [data.image];

      imageUrls = imgArray.slice(); 
      renderImages();

      titleBar.textContent = 'ç·¨è¼¯å•†å“ - ' + (data.title || '(æœªå‘½å)');
      formArea.style.display = 'block';

    } catch (err) {
      console.error(err);
      loadingEl.style.display = 'none';
      notFoundEl.style.display = 'block';
      notFoundEl.textContent = 'è¼‰å…¥å•†å“ç™¼ç”ŸéŒ¯èª¤ï¼š' + (err.message || err);
    }
  }

  // å„²å­˜è®Šæ›´
  btnSave.addEventListener('click', async ()=>{
    msgErrorEl.textContent=''; msgOkEl.textContent='';
    const title = titleInput.value.trim(); 
    const category = categorySelect.value; 
    const priceStr = priceInput.value; 
    const stockStr = stockInput.value;

    if(!title){ msgErrorEl.textContent='è«‹å¡«å¯«å•†å“åç¨±ã€‚'; return; }
    if(!category){ msgErrorEl.textContent='è«‹é¸æ“‡å•†å“åˆ†é¡ã€‚'; return; }
    if(priceStr==='' || stockStr===''){ msgErrorEl.textContent='è«‹å¡«å¯«åƒ¹æ ¼èˆ‡åº«å­˜æ•¸é‡ã€‚'; return; }

    const price = Number(priceStr); 
    const stock = Number(stockStr);

    if(isNaN(price) || price<0){ msgErrorEl.textContent='åƒ¹æ ¼æ ¼å¼ä¸æ­£ç¢ºã€‚'; return; }
    if(isNaN(stock) || stock<0){ msgErrorEl.textContent='åº«å­˜æ ¼å¼ä¸æ­£ç¢ºã€‚'; return; }

    const imagesArr = imageUrls.slice(); 

    try{
      btnSave.disabled = true; 
      btnSave.textContent = 'å„²å­˜ä¸­...';

      const payload = { 
        title, 
        category, 
        price, 
        stock: stock,
        quantity: stock, 
        description: descInput.value.trim(), 
        images: imagesArr, 
        image: imagesArr[0] || null 
      };

      const res = await fetch('/api/seller/products/' + encodeURIComponent(pid), { 
        method:'PUT', 
        headers: Object.assign({ 'Content-Type':'application/json' }, getAuthHeader()), 
        body: JSON.stringify(payload) 
      });

      if(!res.ok){ 
        const e = await res.json().catch(()=>null); 
        throw new Error(e && e.error ? e.error : ('Status '+res.status)); 
      }

      msgOkEl.textContent = 'å·²æˆåŠŸæ›´æ–°å•†å“è³‡æ–™ï¼'; 
      titleBar.textContent = 'ç·¨è¼¯å•†å“ - '+title; 
      renderImages();

    }catch(err){ 
      console.error(err); 
      msgErrorEl.textContent = 'æ›´æ–°å¤±æ•—ï¼š'+(err.message||err); 
    }finally{ 
      btnSave.disabled = false; 
      btnSave.textContent = 'å„²å­˜è®Šæ›´'; 
      window.location.href = 'seller_home.html'; 
    }
  });

  // åˆªé™¤å•†å“
  btnDelete.addEventListener('click', async ()=>{
    if(!pid) return; if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿ\nåˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œè²·å®¶ä¹Ÿå°‡ç„¡æ³•å†çœ‹åˆ°æ­¤å•†å“ã€‚')) return;
    try{ 
        btnDelete.disabled = true; 
        btnDelete.textContent = 'åˆªé™¤ä¸­...'; 
        const res = await fetch('/api/seller/products/' + encodeURIComponent(pid), { method:'DELETE', headers: getAuthHeader() }); 
        if(!res.ok){ const e = await res.json().catch(()=>null); throw new Error(e && e.error ? e.error : ('Status '+res.status)); } 
        alert('å•†å“å·²åˆªé™¤ï¼'); 
        window.location.href = 'seller_home.html'; 
    }
    catch(err){ console.error(err); alert('åˆªé™¤å¤±æ•—ï¼š'+(err.message||err)); }
    finally{ btnDelete.disabled = false; btnDelete.textContent = 'åˆªé™¤å•†å“ï¼ˆç„¡æ³•å¾©åŸï¼‰'; }
  });

  // ä¸Šå‚³åœ–ç‰‡å‡½å¼
  async function uploadFile(file){
    const form = new FormData();
    form.append('file', file);

    const res = await fetch('/api/uploads', {
      method:'POST',
      headers: getAuthHeader(),
      body: form
    });
    if(!res.ok) throw new Error('Upload failed');
    const data = await res.json();
    return data.url;
  }

  // æ¸²æŸ“åœ–ç‰‡é è¦½
  function renderImages(){
    imgPreviewList.innerHTML = '';

    if(!imageUrls.length){
      const span = document.createElement('div');
      span.className = 'thumb-empty';
      span.textContent = 'å°šæœªä¸Šå‚³åœ–ç‰‡';
      imgPreviewList.appendChild(span);
      return;
    }

    imageUrls.forEach((url, idx)=>{
      const wrap = document.createElement('div');
      wrap.className = 'thumb-item';

      const img = document.createElement('img');
      img.src = url;
      wrap.appendChild(img);

      // å°é¢æ¨™ç±¤
      if(idx === 0){
        const badge = document.createElement('div');
        badge.className = 'thumb-badge';
        badge.textContent = 'å°é¢';
        wrap.appendChild(badge);
      }

      // åˆªé™¤æŒ‰éˆ•
      const del = document.createElement('button');
      del.className = 'thumb-del';
      del.textContent = 'âœ•';
      del.style.position = 'absolute';
      del.style.top = '2px';
      del.style.right = '2px';
      del.style.background = 'rgba(0,0,0,0.6)';
      del.style.color = 'white';
      del.style.border = 'none';
      del.style.borderRadius = '50%';
      del.style.width = '18px';
      del.style.height = '18px';
      del.style.fontSize = '12px';
      del.style.cursor = 'pointer';
      del.onclick = () => {
        imageUrls.splice(idx, 1); // å€‹åˆ¥åˆªé™¤
        renderImages();
      };
      wrap.appendChild(del);

      imgPreviewList.appendChild(wrap);
    });
  }

  // é¸æ“‡åœ–ç‰‡äº‹ä»¶
  fileInput.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files || []);
    for(const f of files){
      try{
        const url = await uploadFile(f);
        imageUrls.push(url);
        renderImages();
      }catch(err){
        alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—');
      }
    }
    fileInput.value = ''; // å…è¨±åŒæª”å†é¸
  });

  // âœ… [ä¿®æ­£] åº«å­˜è¼¸å…¥é™åˆ¶ (ç¢ºä¿è®Šæ•¸åç¨±æ­£ç¢º)
  stockInput.addEventListener('input', function() {
      const val = parseInt(this.value, 10);
      
      // å¦‚æœè¼¸å…¥éæ•¸å­—æˆ–å°æ–¼0ï¼Œä¿®æ­£å›0
      if (isNaN(val) || val < 0) {
        this.value = 0;
      } 
  });

</script>
</body>
</html>