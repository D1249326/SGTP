<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - 編輯商品</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f7f7f7; }
    header {
      background:#1f354d; color:white; padding:18px 32px;
      font-size:22px; display:flex; justify-content:space-between; align-items:center;
    }
    .user-info { font-size:14px; }
    .btn {
      padding:6px 12px; border-radius:4px; border:none;
      cursor:pointer; font-size:14px; margin-left:8px;
    }
    .btn-light { background:#ffffff; color:#1f354d; }
    .btn-danger { background:#c0392b; color:white; }

    .container {
      max-width:600px; margin:30px auto; background:white;
      padding:24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    h2 { margin-top:0; }

    label { display:block; margin-top:12px; font-size:14px; }
    input, textarea, select {
      width:100%; padding:8px; margin-top:4px; box-sizing:border-box;
      border-radius:4px; border:1px solid #ccc; font-family:inherit;
    }
    textarea { min-height:90px; resize:vertical; }

    .main-btn {
      margin-top:18px; width:100%; padding:10px;
      background:#1f354d; color:white; border:none; border-radius:4px;
      font-size:16px; cursor:pointer;
    }
    .main-btn:hover { background:#28486a; }

    .sub-btn {
      margin-top:10px; width:100%; padding:10px;
      border:none; border-radius:4px; font-size:14px; cursor:pointer;
    }

    .msg-error { margin-top:10px; color:#c0392b; font-size:14px; }
    .msg-ok    { margin-top:10px; color:#27ae60; font-size:14px; }

    .back-link { margin-top:12px; font-size:14px; }
    .back-link a { color:#1f354d; text-decoration:none; }

    /* 圖片預覽區 */
    .img-preview-wrap {
      margin-top:8px;
      padding:8px;
      background:#fafafa;
      border:1px solid #eee;
      border-radius:4px;
    }
    .img-preview-label {
      font-size:12px;
      color:#777;
      margin-bottom:6px;
    }
    .thumb-list {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .thumb-item {
      width:80px;
      height:80px;
      border-radius:4px;
      overflow:hidden;
      background:#eee;
      position:relative;
      font-size:11px;
      color:#333;
    }
    .thumb-item img {
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb-badge {
      position:absolute;
      left:2px;
      top:2px;
      background:rgba(0,0,0,0.6);
      color:white;
      padding:1px 4px;
      border-radius:3px;
      font-size:10px;
    }
    .thumb-empty {
      font-size:12px;
      color:#999;
    }
  </style>
</head>
<body>
<header>
  <div>SGTP 二手商品平台 - 編輯商品</div>
  <div class="user-info">
    <span id="userName">賣家</span>
    <button class="btn btn-light" onclick="location.href='seller_home.html'">回賣家後台</button>
    <button id="btnLogout" class="btn btn-danger">登出</button>
  </div>
</header>

<div class="container">
  <h2 id="titleBar">編輯商品</h2>

  <div id="loading">載入中...</div>
  <div id="notFound" style="display:none; color:#c0392b;">找不到此商品，或你無權編輯。</div>

  <div id="formArea" style="display:none;">
    <label>商品名稱</label>
    <input id="prodTitle" type="text" />

    <!-- ⭐ 新增：商品分類 -->
    <label>商品分類</label>
    <select id="prodCategory">
      <option value="">請選擇分類</option>
      <option value="運動器材">運動器材</option>
      <option value="3C產品">3C產品</option>
      <option value="衣服">衣服</option>
      <option value="生活雜務">生活雜務</option>
      <option value="書籍">書籍</option>
      <option value="其他">其他</option>
    </select>

    <label>價格 (NT$)</label>
    <input id="prodPrice" type="number" min="0" />

    <label>庫存數量</label>
    <input id="prodStock" type="number" min="0" />

    <label>商品描述（可選）</label>
    <textarea id="prodDesc"></textarea>

    <!-- ⭐ 多張圖片輸入：每行一張網址 -->
    <label>商品圖片網址（可多張，一行一張）</label>
    <textarea
      id="prodImages"
      placeholder="例：&#10;https://example.com/pic1.jpg&#10;https://example.com/pic2.jpg"
    ></textarea>

    <!-- 多張圖片預覽 -->
    <div class="img-preview-wrap">
      <div class="img-preview-label">圖片預覽（第 1 張會作為封面顯示）：</div>
      <div id="imgPreviewList" class="thumb-list"></div>
    </div>

    <button id="btnSave" class="main-btn">儲存變更</button>
    <!-- 刪除商品 -->
    <button id="btnDelete" class="sub-btn btn-danger">刪除商品（無法復原）</button>

    <div id="msgError" class="msg-error"></div>
    <div id="msgOk" class="msg-ok"></div>

    <div class="back-link">
      <a href="seller_home.html">&lt; 返回賣家後台</a>
    </div>
  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    doc, getDoc, updateDoc, deleteDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const $ = id => document.getElementById(id);

  const userNameSpan = $("userName");
  const btnLogout    = $("btnLogout");

  const loadingEl = $("loading");
  const notFoundEl = $("notFound");
  const formArea   = $("formArea");

  const titleBar   = $("titleBar");
  const titleInput = $("prodTitle");

  // ⭐ 新增：分類欄位元素
  const categorySelect = $("prodCategory");

  const priceInput = $("prodPrice");
  const stockInput = $("prodStock");
  const descInput  = $("prodDesc");

  // ⭐ 多圖相關元素
  const imagesInput   = $("prodImages");
  const imgPreviewList = $("imgPreviewList");

  const btnSave    = $("btnSave");
  const btnDelete  = $("btnDelete");

  const msgErrorEl = $("msgError");
  const msgOkEl    = $("msgOk");

  const FALLBACK_IMG = "https://via.placeholder.com/400x300?text=No+Image";

  // URL pid
  const params = new URLSearchParams(window.location.search);
  const pid = params.get("pid");

  let currentSellerUid = null;
  let currentProductData = null;

  if (!pid) {
    loadingEl.style.display = "none";
    notFoundEl.style.display = "block";
  }

  // 渲染圖片預覽
  function renderPreview() {
    imgPreviewList.innerHTML = "";
    const raw = imagesInput.value
      .split("\n")
      .map(s => s.trim())
      .filter(Boolean);

    if (!raw.length) {
      const span = document.createElement("div");
      span.className = "thumb-empty";
      span.textContent = "尚未設定圖片。";
      imgPreviewList.appendChild(span);
      return;
    }

    raw.forEach((url, idx) => {
      const wrap = document.createElement("div");
      wrap.className = "thumb-item";

      const img = document.createElement("img");
      img.src = url;
      img.onerror = () => { img.src = FALLBACK_IMG; };
      wrap.appendChild(img);

      if (idx === 0) {
        const badge = document.createElement("div");
        badge.className = "thumb-badge";
        badge.textContent = "封面";
        wrap.appendChild(badge);
      }

      imgPreviewList.appendChild(wrap);
    });
  }

  imagesInput.addEventListener("input", renderPreview);

  // 1. 確認登入、角色是 seller
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("請先登入賣家帳號");
      window.location.href = "seller_login.html";
      return;
    }
    try {
      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      if (!snap.exists() || snap.data().role !== "seller") {
        alert("此帳號不是賣家角色");
        await signOut(auth);
        window.location.href = "seller_login.html";
        return;
      }
      currentSellerUid = user.uid;
      userNameSpan.textContent = snap.data().name || snap.data().email || "賣家";

      if (pid) {
        await loadProduct();
      }
    } catch (err) {
      console.error(err);
      alert("讀取使用者資料失敗：" + err.message);
      window.location.href = "seller_login.html";
    }
  });

  // 2. 載入商品資料
  async function loadProduct() {
    try {
      const pRef = doc(db, "products", pid);
      const snap = await getDoc(pRef);

      loadingEl.style.display = "none";

      if (!snap.exists()) {
        notFoundEl.style.display = "block";
        return;
      }

      const data = snap.data();
      currentProductData = data;

      // 只允許自己的商品
      if (!data.sellerId || data.sellerId !== currentSellerUid) {
        notFoundEl.textContent = "你不是此商品的賣家，無法編輯。";
        notFoundEl.style.display = "block";
        return;
      }

      // 文字欄位
      titleInput.value = data.title || "";
      categorySelect.value = data.category || "";  // ⭐ 載入分類
      priceInput.value = (typeof data.price === "number") ? data.price : "";
      stockInput.value = (typeof data.stock === "number") ? data.stock : "";
      descInput.value  = data.desc || "";

      // ⭐ 多圖資料：優先 images，其次 image
      let imgArray = [];
      if (Array.isArray(data.images) && data.images.length > 0) {
        imgArray = data.images;
      } else if (data.image) {
        imgArray = [data.image];
      }
      imagesInput.value = imgArray.join("\n");
      renderPreview();

      titleBar.textContent = "編輯商品 - " + (data.title || "(未命名)");

      formArea.style.display = "block";
    } catch (err) {
      console.error(err);
      loadingEl.style.display = "none";
      notFoundEl.textContent = "載入商品發生錯誤：" + err.message;
      notFoundEl.style.display = "block";
    }
  }

  // 3. 儲存變更
  btnSave.addEventListener("click", async () => {
    msgErrorEl.textContent = "";
    msgOkEl.textContent = "";

    const title    = titleInput.value.trim();
    const category = categorySelect.value; // ⭐ 分類
    const priceStr = priceInput.value;
    const stockStr = stockInput.value;

    if (!title) {
      msgErrorEl.textContent = "請填寫商品名稱。";
      return;
    }
    if (!category) {
      msgErrorEl.textContent = "請選擇商品分類。";
      return;
    }
    if (priceStr === "" || stockStr === "") {
      msgErrorEl.textContent = "請填寫價格與庫存數量。";
      return;
    }

    const price = Number(priceStr);
    const stock = Number(stockStr);

    if (isNaN(price) || price < 0) {
      msgErrorEl.textContent = "價格格式不正確。";
      return;
    }
    if (isNaN(stock) || stock < 0) {
      msgErrorEl.textContent = "庫存格式不正確。";
      return;
    }

    // ⭐ 解析多張圖片
    const imagesArr = imagesInput.value
      .split("\n")
      .map(s => s.trim())
      .filter(Boolean);

    try {
      btnSave.disabled = true;
      btnSave.textContent = "儲存中...";

      const pRef = doc(db, "products", pid);
      await updateDoc(pRef, {
        title,
        category,                      // ⭐ 存入分類
        price,
        stock,
        desc: descInput.value.trim(),
        images: imagesArr,             // 多張圖片
        image: imagesArr[0] || null,   // 第一張當封面（給其他頁使用）
        updatedAt: serverTimestamp()
      });

      msgOkEl.textContent = "已成功更新商品資料！";
      titleBar.textContent = "編輯商品 - " + title;
      renderPreview();
    } catch (err) {
      console.error(err);
      msgErrorEl.textContent = "更新失敗：" + err.message;
    } finally {
      btnSave.disabled = false;
      btnSave.textContent = "儲存變更";
    }
  });

  // 4. 刪除商品
  btnDelete.addEventListener("click", async () => {
    if (!pid) return;
    const ok = confirm("確定要刪除此商品嗎？\n刪除後無法復原，買家也將無法再看到此商品。");
    if (!ok) return;

    try {
      btnDelete.disabled = true;
      btnDelete.textContent = "刪除中...";

      await deleteDoc(doc(db, "products", pid));

      alert("商品已刪除！");
      window.location.href = "seller_home.html";
    } catch (err) {
      console.error(err);
      alert("刪除失敗：" + err.message);
    } finally {
      btnDelete.disabled = false;
      btnDelete.textContent = "刪除商品（無法復原）";
    }
  });

  // 5. 登出
  btnLogout.addEventListener("click", async () => {
    try {
      await signOut(auth);
      window.location.href = "seller_login.html";
    } catch (err) {
      console.error(err);
      alert("登出失敗：" + err.message);
    }
  });
</script>
</body>
</html>
