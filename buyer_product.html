<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - 商品詳情</title>
  <style>
    body { margin:0; font-family: Arial,sans-serif; background:#f5f5f5; }
    
    /* ✅ [修改] Header 改用 Grid 佈局以達成標題置中 */
    header {
      background: #1f354d;
      color: #fff;
      padding: 0 16px;
      height: 60px; /* 固定高度 */
      display: grid;
      grid-template-columns: 60px 1fr 60px; /* 左、中、右 (左右固定寬度確保中間置中) */
      align-items: center;
    }

    /* ✅ [修改] 標題樣式 */
    header h1 {
      margin: 0;
      font-size: 20px;
      text-align: center; /* 強制置中 */
      white-space: nowrap;
    }

    /* ✅ [新增] Header 左側返回按鈕樣式 */
    .btn-header-back {
      background: transparent;
      border: none;
      color: white;
      font-size: 32px; /* 箭頭大一點 */
      cursor: pointer;
      padding: 0;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      line-height: 1;
    }
    .btn-header-back:hover { opacity: 0.8; }

    /* Header 右側佔位區塊 (保持平衡用) */
    .header-right { 
        display: flex; 
        justify-content: flex-end; 
    }
    
    /* 如果原本右邊還有連結，稍微調整樣式 */
    .header-right a { color:#fff; text-decoration:none; font-size:14px; }


    .container { max-width:900px; margin:24px auto; padding:0 16px; }
    .card {
      background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.15);
      display:flex; flex-wrap:wrap; overflow:hidden;
    }

    /* 圖片區 */
    .img-side {
      flex:0 0 360px; min-width:280px; background:#eee;
      display:flex; flex-direction:column;
    }
    .main-img-wrap{
      width:100%;
      height:360px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:#eee;
    }
    .main-img-wrap img{
      width:100%; height:100%; object-fit:cover;
    }
    .thumbs{
      display:flex;
      gap:8px;
      padding:10px;
      overflow-x:auto;
      background:#fafafa;
      border-top:1px solid #eee;
    }
    .thumb{
      width:64px; height:64px;
      border-radius:6px;
      overflow:hidden;
      border:2px solid transparent;
      cursor:pointer;
      background:#eaeaea;
      flex:0 0 auto;
    }
    .thumb img{
      width:100%; height:100%; object-fit:cover;
    }
    .thumb.active{ border-color:#1f354d; }

    .info-side {
      flex:1; padding:20px 24px;
      display:flex; flex-direction:column; gap:10px;
    }
    .title { font-size:22px; font-weight:bold; }
    .price { font-size:20px; color:#c0392b; font-weight:bold; }
    .stock { font-size:14px; color:#555; }
    .small { font-size:13px; color:#777; }

    /* ⭐ 分類標籤 */
    .cat-tag {
      display:inline-block;
      width:fit-content;
      font-size:12px;
      color:#1f354d;
      background:#eef3fa;
      padding:3px 10px;
      border-radius:999px;
      margin-top:2px;
    }

    .desc { margin-top:12px; line-height:1.5; font-size:15px; white-space:pre-wrap; }
    .btn-row { margin-top:20px; display:flex; gap:10px; flex-wrap:wrap; }

    .btn {
      padding:8px 14px; border-radius:4px; border:none; cursor:pointer;
      font-size:14px;
    }
    .btn-back { background:#bdc3c7; color:#2c3e50; }
    .btn-cart { background:#1f354d; color:#fff; }

    /* ✅ [新增] 聊天按鈕樣式 */
    .btn-chat { background:#e67e22; color:#fff; }
    .btn-chat:hover { opacity: 0.9; }

    .msg { margin-top:16px; font-size:14px; color:#c0392b; }
    .msg-ok { color:#27ae60; }

    .qty-box { margin-top:10px; font-size:14px; }
    .qty-box input { width:90px; padding:6px; }

    .loading, .notfound{
      padding:14px 0;
      color:#555;
      text-align:center;
    }

    /* ===== 主圖滑動區 ===== */
  .main-img-wrap {
    width:100%;
    height:360px;
    overflow:hidden;
    background:#eee;
    position:relative;
  }

  .img-track {
    display:flex;
    height:100%;
    transition:transform 0.3s ease;
  }

  .img-track img {
    width:100%;
    height:100%;
    object-fit:cover;
    flex:0 0 100%;
    user-select:none;
    pointer-events:none;
  }

  /* ===== 縮圖 ===== */
  .thumbs {
    display:flex;
    gap:8px;
    padding:10px;
    overflow-x:auto;
    background:#fafafa;
    border-top:1px solid #eee;
  }

  .thumb {
    width:64px;
    height:64px;
    border-radius:6px;
    overflow:hidden;
    border:2px solid transparent;
    cursor:pointer;
    flex:0 0 auto;
  }

  .thumb img {
    width:100%;
    height:100%;
    object-fit:cover;
  }

  .thumb.active {
    border-color:#1f354d;
  }

  </style>
</head>
<body>

<header>
  <button class="btn-header-back" onclick="history.back()">&#8249;</button>

  <h1>商品詳情</h1>

  <div class="header-right">
     </div>
</header>

<div class="container">
  <div id="loading" class="loading">載入中...</div>
  <div id="notFound" class="notfound" style="display:none;">找不到此商品。</div>

  <div id="productCard" class="card" style="display:none;">
    <div class="img-side">
      <div class="main-img-wrap">
        <div id="imgTrack" class="img-track"></div>
      </div>

      <div id="thumbs" class="thumbs"></div>

    </div>

    <div class="info-side">
      <div class="title" id="prodTitle"></div>

      <div class="cat-tag" id="prodCategory"></div>

      <div class="price" id="prodPrice"></div>
      <div class="stock" id="prodStock"></div>
      <div class="small" id="prodSeller"></div>

      <div class="desc" id="prodDesc"></div>

      <div class="qty-box">
        購買數量：
        <input id="buyQty" type="number" min="1" value="1">
        <span class="small" id="qtyHint"></span>
      </div>

      <div class="btn-row">
        <button class="btn btn-back" onclick="location.href='buyer_shop.html'">&lt; 回商品列表</button>
        
        <button class="btn btn-cart" id="btnAddCart">加入購物車</button>

        <button class="btn btn-chat" id="btnChat" style="display:none;">聯絡賣家</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>
  </div>
</div>


 <script>
  const FALLBACK_IMG = 'https://via.placeholder.com/400x300?text=No+Image';
  const imgEl = document.getElementById('prodImg'); 
  const titleEl = document.getElementById('prodTitle'); 
  const priceEl = document.getElementById('prodPrice'); 
  const stockEl = document.getElementById('prodStock'); 
  const sellerEl = document.getElementById('prodSeller'); 
  const descEl = document.getElementById('prodDesc'); 
  const qtyInput = document.getElementById('buyQty'); 
  const msgEl = document.getElementById('msg'); 
  const btnAddCart = document.getElementById('btnAddCart');
  const btnChat = document.getElementById('btnChat'); 
  const categoryEl = document.getElementById('prodCategory');

  let currentProductId = null; let currentProductData = null; let currentUser = null;
  const params = new URLSearchParams(window.location.search); const pid = params.get('id'); if (pid) { currentProductId = pid; loadProduct(pid); }
  function getAuthHeader(){ const t = localStorage.getItem('token'); return t?{ 'Authorization':'Bearer '+t, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' }; }

  async function loadProduct(productId){
    try{
      const res = await fetch('/api/products/' + encodeURIComponent(productId));
      if (!res.ok) { document.getElementById('loading').style.display='none'; document.getElementById('notFound').style.display='block'; return; }
      const p = await res.json(); currentProductData = p;
      const imgs = Array.isArray(p.images) && p.images.length ? p.images : (p.image ? [p.image] : []); renderImages(imgs);
      titleEl.textContent = p.title || '';
      categoryEl.textContent = p.category || '其他';
      priceEl.textContent = 'NT$ ' + (p.price || 0);
      
      const realStock = (p.stock !== undefined && p.stock !== null) ? p.stock : (p.quantity || 0);
      stockEl.textContent = '庫存：' + realStock;
      qtyInput.max = realStock; 
      if (realStock <= 0) {
        btnAddCart.disabled = true;
        btnAddCart.textContent = '已售完';
        qtyInput.disabled = true;
      }      

      descEl.textContent = p.description || p.desc || '';
      
      const sellerId = p.seller_id || p.sellerId;
      if (sellerId) {
        try{ 
          const s = await fetch('/api/users/' + encodeURIComponent(sellerId)); 
          if (s.ok){ 
            const js = await s.json(); 
            const sName = js.name || '未命名賣家';
            sellerEl.innerHTML = `賣家：<a href="buyer_seller_shop.html?sellerId=${sellerId}" style="color:#1f354d; text-decoration:underline; font-weight:bold; cursor:pointer;">${sName} &rsaquo;</a>`;
          } else { 
            sellerEl.textContent = '賣家：未知'; 
          } 
        } catch(e){ sellerEl.textContent = '賣家：未知'; }

        if (btnChat) {
          btnChat.style.display = 'inline-block';
          btnChat.onclick = () => {
            location.href = `chat.html?targetId=${sellerId}&role=buyer&productId=${currentProductId}`;
          };
        }

      } else {
        sellerEl.textContent = '賣家：未知';
      }

      document.getElementById('loading').style.display = 'none'; document.getElementById('productCard').style.display = 'flex';
    }catch(err){ console.error(err); msgEl.textContent = '載入商品發生錯誤：' + (err.message||err); }
  }

  // 加入購物車
  btnAddCart.addEventListener('click', async ()=>{
    msgEl.textContent = ''; msgEl.classList.remove('msg-ok');
    try{
      const me = await fetch('/api/auth/me', { headers: getAuthHeader() });
      if (!me.ok) { alert('請先登入買家帳號！'); window.location.href='buyer_login.html'; return; }
      currentUser = await me.json();
      if (!currentUser || currentUser.role !== 'buyer') { alert('請使用買家帳號登入'); return; }
      
      const qty = Number(qtyInput.value); 
      if (qty <= 0) return msgEl.textContent = '購買數量必須大於 0';
      
      btnAddCart.disabled = true; 
      btnAddCart.textContent = '加入中...';
      
      const payload = { 
        productId: currentProductId, 
        title: currentProductData.title, 
        price: currentProductData.price, 
        qty: qty, 
        image: (currentProductData.image || ''), 
        sellerId: currentProductData.seller_id || currentProductData.sellerId || null 
      };
      
      const res = await fetch('/api/cart/items', { 
        method: 'POST', 
        headers: getAuthHeader(), 
        body: JSON.stringify(payload) 
      });
      
      if (!res.ok) { 
        const e = await res.json().catch(()=>null); 
        throw new Error(e && e.error ? e.error : ('Status ' + res.status)); 
      }
      
      msgEl.classList.add('msg-ok'); 
      msgEl.textContent = '已加入購物車！';
      qtyInput.value = 1;

    }catch(err){ 
      console.error(err); 
      msgEl.textContent = '加入失敗：' + (err.message||err); 
    } finally { 
      btnAddCart.disabled=false; 
      btnAddCart.textContent='加入購物車'; 
    }
  });

  const imgTrack = document.getElementById('imgTrack');
  const thumbsEl = document.getElementById('thumbs');
  let images = [];
  let currentIndex = 0;

  function renderImages(imgs) {
    images = imgs.length ? imgs : [FALLBACK_IMG];
    imgTrack.innerHTML = '';
    thumbsEl.innerHTML = '';
    images.forEach((src, i) => {
      const img = document.createElement('img'); img.src = src; imgTrack.appendChild(img);
      const t = document.createElement('div'); t.className = 'thumb' + (i === 0 ? ' active' : ''); t.innerHTML = `<img src="${src}">`; t.onclick = () => goTo(i); thumbsEl.appendChild(t);
    });
    thumbsEl.style.display = images.length > 1 ? 'flex' : 'none';
    goTo(0);
  }

  function goTo(index) {
    if (index < 0 || index >= images.length) return;
    currentIndex = index;
    imgTrack.style.transform = `translateX(-${index * 100}%)`;
    document.querySelectorAll('.thumb').forEach((t, i) => { t.classList.toggle('active', i === index); });
  }

  let startX = 0;
  imgTrack.addEventListener('touchstart', e => startX = e.touches[0].clientX);
  imgTrack.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - startX;
    if (dx > 50) goTo(currentIndex - 1);
    if (dx < -50) goTo(currentIndex + 1);
  });

  qtyInput.addEventListener('input', function() {
      const max = parseInt(this.max, 10);
      let val = parseInt(this.value, 10);
      if (isNaN(val) || val < 1) { this.value = 1; } 
      else if (val > max) {
        this.value = max;
        const hint = document.getElementById('qtyHint'); 
        if(hint) { hint.textContent = `(庫存僅剩 ${max} 件)`; hint.style.color = 'red'; setTimeout(() => hint.textContent = '', 2000); } 
        else { msgEl.textContent = `已達購買上限 (庫存 ${max})`; msgEl.style.color = '#c0392b'; setTimeout(() => msgEl.textContent = '', 2000); }
      }
    });
</script>

</body>
</html>