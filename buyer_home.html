<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - è²·å®¶é¦–é </title>
  <style>
    /* ========== Header æ¨£å¼ (ä¿æŒä¸è®Š) ========== */
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
    header { background: #1f354d; color: white; padding: 10px 24px; display: flex; align-items: center; gap: 20px; position: sticky; top: 0; z-index: 1000; height: 50px; }
    .logo { font-size: 28px; font-weight: bold; color: white; text-decoration: none; white-space: nowrap; margin-right: 10px; }
    .header-search { flex: 1; max-width: 600px; margin: 0 auto; display: flex; position: relative; }
    .header-search input { width: 100%; padding: 8px 36px 8px 12px; border-radius: 4px; border: none; font-size: 14px; outline: none; }
    .header-right { display: flex; align-items: center; gap: 20px; margin-left: auto; }
    .icon-btn { color: white; text-decoration: none; font-size: 24px; transition: opacity 0.2s; cursor: pointer; display: flex; align-items: center; }
    .icon-btn:hover { opacity: 0.8; }
    .user-menu { position: relative; cursor: pointer; display: flex; align-items: center; height: 50px; padding-left: 8px; }
    .user-name { font-size: 16px; font-weight: bold; color: white; }
    .user-name::after { content: ' â–¼'; font-size: 10px; margin-left: 6px; vertical-align: middle; }
    .dropdown-content { display: none; position: absolute; top: 100%; right: 0; background-color: white; min-width: 140px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 0 0 4px 4px; overflow: hidden; z-index: 1001; }
    .dropdown-content a { color: #333; padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; border-bottom: 1px solid #f0f0f0; }
    .dropdown-content a:hover { background-color: #f5f5f5; color: #1f354d; }
    .user-menu:hover .dropdown-content { display: block; }

    /* ========== é é¢å…§å®¹ ========== */
    .container { max-width: 900px; margin: 40px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    h2 { margin-top: 0; }
    .btn { padding: 8px 14px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; }
    .btn-light { background: #ffffff; color: #1f354d; border: 1px solid #ccc; }
    .btn-primary { background: #1f354d; color: white; }
    .btn-secondary { background: #bdc3c7; color: #2c3e50; }
    .info-row, .edit-row { margin: 8px 0; }
    .label, .edit-row label { display: inline-block; width: 80px; color: #555; }
    .edit-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
    .edit-row input { width: 260px; padding: 6px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
    .msg { margin-top: 10px; font-size: 14px; color: #c0392b; }
    .msg-ok { color: #27ae60; }

    /* âœ… [æ–°å¢] åœ°å€é¸æ“‡å™¨æ¨£å¼ */
    .address-group { display: inline-flex; gap: 8px; align-items: center; }
    .address-group select { padding: 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
    .address-group input { width: 160px; } /* ç¸®çŸ­è¡—é“è¼¸å…¥æ¡†ä»¥é©æ‡‰åŒä¸€è¡Œ */
  </style>
</head>
<body>

  <header>
    <a href="buyer_shop.html" class="logo">SGTP</a>
    
    <div class="header-search">
      <input id="navSearch" type="text" placeholder="æœå°‹å•†å“åç¨±..." />
    </div>

    <div class="header-right">
      <a href="buyer_cart.html" class="icon-btn" title="è³¼ç‰©è»Š">ğŸ›’</a>
      <a href="buyer_chats.html" class="icon-btn" title="èŠå¤©å®¤">ğŸ’¬</a>
      <div class="user-menu">
        <span class="user-name" id="headerUser">è¼‰å…¥ä¸­...</span>
        <div class="dropdown-content">
          <a href="buyer_home.html">æˆ‘çš„è³‡æ–™</a>
          <a href="buyer_orders.html">è¨‚å–®æŸ¥è©¢</a>
          <a href="#" id="headerLogoutBtn">ç™»å‡º</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <h2 id="welcome">æ­¡è¿ï¼Œè²·å®¶ï¼</h2>
    <div id="displaySection">
      <div class="info-row"><span class="label">å§“åï¼š</span><span id="buyerName">-</span></div>
      <div class="info-row"><span class="label">Emailï¼š</span><span id="buyerEmail">-</span></div>
      <div class="info-row"><span class="label">é›»è©±ï¼š</span><span id="buyerPhone">-</span></div>
      <div class="info-row"><span class="label">åœ°å€ï¼š</span><span id="buyerAddress">-</span></div>
      <div class="info-row"><span class="label">è§’è‰²ï¼š</span><span id="buyerRole">-</span></div>
      <button id="btnEdit" class="btn btn-light" style="margin-top:16px;">âœ ç·¨è¼¯è³‡æ–™</button>
    </div>

    <div id="editSection" class="edit-section" style="display:none;">
      <h3>ç·¨è¼¯å€‹äººè³‡æ–™</h3>
      <div class="edit-row"><label>å§“åï¼š</label><input id="editName" type="text" /></div>
      <div class="edit-row"><label>Emailï¼š</label><input id="editEmail" type="email" /></div>
      
      <div class="edit-row">
        <label>é›»è©±ï¼š</label>
        <input id="editPhone" type="text" placeholder="è«‹è¼¸å…¥ 10 ç¢¼æ•¸å­— (å¦‚ 0912345678)" maxlength="10" />
      </div>

      <div class="edit-row">
        <label>åœ°å€ï¼š</label>
        <div class="address-group">
          <select id="citySelect"><option value="">ç¸£å¸‚</option></select>
          <select id="distSelect"><option value="">åœ°å€</option></select>
          <input id="streetInput" type="text" placeholder="è·¯åã€å··å¼„ã€é–€ç‰Œè™Ÿç¢¼" />
        </div>
      </div>

      <hr style="margin:14px 0;" />
      <div class="edit-row"><label>å¯†ç¢¼ï¼š</label><input id="editPassword" type="password" placeholder="è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼ï¼ˆé©—è­‰ç”¨ï¼‰" /></div>
      <div style="margin-top:12px;">
        <button id="btnSave" class="btn btn-primary">å„²å­˜è®Šæ›´</button>
        <button id="btnCancel" class="btn btn-secondary" style="margin-left:8px;">å–æ¶ˆ</button>
      </div>
      <div id="msg" class="msg"></div>
    </div>
  </div>

  <script>
    // âœ… [æ–°å¢] å°ç£ç¸£å¸‚å€åŸŸè³‡æ–™
    const TAIWAN_AREAS = {
      "å°åŒ—å¸‚": ["ä¸­æ­£å€","å¤§åŒå€","ä¸­å±±å€","æ¾å±±å€","å¤§å®‰å€","è¬è¯å€","ä¿¡ç¾©å€","å£«æ—å€","åŒ—æŠ•å€","å…§æ¹–å€","å—æ¸¯å€","æ–‡å±±å€"],
      "æ–°åŒ—å¸‚": ["æ¿æ©‹å€","æ–°èŠå€","ä¸­å’Œå€","æ°¸å’Œå€","åœŸåŸå€","æ¨¹æ—å€","ä¸‰å³½å€","é¶¯æ­Œå€","ä¸‰é‡å€","è˜†æ´²å€","äº”è‚¡å€","æ³°å±±å€","æ—å£å€","å…«é‡Œå€","æ·¡æ°´å€","ä¸‰èŠå€","çŸ³é–€å€","é‡‘å±±å€","è¬é‡Œå€","æ±æ­¢å€","ç‘èŠ³å€","è²¢å¯®å€","å¹³æºªå€","é›™æºªå€","æ–°åº—å€","æ·±å‘å€","çŸ³ç¢‡å€","åªæ—å€","çƒä¾†å€"],
      "åŸºéš†å¸‚": ["ä»æ„›å€","ä¿¡ç¾©å€","ä¸­æ­£å€","ä¸­å±±å€","å®‰æ¨‚å€","æš–æš–å€","ä¸ƒå µå€"],
      "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€","ä¸­å£¢å€","å¤§æºªå€","æ¥Šæ¢…å€","è˜†ç«¹å€","å¤§åœ’å€","é¾œå±±å€","å…«å¾·å€","é¾æ½­å€","å¹³é®å€","æ–°å±‹å€","è§€éŸ³å€","å¾©èˆˆå€"],
      "æ–°ç«¹å¸‚": ["æ±å€","åŒ—å€","é¦™å±±å€"],
      "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚","ç«¹æ±é®","æ–°åŸ”é®","é—œè¥¿é®","æ¹–å£é„‰","æ–°è±é„‰","èŠæ—é„‰","æ©«å±±é„‰","åŒ—åŸ”é„‰","å¯¶å±±é„‰","å³¨çœ‰é„‰","å°–çŸ³é„‰","äº”å³°é„‰"],
      "è‹—æ —ç¸£": ["è‹—æ —å¸‚","é ­ä»½å¸‚","è‹‘è£¡é®","é€šéœ„é®","ç«¹å—é®","å¾Œé¾é®","å“è˜­é®","å¤§æ¹–é„‰","å…¬é¤¨é„‰","éŠ…é‘¼é„‰","å—åº„é„‰","é ­å±‹é„‰","ä¸‰ç¾©é„‰","è¥¿æ¹–é„‰","é€ æ©‹é„‰","ä¸‰ç£é„‰","ç…æ½­é„‰","æ³°å®‰é„‰"],
      "å°ä¸­å¸‚": ["ä¸­å€","æ±å€","å—å€","è¥¿å€","åŒ—å€","åŒ—å±¯å€","è¥¿å±¯å€","å—å±¯å€","å¤ªå¹³å€","å¤§é‡Œå€","éœ§å³°å€","çƒæ—¥å€","è±åŸå€","åé‡Œå€","çŸ³å²¡å€","æ±å‹¢å€","å’Œå¹³å€","æ–°ç¤¾å€","æ½­å­å€","å¤§é›…å€","ç¥å²¡å€","å¤§è‚šå€","æ²™é¹¿å€","é¾äº•å€","æ¢§æ£²å€","æ¸…æ°´å€","å¤§ç”²å€","å¤–åŸ”å€","å¤§å®‰å€"],
      "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚","å“¡æ—å¸‚","é¹¿æ¸¯é®","å’Œç¾é®","åŒ—æ–—é®","æºªæ¹–é®","ç”°ä¸­é®","äºŒæ—é®","ç·šè¥¿é„‰","ä¼¸æ¸¯é„‰","ç¦èˆˆé„‰","ç§€æ°´é„‰","èŠ±å£‡é„‰","èŠ¬åœ’é„‰","å¤§æ‘é„‰","åŸ”é¹½é„‰","åŸ”å¿ƒé„‰","æ°¸é–é„‰","ç¤¾é ­é„‰","äºŒæ°´é„‰","ç”°å°¾é„‰","åŸ¤é ­é„‰","èŠ³è‹‘é„‰","å¤§åŸé„‰","ç«¹å¡˜é„‰","æºªå·é„‰"],
      "å—æŠ•ç¸£": ["å—æŠ•å¸‚","åŸ”é‡Œé®","è‰å±¯é®","ç«¹å±±é®","é›†é›†é®","åé–“é„‰","é¹¿è°·é„‰","ä¸­å¯®é„‰","é­šæ± é„‰","åœ‹å§“é„‰","æ°´é‡Œé„‰","ä¿¡ç¾©é„‰","ä»æ„›é„‰"],
      "é›²æ—ç¸£": ["æ–—å…­å¸‚","æ–—å—é®","è™å°¾é®","è¥¿èºé®","åœŸåº«é®","åŒ—æ¸¯é®","å¤å‘é„‰","å¤§åŸ¤é„‰","è¿æ¡é„‰","æ—å…§é„‰","äºŒå´™é„‰","å´™èƒŒé„‰","éº¥å¯®é„‰","æ±å‹¢é„‰","è¤’å¿ é„‰","è‡ºè¥¿é„‰","å…ƒé•·é„‰","å››æ¹–é„‰","å£æ¹–é„‰","æ°´æ—é„‰"],
      "å˜‰ç¾©å¸‚": ["æ±å€","è¥¿å€"],
      "å˜‰ç¾©ç¸£": ["å¤ªä¿å¸‚","æœ´å­å¸‚","å¸ƒè¢‹é®","å¤§æ—é®","æ°‘é›„é„‰","æºªå£é„‰","æ–°æ¸¯é„‰","å…­è…³é„‰","æ±çŸ³é„‰","ç¾©ç«¹é„‰","é¹¿è‰é„‰","æ°´ä¸Šé„‰","ä¸­åŸ”é„‰","ç«¹å´é„‰","æ¢…å±±é„‰","ç•ªè·¯é„‰","å¤§åŸ”é„‰","é˜¿é‡Œå±±é„‰"],
      "å°å—å¸‚": ["ä¸­è¥¿å€","æ±å€","å—å€","åŒ—å€","å®‰å¹³å€","å®‰å—å€","æ°¸åº·å€","æ­¸ä»å€","æ–°åŒ–å€","å·¦é®å€","ç‰äº•å€","æ¥ è¥¿å€","å—åŒ–å€","ä»å¾·å€","é—œå»Ÿå€","é¾å´å€","å®˜ç”°å€","éº»è±†å€","ä½³é‡Œå€","è¥¿æ¸¯å€","ä¸ƒè‚¡å€","å°‡è»å€","å­¸ç”²å€","åŒ—é–€å€","æ–°ç‡Ÿå€","å¾Œå£å€","ç™½æ²³å€","æ±å±±å€","å…­ç”²å€","ä¸‹ç‡Ÿå€","æŸ³ç‡Ÿå€","é¹½æ°´å€","å–„åŒ–å€","å¤§å…§å€","å±±ä¸Šå€","æ–°å¸‚å€","å®‰å®šå€"],
      "é«˜é›„å¸‚": ["æ¥ æ¢“å€","å·¦ç‡Ÿå€","é¼“å±±å€","ä¸‰æ°‘å€","é¹½åŸ•å€","å‰é‡‘å€","æ–°èˆˆå€","è‹“é›…å€","å‰é®å€","æ——æ´¥å€","å°æ¸¯å€","é³³å±±å€","æ—åœ’å€","å¤§å¯®å€","å¤§æ¨¹å€","å¤§ç¤¾å€","ä»æ­¦å€","é³¥æ¾å€","å²¡å±±å€","æ©‹é ­å€","ç‡•å·¢å€","ç”°å¯®å€","é˜¿è“®å€","è·¯ç«¹å€","æ¹–å…§å€","èŒ„è£å€","æ°¸å®‰å€","å½Œé™€å€","æ¢“å®˜å€","æ——å±±å€","ç¾æ¿ƒå€","å…­é¾œå€","ç”²ä»™å€","æ‰æ—å€","å…§é–€å€","èŒ‚æ—å€","æ¡ƒæºå€","é‚£ç‘ªå¤å€"],
      "å±æ±ç¸£": ["å±æ±å¸‚","æ½®å·é®","æ±æ¸¯é®","æ†æ˜¥é®","è¬ä¸¹é„‰","é•·æ²»é„‰","éºŸæ´›é„‰","ä¹å¦‚é„‰","é‡Œæ¸¯é„‰","é¹½åŸ”é„‰","é«˜æ¨¹é„‰","è¬å·’é„‰","å…§åŸ”é„‰","ç«¹ç”°é„‰","æ–°åŸ¤é„‰","æ‹å¯®é„‰","æ–°åœ’é„‰","å´é ‚é„‰","æ—é‚Šé„‰","å—å·é„‰","ä½³å†¬é„‰","ç‰çƒé„‰","è»ŠåŸé„‰","æ»¿å·é„‰","æ‹å±±é„‰","ä¸‰åœ°é–€é„‰","éœ§å°é„‰","ç‘ªå®¶é„‰","æ³°æ­¦é„‰","ä¾†ç¾©é„‰","æ˜¥æ—¥é„‰","ç…å­é„‰","ç‰¡ä¸¹é„‰"],
      "å®œè˜­ç¸£": ["å®œè˜­å¸‚","ç¾…æ±é®","è˜‡æ¾³é®","é ­åŸé®","ç¤æºªé„‰","å£¯åœé„‰","å“¡å±±é„‰","å†¬å±±é„‰","äº”çµé„‰","ä¸‰æ˜Ÿé„‰","å¤§åŒé„‰","å—æ¾³é„‰"],
      "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚","é³³æ—é®","ç‰é‡Œé®","æ–°åŸé„‰","å‰å®‰é„‰","å£½è±é„‰","å…‰å¾©é„‰","è±æ¿±é„‰","ç‘ç©—é„‰","å¯Œé‡Œé„‰","ç§€æ—é„‰","è¬æ¦®é„‰","å“æºªé„‰"],
      "å°æ±ç¸£": ["å°æ±å¸‚","æˆåŠŸé®","é—œå±±é®","å‘å—é„‰","å¤§æ­¦é„‰","å¤ªéº»é‡Œé„‰","æ±æ²³é„‰","é•·æ¿±é„‰","é¹¿é‡é„‰","æ± ä¸Šé„‰","ç¶ å³¶é„‰","å»¶å¹³é„‰","æµ·ç«¯é„‰","é”ä»é„‰","é‡‘å³°é„‰","è˜­å¶¼é„‰"],
      "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚","æ¹–è¥¿é„‰","ç™½æ²™é„‰","è¥¿å¶¼é„‰","æœ›å®‰é„‰","ä¸ƒç¾é„‰"],
      "é‡‘é–€ç¸£": ["é‡‘åŸé®","é‡‘æ¹–é®","é‡‘æ²™é®","é‡‘å¯§é„‰","çƒˆå¶¼é„‰","çƒåµé„‰"],
      "é€£æ±Ÿç¸£": ["å—ç«¿é„‰","åŒ—ç«¿é„‰","è’å…‰é„‰","æ±å¼•é„‰"]
    };

    const headerUserEl = document.getElementById('headerUser');
    const headerLogoutBtn = document.getElementById('headerLogoutBtn');
    const navSearch = document.getElementById('navSearch');

    // DOM å…ƒç´ 
    const buyerName = document.getElementById('buyerName');
    const buyerEmail = document.getElementById('buyerEmail');
    const buyerPhone = document.getElementById('buyerPhone');
    const buyerAddress = document.getElementById('buyerAddress');
    const buyerRole = document.getElementById('buyerRole');
    const welcome = document.getElementById('welcome');
    
    const btnEdit = document.getElementById('btnEdit');
    const displaySection = document.getElementById('displaySection');
    const editSection = document.getElementById('editSection');
    
    const editName = document.getElementById('editName');
    const editEmail = document.getElementById('editEmail');
    const editPhone = document.getElementById('editPhone');
    const editPassword = document.getElementById('editPassword');
    
    // åœ°å€ç›¸é—œ DOM
    const citySelect = document.getElementById('citySelect');
    const distSelect = document.getElementById('distSelect');
    const streetInput = document.getElementById('streetInput');

    const btnSave = document.getElementById('btnSave');
    const btnCancel = document.getElementById('btnCancel');
    const msgEl = document.getElementById('msg');
    let currentUser = null;

    // åˆå§‹åŒ–ç¸£å¸‚é¸å–®
    function initAddressSelectors() {
      // å¡«å…¥ç¸£å¸‚
      for (let city in TAIWAN_AREAS) {
        const opt = document.createElement('option');
        opt.value = city;
        opt.textContent = city;
        citySelect.appendChild(opt);
      }
      
      // ç•¶ç¸£å¸‚æ”¹è®Šæ™‚ï¼Œæ›´æ–°åœ°å€
      citySelect.addEventListener('change', () => {
        updateDistrictOptions(citySelect.value);
      });
    }

    // æ›´æ–°åœ°å€é¸å–®
    function updateDistrictOptions(city, selectedDist = '') {
      distSelect.innerHTML = '<option value="">åœ°å€</option>'; // æ¸…ç©º
      if (city && TAIWAN_AREAS[city]) {
        TAIWAN_AREAS[city].forEach(dist => {
          const opt = document.createElement('option');
          opt.value = dist;
          opt.textContent = dist;
          if (dist === selectedDist) opt.selected = true;
          distSelect.appendChild(opt);
        });
      }
    }

    // åˆå§‹åŒ–é é¢
    initAddressSelectors();

    if(navSearch){
      navSearch.addEventListener('keypress', (e)=>{
        if(e.key === 'Enter'){
          const val = navSearch.value.trim();
          if(val) window.location.href = 'buyer_shop.html?q=' + encodeURIComponent(val);
        }
      });
    }

    function getAuthHeader(){ const t = localStorage.getItem('token'); return t?{ 'Authorization':'Bearer '+t, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' }; }

    (async function(){
      try{
        const res = await fetch('/api/auth/me', { headers: getAuthHeader() });
        if (!res.ok) { alert('è«‹å…ˆç™»å…¥è²·å®¶å¸³è™Ÿ'); window.location.href='buyer_login.html'; return; }
        currentUser = await res.json();
        if (currentUser.role !== 'buyer') { alert('è«‹ç”¨è²·å®¶å¸³è™Ÿç™»å…¥'); localStorage.removeItem('token'); window.location.href='buyer_login.html'; return; }
        
        if(headerUserEl) headerUserEl.textContent = currentUser.name || currentUser.email;
        buyerName.textContent = currentUser.name || '(æœªå¡«)';
        buyerEmail.textContent = currentUser.email || '-';
        buyerPhone.textContent = currentUser.phone || '(æœªå¡«)';
        buyerAddress.textContent = currentUser.address || '(æœªå¡«)';
        buyerRole.textContent = currentUser.role || '(æœªè¨­å®š)';
        welcome.textContent = 'æ­¡è¿ï¼Œ' + (currentUser.name || currentUser.email || 'è²·å®¶') + 'ï¼';
      }catch(err){ console.error(err); alert('è®€å–è³‡æ–™å¤±æ•—'); window.location.href='buyer_login.html'; }
    })();

    if(headerLogoutBtn) headerLogoutBtn.addEventListener('click', (e)=>{ e.preventDefault(); localStorage.removeItem('token'); alert('å·²ç™»å‡º'); window.location.href='buyer_login.html'; });

    // é»æ“Šç·¨è¼¯
    btnEdit.addEventListener('click', ()=>{
      if (!currentUser) return;
      msgEl.textContent = ''; msgEl.classList.remove('msg-ok');
      
      // å¡«å…¥åŸºæœ¬è³‡æ–™
      editName.value = currentUser.name || ''; 
      editEmail.value = currentUser.email || ''; 
      editPhone.value = currentUser.phone || ''; 
      editPassword.value = '';

      // âœ… [æ–°å¢] å˜—è©¦è§£æä¸¦å¡«å…¥åœ°å€
      const fullAddress = currentUser.address || '';
      let foundCity = '';
      let foundDist = '';
      let remaining = fullAddress;

      // 1. æ‰¾ç¸£å¸‚
      for (let city in TAIWAN_AREAS) {
        if (fullAddress.startsWith(city)) {
          foundCity = city;
          remaining = fullAddress.substring(city.length);
          break;
        }
      }

      // 2. æ‰¾åœ°å€ (å¦‚æœæœ‰æ‰¾åˆ°ç¸£å¸‚)
      if (foundCity) {
        citySelect.value = foundCity;
        updateDistrictOptions(foundCity); // å…ˆæ›´æ–°ä¸‹æ‹‰é¸å–®
        
        for (let dist of TAIWAN_AREAS[foundCity]) {
          if (remaining.startsWith(dist)) {
            foundDist = dist;
            remaining = remaining.substring(dist.length);
            break;
          }
        }
        
        if (foundDist) {
          distSelect.value = foundDist;
          streetInput.value = remaining; // å‰©ä¸‹çš„å°±æ˜¯è¡—é“
        } else {
          streetInput.value = remaining;
        }
      } else {
        // è§£æå¤±æ•—æˆ–æ²’æœ‰ç¸£å¸‚ï¼Œé‡ç½®ä¸¦å¡«å…¥å…¨éƒ¨
        citySelect.value = '';
        updateDistrictOptions('');
        streetInput.value = fullAddress;
      }

      displaySection.style.display = 'none'; 
      editSection.style.display = 'block';
    });

    btnCancel.addEventListener('click', ()=>{ editSection.style.display='none'; displaySection.style.display='block'; });

    // é»æ“Šå„²å­˜
    btnSave.addEventListener('click', async ()=>{
      msgEl.textContent = ''; msgEl.classList.remove('msg-ok');

      // âœ… [æ–°å¢] é›»è©±é©—è­‰ï¼šå¿…é ˆæ˜¯ 10 ç¢¼æ•¸å­—
      const phoneVal = editPhone.value.trim();
      const phoneRegex = /^\d{10}$/;
      if (phoneVal && !phoneRegex.test(phoneVal)) {
        msgEl.textContent = 'é›»è©±æ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆç‚º 10 ç¢¼æ•¸å­— (ä¾‹å¦‚ 0912345678)';
        return;
      }

      // âœ… [æ–°å¢] åœ°å€åˆä½µ
      let finalAddress = '';
      const city = citySelect.value;
      const dist = distSelect.value;
      const street = streetInput.value.trim();
      
      if (city || dist || street) {
        // å¦‚æœæœ‰å¡«å¯«ä»»ä½•ä¸€éƒ¨åˆ†ï¼Œå°±å¿…é ˆé¸ç¸£å¸‚è·Ÿåœ°å€ (æˆ–æ˜¯ä½ å¯ä»¥æ ¹æ“šéœ€æ±‚æ”¾å¯¬)
        if (!city || !dist) {
          msgEl.textContent = 'è«‹å®Œæ•´é¸æ“‡ç¸£å¸‚èˆ‡åœ°å€';
          return;
        }
        if (!street) {
            msgEl.textContent = 'è«‹è¼¸å…¥è©³ç´°è·¯åèˆ‡é–€ç‰Œ';
            return;
        }
        finalAddress = city + dist + street;
      }

      const payload = { 
        name: editName.value.trim(), 
        email: editEmail.value.trim(), 
        phone: phoneVal, 
        address: finalAddress 
      };

      if(payload.email !== currentUser.email) { 
        if(!editPassword.value) { msgEl.textContent='æ›´æ”¹Emailéœ€è¼¸å…¥å¯†ç¢¼'; return; } 
        payload.currentPassword = editPassword.value; 
      }
      
      try{
        const res = await fetch('/api/users/me', { method: 'PUT', headers: getAuthHeader(), body: JSON.stringify(payload) });
        
        // è™•ç†ç‰¹å®šéŒ¯èª¤
        if(!res.ok) {
           const errJson = await res.json().catch(()=>({}));
           throw new Error(errJson.error || 'æ›´æ–°å¤±æ•—');
        }

        const updated = await res.json(); currentUser = updated;
        if(headerUserEl) headerUserEl.textContent = updated.name || updated.email;
        buyerName.textContent = updated.name; 
        buyerEmail.textContent = updated.email; 
        buyerPhone.textContent = updated.phone; 
        buyerAddress.textContent = updated.address;
        
        msgEl.classList.add('msg-ok'); msgEl.textContent='æ›´æ–°æˆåŠŸ';
        setTimeout(()=>{ editSection.style.display='none'; displaySection.style.display='block'; }, 1000);
      }catch(e){ 
        msgEl.textContent = 'æ›´æ–°å¤±æ•—ï¼š' + e.message; 
      }
    });
  </script>
</body>
</html>