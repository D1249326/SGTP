<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SGTP - 買家首頁</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1f354d;
      color: white;
      padding: 20px 40px;
      font-size: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header .right button {
      margin-left: 10px;
    }
    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-light {
      background: #ffffff;
      color: #1f354d;
    }
    .btn-danger {
      background: #c0392b;
      color: white;
    }
    .btn-primary {
      background: #1f354d;
      color: white;
    }
    .btn-secondary {
      background: #bdc3c7;
      color: #2c3e50;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    h2 { margin-top: 0; }
    .info-row {
      margin: 8px 0;
    }
    .label {
      display: inline-block;
      width: 80px;
      color: #555;
    }
    .edit-section {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .edit-row {
      margin: 8px 0;
    }
    .edit-row label {
      display: inline-block;
      width: 80px;
      color: #555;
    }
    .edit-row input {
      width: 260px;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .msg {
      margin-top: 10px;
      font-size: 14px;
      color: #c0392b;
    }
    .msg-ok {
      color: #27ae60;
    }
  </style>
</head>
<body>
  <header>
    <div>SGTP 二手商品平台 - 買家首頁</div>
    <div class="right">
      <!-- ⭐ 這顆改成回到 buyer_shop.html -->
      <button id="btnToShop" class="btn btn-light" onclick="location.href='buyer_shop.html'">
        前往商品列表
      </button>
      <button id="btnLogout" class="btn btn-danger">
        登出
      </button>
    </div>
  </header>

  <div class="container">
    <h2 id="welcome">歡迎，買家！</h2>

    <!-- 顯示用 -->
    <div id="displaySection">
      <div class="info-row">
        <span class="label">姓名：</span>
        <span id="buyerName">-</span>
      </div>
      <div class="info-row">
        <span class="label">Email：</span>
        <span id="buyerEmail">-</span>
      </div>
      <div class="info-row">
        <span class="label">電話：</span>
        <span id="buyerPhone">-</span>
      </div>
      <div class="info-row">
        <span class="label">地址：</span>
        <span id="buyerAddress">-</span>
      </div>
      <div class="info-row">
        <span class="label">角色：</span>
        <span id="buyerRole">-</span>
      </div>

      <button id="btnEdit" class="btn btn-light" style="margin-top:16px;">
        ✏ 編輯資料
      </button>
    </div>

    <!-- 編輯區 -->
    <div id="editSection" class="edit-section" style="display:none;">
      <h3>編輯個人資料</h3>

      <div class="edit-row">
        <label for="editName">姓名：</label>
        <input id="editName" type="text" />
      </div>
      <div class="edit-row">
        <label for="editEmail">Email：</label>
        <input id="editEmail" type="email" />
      </div>
      <div class="edit-row">
        <label for="editPhone">電話：</label>
        <input id="editPhone" type="text" />
      </div>
      <div class="edit-row">
        <label for="editAddress">地址：</label>
        <input id="editAddress" type="text" />
      </div>

      <hr style="margin:14px 0;" />

      <div class="edit-row">
        <label for="editPassword">密碼：</label>
        <input id="editPassword" type="password" placeholder="請輸入目前密碼（驗證用）" />
      </div>

      <div style="margin-top:12px;">
        <button id="btnSave" class="btn btn-primary">儲存變更</button>
        <button id="btnCancel" class="btn btn-secondary" style="margin-left:8px;">取消</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>

    <hr />

    <p>（此頁為買家個人資料中心，可編輯基本資料。未來可加上：訂單查詢、購物車快捷入口等。）</p>
  </div>

  <script>
    const buyerName    = document.getElementById('buyerName');
    const buyerEmail   = document.getElementById('buyerEmail');
    const buyerPhone   = document.getElementById('buyerPhone');
    const buyerAddress = document.getElementById('buyerAddress');
    const buyerRole    = document.getElementById('buyerRole');
    const welcome      = document.getElementById('welcome');

    const btnLogout    = document.getElementById('btnLogout');
    const btnEdit      = document.getElementById('btnEdit');

    const displaySection = document.getElementById('displaySection');
    const editSection    = document.getElementById('editSection');

    const editName      = document.getElementById('editName');
    const editEmail     = document.getElementById('editEmail');
    const editPhone     = document.getElementById('editPhone');
    const editAddress   = document.getElementById('editAddress');
    const editPassword  = document.getElementById('editPassword');
    const btnSave       = document.getElementById('btnSave');
    const btnCancel     = document.getElementById('btnCancel');
    const msgEl         = document.getElementById('msg');

    let currentUser = null;

    function getAuthHeader(){ const t = localStorage.getItem('token'); return t?{ 'Authorization':'Bearer '+t, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' }; }

    (async function(){
      try{
        const res = await fetch('/api/auth/me', { headers: getAuthHeader() });
        if (!res.ok) { alert('請先登入買家帳號'); window.location.href='buyer_login.html'; return; }
        currentUser = await res.json();
        if (!currentUser || currentUser.role !== 'buyer') { alert('此帳號角色不是買家，請用買家帳號登入'); localStorage.removeItem('token'); window.location.href='buyer_login.html'; return; }
        buyerName.textContent    = currentUser.name || '(未填)';
        buyerEmail.textContent   = currentUser.email || '-';
        buyerPhone.textContent   = currentUser.phone || '(未填)';
        buyerAddress.textContent = currentUser.address || '(未填)';
        buyerRole.textContent    = currentUser.role || '(未設定)';
        welcome.textContent = '歡迎，' + (currentUser.name || currentUser.email || '買家') + '！';
      }catch(err){ console.error(err); alert('讀取使用者資料失敗：'+(err.message||err)); window.location.href='buyer_login.html'; }
    })();

    // 打開編輯模式
    btnEdit.addEventListener('click', ()=>{
      if (!currentUser) return;
      msgEl.textContent = ''; msgEl.classList.remove('msg-ok');
      editName.value = currentUser.name || currentUser.email || '';
      editEmail.value = currentUser.email || '';
      editPhone.value = currentUser.phone || '';
      editAddress.value = currentUser.address || '';
      editPassword.value = '';
      displaySection.style.display = 'none'; editSection.style.display = 'block';
    });

    btnCancel.addEventListener('click', ()=>{ editSection.style.display='none'; displaySection.style.display='block'; msgEl.textContent=''; msgEl.classList.remove('msg-ok'); });

    btnSave.addEventListener('click', async ()=>{
      msgEl.textContent = ''; msgEl.classList.remove('msg-ok');
      if (!currentUser) { alert('尚未確認登入狀態，請重新登入。'); return; }
      const newName = editName.value.trim(); const newEmail = editEmail.value.trim(); const newPhone = editPhone.value.trim(); const newAddress = editAddress.value.trim(); const password = editPassword.value;
      if (!newName || !newEmail) { msgEl.textContent = '姓名與 Email 不可空白。'; return; }
      try{
        btnSave.disabled = true; btnSave.textContent = '儲存中...';
        const payload = { name: newName, email: newEmail, phone: newPhone, address: newAddress };
        if (newEmail !== currentUser.email) {
          // require current password
          if (!password) { msgEl.textContent = '更改 Email 需要輸入目前密碼以驗證身分。'; btnSave.disabled=false; btnSave.textContent='儲存變更'; return; }
          payload.currentPassword = password;
        }
        const res = await fetch('/api/users/me', { method: 'PUT', headers: getAuthHeader(), body: JSON.stringify(payload) });
        if (!res.ok) { const err = await res.json().catch(()=>null); throw new Error(err && err.error ? err.error : ('Status ' + res.status)); }
        const updated = await res.json(); currentUser = updated;
        buyerName.textContent = updated.name || '(未填)'; buyerEmail.textContent = updated.email; buyerPhone.textContent = updated.phone || '(未填)'; buyerAddress.textContent = updated.address || '(未填)'; welcome.textContent = '歡迎，' + (updated.name || updated.email) + '！';
        msgEl.classList.add('msg-ok'); msgEl.textContent = '資料已成功更新！';
        setTimeout(()=>{ editSection.style.display='none'; displaySection.style.display='block'; msgEl.textContent=''; msgEl.classList.remove('msg-ok'); }, 1000);
      }catch(err){ console.error(err); msgEl.textContent = '更新失敗：' + (err.message||err); } finally { btnSave.disabled=false; btnSave.textContent='儲存變更'; }
    });

    // 登出
    btnLogout.addEventListener('click', ()=>{ localStorage.removeItem('token'); alert('已登出'); window.location.href='buyer_login.html'; });
  </script>
</body>
</html>
