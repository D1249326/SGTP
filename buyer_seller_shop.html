<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è³£å®¶è³£å ´ - SGTP</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
    
    /* Header */
    header {
      background: #1f354d;
      color: #fff;
      padding: 0 16px;
      height: 60px;
      display: grid;
      grid-template-columns: 60px 1fr 60px;
      align-items: center;
    }
    header h1 { margin:0; font-size: 20px; text-align: center; white-space: nowrap; }
    .btn-header-back {
      background: transparent; border: none; color: white;
      font-size: 32px; cursor: pointer; padding: 0;
      display: flex; justify-content: flex-start; align-items: center; line-height: 1;
    }
    
    /* è³£å®¶è³‡è¨Šå¡ç‰‡ */
    .seller-profile-card {
      background: white;
      max-width: 900px;
      margin: 20px auto;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }
    .seller-info h2 { margin: 0 0 8px 0; font-size: 24px; color: #333; }
    .seller-info p { margin: 0; color: #666; font-size: 14px; }

    .btn-chat {
      background: #e67e22; color: #fff; border: none;
      padding: 10px 20px; border-radius: 4px; font-size: 15px; cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      text-decoration: none;
    }
    .btn-chat:hover { background: #d35400; }

    /* å•†å“åˆ—è¡¨ */
    .container { max-width: 900px; margin: 0 auto 40px auto; padding: 0 16px; }
    .section-title { font-size: 18px; color: #555; margin-bottom: 12px; border-left: 4px solid #1f354d; padding-left: 10px; }

    .product-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
    }

    .product-card {
      background: #fff; border-radius: 6px; overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer; transition: transform 0.2s;
      display: flex; flex-direction: column;
    }
    .product-card:hover { transform: translateY(-3px); }
    
    .p-img-box { width: 100%; aspect-ratio: 1/1; background: #eee; overflow: hidden; }
    .p-img-box img { width: 100%; height: 100%; object-fit: cover; }
    
    .p-info { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .p-title { font-size: 15px; font-weight: bold; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .p-price { color: #c0392b; font-weight: bold; font-size: 16px; margin-top: auto; }
    .p-stock { font-size: 12px; color: #999; margin-top: 4px; }
    .sold-out { filter: grayscale(100%); opacity: 0.7; }

    .empty-msg { text-align: center; color: #777; padding: 40px; width: 100%; grid-column: 1 / -1; }
  
    .seller-rating { color: #f39c12; font-weight: bold; margin-top: 4px; font-size: 15px; }
    .rating-count { color: #7f8c8d; font-size: 13px; font-weight: normal; margin-left: 5px; }
  
  </style>
</head>
<body>

<header>
  <button class="btn-header-back" onclick="history.back()">&#8249;</button>
  <h1>è³£å®¶è³£å ´</h1>
  <div></div>
</header>

<div class="seller-profile-card">
  <div class="seller-info">
    <h2 id="sellerName">è¼‰å…¥ä¸­...</h2>
    <div id="sellerRatingBlock" class="seller-rating"></div>
  </div>
  <button id="btnChatSeller" class="btn-chat" style="display:none;">
    ğŸ’¬ èŠèŠ (ä¸€èˆ¬æ´½è©¢)
  </button>
</div>

<div class="container">
  <div class="section-title">æ‰€æœ‰å•†å“</div>
  <div id="productList" class="product-list">
    </div>
  <div id="loading" style="text-align:center; padding:20px; color:#666;">è¼‰å…¥å•†å“ä¸­...</div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const sellerId = params.get('sellerId');
  
  const sellerNameEl = document.getElementById('sellerName');
  const sellerEmailEl = document.getElementById('sellerEmail');
  const productListEl = document.getElementById('productList');
  const btnChatSeller = document.getElementById('btnChatSeller');
  const loadingEl = document.getElementById('loading');
  const FALLBACK_IMG = 'https://via.placeholder.com/200?text=No+Img';

  function getAuthHeader() { 
    const t = localStorage.getItem('token'); 
    return t ? { 'Authorization': 'Bearer ' + t } : {}; 
  }

  (async function init() {
    if (!sellerId) {
      alert('ç„¡æ•ˆçš„è³£å®¶é€£çµ');
      window.location.href = 'buyer_shop.html';
      return;
    }

    try {
      // 1. å–å¾—è³£å®¶åŸºæœ¬è³‡æ–™
      const uRes = await fetch(`/api/users/${sellerId}`);
      if (uRes.ok) {
        const user = await uRes.json();
        sellerNameEl.textContent = user.name || 'æœªå‘½åè³£å®¶';
        

        const ratingBlock = document.getElementById('sellerRatingBlock');
        if (user.avg_rating) {
            const score = Number(user.avg_rating).toFixed(1);
            
            // é€™è£¡å°‡æ–‡å­—åŒ…åœ¨ <a> æ¨™ç±¤å…§ï¼Œé»æ“Šå¾Œå‰å¾€ buyer_seller_review.html
            ratingBlock.innerHTML = `
              â˜… ${score} 
              <a href="buyer_seller_review.html?sellerId=${sellerId}" 
                style="color:#7f8c8d; text-decoration:underline; cursor:pointer; margin-left:5px; font-size:13px;">
                (${user.review_count} å‰‡è©•åƒ¹)
              </a>
            `;
        } else {
            ratingBlock.innerHTML = `<span style="color:#999; font-size:14px;">å°šç„¡è©•åƒ¹</span>`;
        }
        // è¨­å®šã€Œä¸€èˆ¬æ´½è©¢ã€æŒ‰éˆ•
        btnChatSeller.style.display = 'inline-flex';
        btnChatSeller.onclick = () => {
          // é€™è£¡ productId=0 æˆ–ä¸å‚³ï¼Œä»£è¡¨æ˜¯é‡å°ã€Œäººã€çš„èŠå¤©ï¼Œè€Œéç‰¹å®šå•†å“
          location.href = `chat.html?targetId=${sellerId}&role=buyer`; 
        };
      } else {
        sellerNameEl.textContent = 'æœªçŸ¥è³£å®¶';
      }

      // 2. å–å¾—è©²è³£å®¶çš„æ‰€æœ‰å•†å“
      // server.js è£¡çš„ /api/products å·²ç¶“æ”¯æ´ ?seller_id=... åƒæ•¸
      const pRes = await fetch(`/api/products?seller_id=${sellerId}`);
      loadingEl.style.display = 'none';
      
      if (pRes.ok) {
        const products = await pRes.json();
        renderProducts(products);
      } else {
        productListEl.innerHTML = '<div class="empty-msg">ç„¡æ³•è®€å–å•†å“åˆ—è¡¨</div>';
      }

    } catch (e) {
      console.error(e);
      loadingEl.textContent = 'è¼‰å…¥å¤±æ•—';
    }
  })();

  function renderProducts(list) {
    productListEl.innerHTML = '';
    if (!list || list.length === 0) {
      productListEl.innerHTML = '<div class="empty-msg">é€™ä½è³£å®¶é‚„æ²’æœ‰ä¸Šæ¶ä»»ä½•å•†å“å–”ï¼</div>';
      return;
    }

    list.forEach(p => {
      // è§£æåœ–ç‰‡
      let imgUrl = FALLBACK_IMG;
      if (p.image) imgUrl = p.image;
      else if (p.images) {
        try {
           const imgs = (typeof p.images === 'string') ? JSON.parse(p.images) : p.images;
           if (imgs.length > 0) imgUrl = imgs[0];
        } catch(e) {}
      }

      // æª¢æŸ¥åº«å­˜
      const stock = (p.stock !== undefined) ? p.stock : (p.quantity || 0);
      const isSoldOut = stock <= 0;

      const card = document.createElement('div');
      card.className = `product-card ${isSoldOut ? 'sold-out' : ''}`;
      card.onclick = () => location.href = `buyer_product.html?id=${p.id}`;

      card.innerHTML = `
        <div class="p-img-box">
          <img src="${imgUrl}" loading="lazy">
        </div>
        <div class="p-info">
          <div class="p-title">${p.title}</div>
          <div class="p-price">NT$ ${p.price}</div>
          <div class="p-stock">${isSoldOut ? '(å·²å”®å®Œ)' : `åº«å­˜ ${stock}`}</div>
        </div>
      `;
      productListEl.appendChild(card);
    });
  }
</script>

</body>
</html>