<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>設定新密碼 - SGTP</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; display: flex; justify-content: center; padding-top: 60px; margin: 0; }
    .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
    h2 { text-align: center; margin-top: 0; color: #1f354d; }
    input { width: 100%; padding: 10px; margin-top: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    button { width: 100%; padding: 10px; margin-top: 20px; background: #1f354d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
    button:hover { background: #2c3e50; }
    .msg { margin-top: 15px; text-align: center; font-size: 14px; }
    .error { color: #c0392b; }
    .success { color: #27ae60; }
  </style>
</head>
<body>

<div class="container">
  <h2>設定新密碼</h2>
  <form id="resetForm">
    <input type="password" id="newPass" placeholder="輸入新密碼 (至少6碼)" required>
    <input type="password" id="checkPass" placeholder="再次確認密碼" required>
    <button type="submit">確認重設</button>
  </form>
  <div id="msg" class="msg"></div>
  <div style="text-align:center; margin-top:20px;">
    <a href="index.html" style="color:#666; text-decoration:none; font-size:14px;">回首頁</a>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token');
  const msg = document.getElementById('msg');

  if (!token) {
    document.getElementById('resetForm').style.display = 'none';
    msg.textContent = '無效的連結 (缺少 Token)';
    msg.className = 'msg error';
  }

  document.getElementById('resetForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const p1 = document.getElementById('newPass').value;
    const p2 = document.getElementById('checkPass').value;

    if (p1 !== p2) {
      msg.textContent = '兩次密碼輸入不一致';
      msg.className = 'msg error';
      return;
    }

    try {
      const res = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, newPassword: p1 })
      });
      const data = await res.json();
      
      if (res.ok) {
        msg.textContent = '密碼重設成功！3秒後跳轉至登入頁...';
        msg.className = 'msg success';
        document.getElementById('resetForm').style.display = 'none';
        setTimeout(() => { window.location.href = 'index.html'; }, 3000);
      } else {
        msg.textContent = data.error || '重設失敗';
        msg.className = 'msg error';
      }
    } catch (err) {
      msg.textContent = '連線錯誤';
      msg.className = 'msg error';
    }
  });
</script>

</body>
</html>